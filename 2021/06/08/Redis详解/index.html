<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis详解 | 木瓜煲鸡脚's blog</title><meta name="author" content="木瓜煲鸡脚,1839646816@qq.com"><meta name="copyright" content="木瓜煲鸡脚"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、概述1.1 互联网架构的演变历程 第1阶段  数据访问量不大，简单的架构即可搞定！     第2阶段  数据访问量大，使用缓存技术来缓解数据库的压力。 不同的业务访问不同的数据库    第3阶段  主从读写分离。 之前的缓存确实能够缓解数据库的压力，但是写和读都集中在一个数据库上，压力又来了。"><link rel="shortcut icon" href="/assets/img/favicon64.ico"><link rel="canonical" href="http://yournotes.cn/2021/06/08/Redis%E8%AF%A6%E8%A7%A3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?43ef74dd386a5adcc7d5e42daaa55700";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 木瓜煲鸡脚","link":"链接: ","source":"来源: 木瓜煲鸡脚's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-17 16:34:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/img/hao.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-folder-open"></i><span> 说说</span></a></li><li><a class="site-page child" href="/tools/"><i class="fa-fw fa fa-wrench"></i><span> 工具</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/assets/img/article/article.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">木瓜煲鸡脚's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-folder-open"></i><span> 说说</span></a></li><li><a class="site-page child" href="/tools/"><i class="fa-fw fa fa-wrench"></i><span> 工具</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-06-08T09:41:17.000Z" title="发表于 2021-06-08 17:41:17">2021-06-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%B0%E5%BD%95%E6%96%87%E6%A1%A3/">记录文档</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/06/08/Redis%E8%AF%A6%E8%A7%A3/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><h3 id="1-1-互联网架构的演变历程"><a href="#1-1-互联网架构的演变历程" class="headerlink" title="1.1 互联网架构的演变历程"></a>1.1 互联网架构的演变历程</h3><ul>
<li><p>第1阶段</p>
<ul>
<li><p>数据访问量不大，简单的架构即可搞定！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210518191430690.png" alt="image-20210518191430690"></p>
</li>
</ul>
</li>
<li><p>第2阶段</p>
<ul>
<li>数据访问量大，使用缓存技术来缓解数据库的压力。</li>
<li>不同的业务访问不同的数据库</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210518191527810.png" alt="image-20210518191527810"></p>
</li>
<li><p>第3阶段</p>
<ul>
<li>主从读写分离。</li>
<li>之前的缓存确实能够缓解数据库的压力，但是写和读都集中在一个数据库上，压力又来了。</li>
<li>一个数据库负责写，一个数据库负责读。分工合作。愉快！</li>
<li>让master（主数据库）来响应事务性**（增删改）<strong>操作，让slave（从数据库）来响应非事务性</strong>（查询）**操作，然后再采用主从复制来把master上的事务性操作同步到slave数据库中</li>
<li>mysql的master&#x2F;slave就是网站的标配！</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210518191620259.png" alt="image-20210518191620259"></p>
</li>
<li><p>第4阶段</p>
<ul>
<li>mysql的主从复制，读写分离的基础上，mysql的主库开始出现瓶颈</li>
<li>由于MyISAM使用表锁，所以并发性能特别差</li>
<li>分库分表开始流行，mysql也提出了表分区，虽然不稳定，但我们看到了希望</li>
<li>开始吧，mysql集群</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210518191711373.png" alt="image-20210518191711373"></p>
<h3 id="1-2-Redis入门介绍"><a href="#1-2-Redis入门介绍" class="headerlink" title="1.2 Redis入门介绍"></a>1.2 Redis入门介绍</h3><ul>
<li>互联网需求的3高<ul>
<li>高并发，高可扩，高性能</li>
</ul>
</li>
<li>Redis 是一种运行速度很快，并发性能很强，并且运行在内存上的NoSql（not only sql）数据库</li>
<li>NoSQL数据库 和 传统数据库 相比的优势<ul>
<li>NoSQL数据库无需事先为要存储的数据建立字段，随时可以存储自定义的数据格式。</li>
<li>而在关系数据库里，增删字段是一件非常麻烦的事情。如果是非常大数据量的表，增加字段简直就是一个噩梦</li>
</ul>
</li>
<li><strong>Redis的常用使用场景</strong><ul>
<li><strong>缓存</strong>，毫无疑问这是Redis当今最为人熟知的使用场景。在提升服务器性能方面非常有效；一些频繁被访问的数据，经常被访问的数据如果放在关系型数据库，每次查询的开销都会很大，而放在redis中，因为redis 是放在内存中的可以很高效的访问</li>
<li><strong>排行榜</strong>，在使用传统的关系型数据库（mysql oracle 等）来做这个事儿，非常的麻烦，而利用Redis的SortSet(有序集合)数据结构能够简单的搞定；</li>
<li><strong>计算器&#x2F;限速器</strong>，利用Redis中原子性的自增操作，我们可以统计类似用户点赞数、用户访问数等，这类操作如果用MySQL，频繁的读写会带来相当大的压力；限速器比较典型的使用场景是限制某个用户访问某个API的频率，常用的有抢购时，防止用户疯狂点击带来不必要的压力；</li>
<li><strong>好友关系</strong>，利用集合的一些命令，比如求交集、并集、差集等。可以方便搞定一些共同好友、共同爱好之类的功能；</li>
<li><strong>简单消息队列</strong>，除了Redis自身的发布&#x2F;订阅模式，我们也可以利用List来实现一个队列机制，比如：到货通知、邮件发送之类的需求，不需要高可靠，但是会带来非常大的DB压力，完全可以用List来完成异步解耦；</li>
<li><strong>Session****共享</strong>，以jsp为例，默认Session是保存在服务器的文件中，如果是集群服务，同一个用户过来可能落在不同机器上，这就会导致用户频繁登陆；采用Redis保存Session后，无论用户落在那台机器上都能够获取到对应的Session信息。</li>
</ul>
</li>
</ul>
<h3 id="1-3-Redis-Memcache-MongoDB对比"><a href="#1-3-Redis-Memcache-MongoDB对比" class="headerlink" title="1.3 Redis&#x2F;Memcache&#x2F;MongoDB对比"></a>1.3 Redis&#x2F;Memcache&#x2F;MongoDB对比</h3><p>都是nosql数据库的著名代表</p>
<h4 id="1-3-1-Redis和Memcache"><a href="#1-3-1-Redis和Memcache" class="headerlink" title="1.3.1 Redis和Memcache"></a>1.3.1 Redis和Memcache</h4><ul>
<li>Redis和Memcache都是内存数据库。不过memcache还可用于缓存其他东西，例如图片、视频等等。</li>
<li>memcache 数据结构单一kv，redis 更丰富一些，还提供 list，set， hash 等数据结构的存储，有效的减少网络 IO 的次数</li>
<li>虚拟内存–Redis当物理内存用完时，可以将一些很久没用到的value交换到磁盘</li>
<li><strong>存储数据安全</strong>–memcache挂掉后，数据没了（没有持久化机制）；redis可以定期保存到磁盘（持久化）</li>
<li>灾难恢复–memcache挂掉后，数据不可恢复; redis数据丢失后可以通过RBD或AOF恢复</li>
</ul>
<h4 id="1-3-2-Redis和MongoDB"><a href="#1-3-2-Redis和MongoDB" class="headerlink" title="1.3.2 Redis和MongoDB"></a>1.3.2 Redis和MongoDB</h4><ul>
<li>redis和mongodb并不是竞争关系，更多的是一种<strong>协作共存</strong>的关系。</li>
<li>mongodb本质上还是硬盘数据库，在复杂查询时仍然会有大量的资源消耗，而且在处理复杂逻辑时仍然要不可避免地进行多次查询。</li>
<li>这时就需要redis或Memcache这样的内存数据库来作为中间层进行缓存和加速。</li>
<li>比如在某些复杂页面的场景中，整个页面的内容如果都从mongodb中查询，可能要几十个查询语句，耗时很长。如果需求允许，则可以把整个页面的对象缓存至redis中，定期更新。这样mongodb和redis就能很好地协作起来</li>
</ul>
<h3 id="1-4-分布式数据库CAP原理"><a href="#1-4-分布式数据库CAP原理" class="headerlink" title="1.4 分布式数据库CAP原理"></a>1.4 分布式数据库CAP原理</h3><h4 id="1-4-1-CAP简介"><a href="#1-4-1-CAP简介" class="headerlink" title="1.4.1 CAP简介"></a>1.4.1 CAP简介</h4><ul>
<li>传统的关系型数据库事务具备ACID： <ul>
<li>A：原子性</li>
<li>C：一致性</li>
<li>I：独立性</li>
<li>D：持久性</li>
</ul>
</li>
<li>分布式数据库的CAP:<ul>
<li><p>C（Consistency）：强一致性</p>
<ul>
<li>“all nodes see the same data at the same time”,即更新操作成功并返回客户端后，<strong>所有节点在同一时间的数据完全一致</strong>，这就是分布式的一致性。一致性的问题在并发系统中不可避免，对于客户端来说，一致性指的是并发访问时更新过的数据如何获取的问题。从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。</li>
</ul>
</li>
<li><p>A（Availability）：高可用性</p>
<ul>
<li>可用性指“Reads and writes always succeed”，即<strong>服务一直可用</strong>，而且要是正常的响应时间。好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。</li>
</ul>
</li>
<li><p>P（Partition tolerance）：分区容错性</p>
<ul>
<li>即分布式系统在遇到<strong>某节点或网络分区故障时，仍然能够对外提供满足一致性或可用性的服务</strong>。</li>
<li>分区容错性要求能够使应用虽然是一个分布式系统，而看上去却好像是在一个可以运转正常的整体。比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统需求，对于用户而言并没有什么体验上的影响。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="1-4-2-CAP理论"><a href="#1-4-2-CAP理论" class="headerlink" title="1.4.2 CAP理论"></a>1.4.2 CAP理论</h4><ul>
<li>CAP理论提出就是针对分布式数据库环境的，所以，P这个属性必须容忍它的存在，而且是必须具备的。</li>
<li>因为P是必须的，那么我们需要选择的就是A和C。</li>
<li>大家知道，在分布式环境下，为了保证系统可用性，通常都采取了复制的方式，避免一个节点损坏，导致系统不可用。那么就出现了每个节点上的数据出现了很多个副本的情况，而数据从一个节点复制到另外的节点时需要时间和要求网络畅通的，所以，当P发生时，也就是无法向某个节点复制数据时，这时候你有两个选择：<ul>
<li>选择可用性 A，此时，那个失去联系的节点依然可以向系统提供服务，不过它的数据就不能保证是同步的了（失去了C属性）。</li>
<li>选择一致性C，为了保证数据库的一致性，我们必须等待失去联系的节点恢复过来，在这个过程中，那个节点是不允许对外提供服务的，这时候系统处于不可用状态(失去了A属性)。</li>
</ul>
</li>
<li>最常见的例子是读写分离，某个节点负责写入数据，然后将数据同步到其它节点，其它节点提供读取的服务，当两个节点出现通信问题时，你就面临着选择A（继续提供服务，但是数据不保证准确），C（用户处于等待状态，一直等到数据同步完成）。</li>
</ul>
<h4 id="1-4-3-CAP总结"><a href="#1-4-3-CAP总结" class="headerlink" title="1.4.3 CAP总结"></a>1.4.3 CAP总结</h4><ul>
<li>分区是常态，不可避免，三者不可共存</li>
<li><strong>可用性和一致性是一对冤家</strong><ul>
<li>一致性高，可用性低</li>
<li>一致性低，可用性高</li>
</ul>
</li>
<li>因此，根据 CAP 原理将 NoSQL 数据库分成了满足 CA 原则、满足 CP 原则和满足 AP 原则三 大类：<ul>
<li>CA - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。</li>
<li>CP - 满足一致性，分区容忍性的系统，通常性能不是特别高。</li>
<li>AP - 满足可用性，分区容忍性的系统，通常可能对一致性要求低一些。</li>
</ul>
</li>
</ul>
<h2 id="二、下载与安装"><a href="#二、下载与安装" class="headerlink" title="二、下载与安装"></a>二、下载与安装</h2><h3 id="2-1-下载"><a href="#2-1-下载" class="headerlink" title="2.1 下载"></a>2.1 下载</h3><p>redis：<a target="_blank" rel="noopener" href="http://www.redis.net.cn/">http://www.redis.net.cn/</a></p>
<p>图形工具：<a target="_blank" rel="noopener" href="https://redisdesktop.com/download">https://redisdesktop.com/download</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210518192921250.png" alt="image-20210518192921250"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210518192937311.png" alt="image-20210518192937311"></p>
<h3 id="2-2-安装"><a href="#2-2-安装" class="headerlink" title="2.2 安装"></a>2.2 安装</h3><p>虽然可以在安装在windows操作系统，但是官方不推荐，一如既往的安装在linux上环境是虚拟机 </p>
<ol>
<li><p>上传tar.gz包，并解压</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> -zxvf redis-<span class="number">5</span>.<span class="number">0</span>.<span class="number">4</span>.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装gcc（必须有网络）</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> gcc</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入redis目录，进行编译</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">make</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编译之后，开始安装</p>
</li>
</ol>
   <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make <span class="keyword">install</span></span><br></pre></td></tr></table></figure>



<h3 id="2-3-安装后的操作"><a href="#2-3-安装后的操作" class="headerlink" title="2.3 安装后的操作"></a>2.3 安装后的操作</h3><h4 id="2-3-1-后台运行方式"><a href="#2-3-1-后台运行方式" class="headerlink" title="2.3.1 后台运行方式"></a>2.3.1 后台运行方式</h4><ul>
<li>redis默认不会使用后台运行，如果你需要，修改配置文件daemonize&#x3D;yes，当你后台服务启动的时候，会写成一个进程文件运行。</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim</span> /opt/redis-<span class="number">5</span>.<span class="number">0</span>.<span class="number">4</span>/redis.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemonize</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<ul>
<li>以配置文件的方式启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/bin redis-server /opt/redis-5.0.4/redis.conf</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-关闭数据库"><a href="#2-3-2-关闭数据库" class="headerlink" title="2.3.2 关闭数据库"></a>2.3.2 关闭数据库</h4><ul>
<li>单实例关闭</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure>

<ul>
<li>多实例关闭</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">redis</span>-cli -p <span class="number">6379</span> shutdown</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-常用操作"><a href="#2-3-3-常用操作" class="headerlink" title="2.3.3 常用操作"></a>2.3.3 常用操作</h4><ul>
<li>检测6379端口是否在监听</li>
</ul>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat <span class="punctuation">-</span>lntp <span class="string">| grep 6379</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>端口为什么是6379？</p>
<p>​	6379在是手机按键上MERZ对应的号码，</p>
<p>​	而MERZ取自意大利歌女Alessia Merz的名字。</p>
<p>​	MERZ长期以来被antirez（redis作者）及其朋友当作愚蠢的代名词。</p>
</blockquote>
<ul>
<li>检测后台进程是否存在</li>
</ul>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef|<span class="keyword">grep</span> redis</span><br></pre></td></tr></table></figure>

<h4 id="2-3-4-连接redis并测试"><a href="#2-3-4-连接redis并测试" class="headerlink" title="2.3.4 连接redis并测试"></a>2.3.4 连接redis并测试</h4><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-<span class="keyword">cli</span> </span><br><span class="line"><span class="built_in">ping</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-5-HelloWorld"><a href="#2-3-5-HelloWorld" class="headerlink" title="2.3.5 HelloWorld"></a>2.3.5 HelloWorld</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存数据 </span></span><br><span class="line"><span class="built_in">set</span> k1 china </span><br><span class="line"><span class="comment"># 获取数据 </span></span><br><span class="line"><span class="built_in">get</span> kl</span><br></pre></td></tr></table></figure>

<h4 id="2-3-6-测试性能"><a href="#2-3-6-测试性能" class="headerlink" title="2.3.6 测试性能"></a>2.3.6 测试性能</h4><ul>
<li>先 ctrl+c，退出redis客户端</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">redis-benchmark</span></span><br></pre></td></tr></table></figure>

<ul>
<li>执行命令后，命令不会自动停止，需要我们手动ctrl+c停止测试\</li>
</ul>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># redis-benchmark</span></span><br><span class="line">====== PING_INLINE ======</span><br><span class="line">100000 requests completed in 1.80 seconds <span class="comment"># 1.8秒处理了10万个请求，性能要看笔记 本的配置高低</span></span><br><span class="line">50 parallel clients</span><br><span class="line">3 bytes payload</span><br><span class="line">keep alive: 1</span><br><span class="line"></span><br><span class="line">87.69% &lt;=<span class="number"> 1 </span>milliseconds</span><br><span class="line">99.15% &lt;=<span class="number"> 2 </span>milliseconds </span><br><span class="line">99.65% &lt;=<span class="number"> 3 </span>milliseconds </span><br><span class="line">99.86% &lt;=<span class="number"> 4 </span>milliseconds </span><br><span class="line">99.92% &lt;=<span class="number"> 5 </span>milliseconds </span><br><span class="line">99.94% &lt;=<span class="number"> 6 </span>milliseconds </span><br><span class="line">99.97% &lt;=<span class="number"> 7 </span>milliseconds </span><br><span class="line">100.00% &lt;=<span class="number"> 7 </span>milliseconds 55524.71 requests per second <span class="comment"># 每秒处理的请求数量</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-7-默认16个数据库"><a href="#2-3-7-默认16个数据库" class="headerlink" title="2.3.7 默认16个数据库"></a>2.3.7 默认16个数据库</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim</span> /opt/redis-<span class="number">5</span>.<span class="number">0</span>.<span class="number">4</span>/redis.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1 # 查询k1</span><br><span class="line"><span class="string">&quot;china&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; select <span class="number">16</span> # 切换<span class="number">16</span>号数据库</span><br><span class="line">(error) ERR DB index is out of range # 数据库的下标超出了范围</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; select <span class="number">15</span> # 切换<span class="number">15</span>号数据库</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[15]</span>&gt; get k1 # 查询k1</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[15]</span>&gt; select <span class="number">0</span> # 切换<span class="number">0</span>号数据库</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1 # 查询k1</span><br><span class="line"><span class="string">&quot;china&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-8-数据库键的数量"><a href="#2-3-8-数据库键的数量" class="headerlink" title="2.3.8 数据库键的数量"></a>2.3.8 数据库键的数量</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dbsize</span></span><br></pre></td></tr></table></figure>

<p> redis在linux支持命令补全（tab）</p>
<h4 id="2-3-9-清空数据库"><a href="#2-3-9-清空数据库" class="headerlink" title="2.3.9 清空数据库"></a>2.3.9 清空数据库</h4><ul>
<li>清空当前库</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flushdb</span></span><br></pre></td></tr></table></figure>

<ul>
<li>清空所有（16个）库，慎用！！</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flushall</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-10-模糊查询（key）"><a href="#2-3-10-模糊查询（key）" class="headerlink" title="2.3.10 模糊查询（key）"></a>2.3.10 模糊查询（key）</h4><p>模糊查询keys命令，有三个通配符：</p>
<ul>
<li><p>通配任意多个字符</p>
<ul>
<li><p>查询所有的键</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">keys</span> *</span><br></pre></td></tr></table></figure>
</li>
<li><p>模糊查询k开头，后面随便多少个字符</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">keys</span> k*</span><br></pre></td></tr></table></figure>
</li>
<li><p>模糊查询e为最后一位，前面随便多少个字符</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">keys</span> *e</span><br></pre></td></tr></table></figure>
</li>
<li><p>双 * 模式，匹配任意多个字符：查询包含k的键</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys <span class="strong">*k*</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>?：通配单个字符</p>
<ul>
<li><p>模糊查询k字头，并且匹配一个字符</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">keys</span> k?</span><br></pre></td></tr></table></figure>
</li>
<li><p>你只记得第一个字母是k，他的长度是3</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">keys</span> k??</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>[]：通配括号内的某一个字符</p>
<ul>
<li><p>记得其他字母，就第二个字母可能是a或e</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys <span class="attribute">r</span><span class="selector-attr">[ae]</span>dis</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="2-3-11-键（key）"><a href="#2-3-11-键（key）" class="headerlink" title="2.3.11 键（key）"></a>2.3.11 键（key）</h4><ul>
<li><p>exists key：判断某个key是否存在</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exists k1</span><br><span class="line">(integer) <span class="number">1</span> # 存在</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exists y1</span><br><span class="line">(integer) <span class="number">0</span> # 不存在</span><br></pre></td></tr></table></figure>
</li>
<li><p>move key db：移动（剪切，粘贴）键到几号库</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; move x1 <span class="number">8</span> # 将x1移动到<span class="number">8</span>号库</span><br><span class="line">(integer) <span class="number">1</span> # 移动成功</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exists x1 # 查看当前库中是否存在x1</span><br><span class="line">(integer) <span class="number">0</span> # 不存在（因为已经移走了）</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; select <span class="number">8</span> # 切换<span class="number">8</span>号库</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; keys * # 查看当前库中的所有键</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;x1&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ttl key：查看键还有多久过期（-1永不过期，-2已过期）</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; ttl x1</span><br><span class="line">(integer) -<span class="number">1</span> # 永不过期</span><br></pre></td></tr></table></figure>
</li>
<li><p>time to live 还能活多久</p>
</li>
<li><p>expire key 秒：为键设置过期时间（生命倒计时）</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; set k1 v1 # 保存k1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; ttl k1 # 查看k1的过期时间</span><br><span class="line">(integer) -<span class="number">1</span> # 永不过期</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; expire k1 <span class="number">10</span> # 设置k1的过期时间为<span class="number">10</span>秒（<span class="number">10</span>秒后自动销毁）</span><br><span class="line">(integer) <span class="number">1</span> # 设置成功</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; get k1 # 获取k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; ttl k1 # 查看k1的过期时间&#x27;</span><br><span class="line">(integer) <span class="number">2</span> # 还有<span class="number">2</span>秒过期</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; get k1</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; keys * # 从内存中销毁了</span><br><span class="line">(empty list or set)</span><br></pre></td></tr></table></figure>
</li>
<li><p>type key：查看键的数据类型</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span><span class="string">[8]</span>&gt; type k1 </span><br><span class="line">string # k1的数据类型是会string字符串</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="三、使用Redis"><a href="#三、使用Redis" class="headerlink" title="三、使用Redis"></a>三、使用Redis</h2><h3 id="3-1-五大数据类型"><a href="#3-1-五大数据类型" class="headerlink" title="3.1 五大数据类型"></a>3.1 五大数据类型</h3><ul>
<li>操作文档：<a target="_blank" rel="noopener" href="http://redisdoc.com/">http://redisdoc.com/</a></li>
</ul>
<h4 id="3-1-1-字符串String"><a href="#3-1-1-字符串String" class="headerlink" title="3.1.1 字符串String"></a>3.1.1 字符串String</h4><ul>
<li><p>set&#x2F;get&#x2F;del&#x2F;append&#x2F;strlen</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k1 v1   # 保存数据</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k2 v2   # 保存数据</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k2&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;k1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; del k2      # 删除数据k2</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1      # 获取数据k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; append k1 adc # 往k1的值追加数据abc</span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;v1adc&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; strlen k1   # 返回k1值的长度（字符数量）</span><br><span class="line">(integer) <span class="number">5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>incr&#x2F;decr&#x2F;incrby&#x2F;decrby：加减操作，操作的必须是数字类型</p>
<ul>
<li>incr：意思是increment，增加</li>
<li>decr：意思是decrement，减少</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k1 <span class="number">1</span>   # 初始化k1的值为<span class="number">1</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; incr k1    # k1自增<span class="number">1</span>（相当于++）</span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; incr k1</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; decr k1    # k1自减<span class="number">1</span>（相当于--）</span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; decr k1</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; incrby k1 <span class="number">3</span> # k1自增<span class="number">3</span>（相当于+=<span class="number">3</span>）</span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;4&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; decrby k1 <span class="number">2</span> # k1自减<span class="number">2</span>（相当于-=<span class="number">2</span>）</span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>getrange&#x2F;setrange：类似between…and…</p>
<ul>
<li>range：范围</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k1 abcdef    # 初始化k1的值为abcdef</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;abcdef&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; getrange k1 <span class="number">0</span> -<span class="number">1</span> # 查询k1全部的值</span><br><span class="line"><span class="string">&quot;abcdef&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; getrange k1 <span class="number">0</span> <span class="number">3</span>  # 查询k1的值，范围是下标<span class="number">0</span>~下标<span class="number">3</span>（包含<span class="number">0</span>和<span class="number">3</span>，共 返回<span class="number">4</span>个字符）</span><br><span class="line"><span class="string">&quot;abcd&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; setrange k1 <span class="number">1</span> xxx # 替换k1的值，从下标<span class="number">1</span>开始提供为xxx</span><br><span class="line">(integer) <span class="number">6</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;axxxef&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>setex&#x2F;setnx</p>
<ul>
<li><strong>set with expir</strong>：添加数据的同时设置生命周期</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; setex k1 <span class="number">5</span> v1  # 添加k1 v1数据的同时，设置<span class="number">5</span>秒的声明周期</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1    # 已过期，k1的值v1自动销毁</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>set if not exist</strong>：添加数据的时候判断是否已经存在，防止已存在的数据被覆盖掉</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; setnx k1 xu    </span><br><span class="line">(integer) <span class="number">0</span>                    # 添加失败，因为k1已经存在</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1</span><br><span class="line"><span class="string">&quot;sun&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; setnx k2 xu</span><br><span class="line">(integer) <span class="number">1</span>                    # k2不存在，所以添加成功</span><br></pre></td></tr></table></figure>
</li>
<li><p>mset&#x2F;mget&#x2F;msetnx</p>
<ul>
<li>m：<strong>more</strong>更多</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k1 v1 k2 v2        # set不支持一次添加多条数据</span><br><span class="line">(error) ERR syntax error</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; mset k1 v1 k2 v2 k3 v3 # mset可以一次添加多条数据</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k3&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;k2&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;k1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; mget k2 k3     # 一次获取多条数据</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;v2&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;v3&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; msetnx k3 v3 k4 v4  # 一次添加多条数据时，如果添加的数据中有已经存在的，则失败</span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; msetnx k4 v4 k5 v5  # 一次添加多条数据时，如果添加的数据 中都不存在的，则成功</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>getset：先get后set</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; getset k6 v6</span><br><span class="line">(nil)                         # 因为没有k6，所以get为null，然后将k6v6的值添加到数据库</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k2&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;k5&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;k4&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;k6&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;k3&quot;</span></span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;k1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k6</span><br><span class="line"><span class="string">&quot;v6&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; getset k6 vv6  # 先获取k6的值，然后修改k6的值为vv6</span><br><span class="line"><span class="string">&quot;v6&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k6</span><br><span class="line"><span class="string">&quot;vv6&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-1-2-列表List"><a href="#3-1-2-列表List" class="headerlink" title="3.1.2 列表List"></a>3.1.2 列表List</h4><p>push和pop，类似机枪AK47：push，压子弹，pop，射击出子弹</p>
<ul>
<li><p>lpush&#x2F;rpush&#x2F;lrange</p>
<ul>
<li>l：left 自左向右→添加 （从上往下添加）</li>
<li>r：right 自右向左←添加（从下往上添加）</li>
</ul>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush list01 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>   # 从上往下添加</span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;list01&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span>    # 查询list01中的全部数据<span class="number">0</span>表示开 始，<span class="number">-1</span>表示结尾</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;4&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush list02 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>  # 从下往上添加</span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;5&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>lpop&#x2F;rpop：移除第一个元素（上左下右）</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; lpop list02 # 从左（上）边移除第一个元素</span><br><span class="line"><span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; rpop list02 # 从右（下）边移除第一个元素</span><br><span class="line"><span class="string">&quot;5&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>lindex：根据下标查询元素（从左向右，自上而下）</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lindex</span> list01 <span class="number">2</span> # 从上到下数，下标为<span class="number">2</span>的值</span><br><span class="line"><span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lindex</span> list01 <span class="number">1</span> # 从上到下数，下标为<span class="number">1</span>的值</span><br><span class="line"><span class="string">&quot;4&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>llen：返回集合长度</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; llen list01</span><br><span class="line">(integer) <span class="number">5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>lrem：删除n个value</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush list01 <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> </span><br><span class="line">(integer) <span class="number">10</span> </span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lrem list01 <span class="number">2</span> <span class="number">3</span> # 从list01中移除<span class="number">2</span>个<span class="number">3</span> </span><br><span class="line">(integer) <span class="number">2</span> </span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span> </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ltrim：截取指定范围的值，别的全扔掉</p>
<ul>
<li>ltrim key begindex endindex</li>
</ul>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush list01 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span></span><br><span class="line">(integer) <span class="number">9</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;9&quot;</span> # 下标<span class="number">0</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;8&quot;</span> # 下标<span class="number">1</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;7&quot;</span> # 下标<span class="number">2</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;6&quot;</span> # 下标<span class="number">3</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;5&quot;</span> # 下标<span class="number">4</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;4&quot;</span> # 下标<span class="number">5</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;3&quot;</span> # 下标<span class="number">6</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;2&quot;</span> # 下标<span class="number">7</span> </span><br><span class="line"><span class="number">9</span>) <span class="string">&quot;1&quot;</span> # 下标<span class="number">8</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ltrim list01 <span class="number">3</span> <span class="number">6</span> # 截取下标<span class="number">3</span>~<span class="number">6</span>的值，别的全扔掉</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;6&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>rpoplpush：从一个集合搞一个元素到另一个集合中（右出一个，左进一个）</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush list01 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush list02 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpoplpush list01 list02 # list01右边出一个，从左进入到list02的第一个位置</span><br><span class="line"><span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list01 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;5&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>lset：改变某个下标的某个值</p>
<ul>
<li>lset key index value</li>
</ul>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lset</span> list02 <span class="number">0</span> x # 将list02中下标为<span class="number">0</span>的元素修改成x</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;x&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;5&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>linsert：插入元素（指定某个元素之前&#x2F;之后）</p>
</li>
<li><p>linsert key before&#x2F;after oldvalue new value</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span> </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;x&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">linsert</span> list02 before <span class="number">2</span> java # 从左边进入，在list02中的<span class="number">2</span>素之前插入java</span><br><span class="line">(integer) <span class="number">7</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;x&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;java&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">linsert</span> list02 <span class="keyword">after</span> <span class="number">2</span> redis # 从左边进入，在list02中的元素之后插入redis</span><br><span class="line">(integer) <span class="number">8</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list02 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;x&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;java&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;redis&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;5&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>性能总结：类似添加火车皮一样，头尾操作效率高，中间操作效率惨；</p>
</li>
</ul>
<h4 id="3-1-3-集合Set"><a href="#3-1-3-集合Set" class="headerlink" title="3.1.3 集合Set"></a>3.1.3 集合Set</h4><p>和java中的set特点类似，不允许重复</p>
<ul>
<li><p>sadd&#x2F;smembers&#x2F;sismember：添加&#x2F;查看&#x2F;判断是否存在</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sadd set01 <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> # 添加元素（自动排除重复元素）</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; smembers set01 # 查询set01集合</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sismember set01 <span class="number">2</span></span><br><span class="line">(integer) <span class="number">1</span> # 存在</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sismember set01 <span class="number">5</span></span><br><span class="line">(integer) <span class="number">0</span> # 不存在</span><br></pre></td></tr></table></figure>

<ul>
<li>注意：1和0可不是下标，而是布尔。1：true存在，2：false不存在</li>
</ul>
</li>
<li><p>scard：获得集合中的元素个数</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; scard set01 </span><br><span class="line">(integer) <span class="number">3</span> # 集合中有<span class="number">3</span>个元素</span><br></pre></td></tr></table></figure>
</li>
<li><p>srem：删除集合中的元素</p>
<ul>
<li>srem key value</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; srem set01 <span class="number">2</span> # 移除set01中的元素<span class="number">2</span></span><br><span class="line">(integer) <span class="number">1</span> # <span class="number">1</span>表示移除成功</span><br></pre></td></tr></table></figure>
</li>
<li><p>srandmember：从集合中随机获取几个元素’</p>
<ul>
<li>srandmember 整数（个数）</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> sadd set01 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> </span><br><span class="line">(integer) <span class="number">9</span> </span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> smembers set01 </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;6&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;7&quot;</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;8&quot;</span> </span><br><span class="line"><span class="number">9</span>) <span class="string">&quot;9&quot;</span></span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> srandmember set01 <span class="number">3</span> <span class="comment"># 从set01中随机获取3个元素</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;8&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> srandmember set01 <span class="number">5</span> <span class="comment"># 从set01中随机获取5个元素</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;8&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;7&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;6&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>spop：随机出栈（移除）</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> smembers set01</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;6&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;7&quot;</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;8&quot;</span> </span><br><span class="line"><span class="number">9</span>) <span class="string">&quot;9&quot;</span></span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> spop set01 <span class="comment"># 随机移除一个元素</span></span><br><span class="line"><span class="string">&quot;8&quot;</span></span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> spop set01 <span class="comment"># 随机移除一个元素</span></span><br><span class="line"><span class="string">&quot;7&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>smove：移动元素：将key1某个值赋值给key2</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sadd set01 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sadd set02 x y z</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; smove set01 set02 <span class="number">3</span> # 将set01中的元素<span class="number">3</span>移动到set02中</span><br><span class="line">(integer) <span class="number">1</span> # 移动成功</span><br></pre></td></tr></table></figure>
</li>
<li><p>数学集合类</p>
<ul>
<li>交集：sinter</li>
<li>并集：sunion</li>
<li>差集：sdiff</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sadd set01 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> </span><br><span class="line">(integer) <span class="number">5</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sadd set02 <span class="number">2</span> a <span class="number">1</span> b <span class="number">3</span> </span><br><span class="line">(integer) <span class="number">5</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sinter set01 set02 # set01和set02共同存在的元素 </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sunion set01 set02 # 将set01和set02中所有元素合并起来（排除重复的） </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;2&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;b&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;a&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sdiff setr01 set02 </span><br><span class="line">(empty list or set) </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sdiff set01 set02 # 在set01中存在，在set02中不存在</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;4&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; sdiff set02 set01 # 在set02中存在，在set01中不存在 </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;b&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;a&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-1-4-哈希Hash"><a href="#3-1-4-哈希Hash" class="headerlink" title="3.1.4 哈希Hash"></a>3.1.4 哈希Hash</h4><p>类似java里面的Map&lt;String,Object&gt;<br>KV模式不变，但V是一个键值对</p>
<ul>
<li><p><strong>hset&#x2F;hget&#x2F;hmset&#x2F;hmget&#x2F;hgetall&#x2F;hdel</strong>：添加&#x2F;得到&#x2F;多添加&#x2F;多得到&#x2F;得到全部&#x2F;删除属性</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hset user id <span class="number">1001</span> # 添加user，值为id=<span class="number">1001</span> </span><br><span class="line">(integer) <span class="number">1</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hget user </span><br><span class="line">(error) ERR wrong number of arguments for &#x27;hget&#x27; command </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hget user id # 查询user，必须指明具体的字段 <span class="string">&quot;1001&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hmset student id <span class="number">101</span> name tom age <span class="number">22</span> # 添加学生student，属性一堆 </span><br><span class="line">OK127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hget student name # 获取学生名字 </span><br><span class="line"><span class="string">&quot;tom&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hmget student name age # 获取学生年龄 </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;tom&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;22&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hgetall student # 获取学生全部信息 </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;id&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;101&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;name&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;tom&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;age&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;22&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hdel student age # 删除学生年龄属性 </span><br><span class="line">(integer) <span class="number">1</span> # 删除成功 </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hgetall student </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;id&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;101&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;name&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;tom&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>hlen：返回元素的属性个数</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hgetall student </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;id&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;101&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;name&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;tom&quot;</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hlen student </span><br><span class="line">(integer) <span class="number">2</span> # student属性的数量，id和name，共两个属性</span><br></pre></td></tr></table></figure>
</li>
<li><p>hexists：判断元素是否存在某个属性</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hexists student name # student中是否存在name属性</span><br><span class="line">(integer) <span class="number">1</span> # 存在</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hexists student age # student中是否存在age属性</span><br><span class="line">(integer) <span class="number">0</span> # 不存在</span><br></pre></td></tr></table></figure>
</li>
<li><p>hkeys&#x2F;hvals：获得属性的所有key&#x2F;获得属性的所有value</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hkeys student # 获取student所有的属性名</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;id&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;name&quot;</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hvals student # 获取student所有属性的值（内容） </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;101&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;tom&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>hincrby&#x2F;hincrbyfloat：自增（整数）&#x2F;自增（小数）</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hmset student id <span class="number">101</span> name tom age <span class="number">22</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hincrby student age <span class="number">2</span> # 自增整数<span class="number">2</span></span><br><span class="line">(integer) <span class="number">24</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hget student age</span><br><span class="line"><span class="string">&quot;24&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hmset user id <span class="number">1001</span> money <span class="number">1000</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hincrbyfloat user money <span class="number">5</span>.<span class="number">5</span> # 自增小数<span class="number">5</span>.<span class="number">5</span></span><br><span class="line"><span class="string">&quot;1005.5&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; hget user money</span><br><span class="line"><span class="string">&quot;1005.5&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>hsetnx：添加的时候，先判断是否存在</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> hsetnx student age <span class="number">18</span> <span class="comment"># 添加时，判断age是否存在 </span></span><br><span class="line">(integer) <span class="number">0</span> <span class="comment"># 添加失败，因为age已存在 </span></span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> hsetnx student sex 男 <span class="comment"># 添加时，判断sex是否存在 </span></span><br><span class="line">(integer) <span class="number">1</span> <span class="comment"># 添加成功，因为sex不存在 </span></span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> hgetall student </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;id&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;101&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;name&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;tom&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;age&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;24&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;sex&quot;</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;\xe7\x94\xb7&quot;</span> <span class="comment"># 可以添加中文，但是显示为乱码（后期解决）</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-1-5-有序集合Zset"><a href="#3-1-5-有序集合Zset" class="headerlink" title="3.1.5 有序集合Zset"></a>3.1.5 有序集合Zset</h4><p>真实需求：<br>充10元可享vip1；<br>充20元可享vip2；<br>充30元可享vip3；<br>以此类推…</p>
<ul>
<li><p>zadd&#x2F;zrange （withscores）：添加&#x2F;查询</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> zadd zset01 <span class="number">10</span> vip1 <span class="number">20</span> vip2 <span class="number">30</span> vip3 <span class="number">40</span> vip4 <span class="number">50</span> vip5 </span><br><span class="line">(integer) <span class="number">5</span> </span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> zrange zset01 <span class="number">0</span> -<span class="number">1</span> <span class="comment"># 查询数据 </span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;vip1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;vip2&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;vip4&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;vip5&quot;</span> </span><br><span class="line"><span class="meta prompt_">127.0.0.1:6379&gt;</span> zrange zset01 <span class="number">0</span> -<span class="number">1</span> withscores <span class="comment"># 带着分数查询数据 </span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;vip1&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;10&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;vip2&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;20&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;30&quot;</span> </span><br><span class="line"><span class="number">7</span>) <span class="string">&quot;vip4&quot;</span> </span><br><span class="line"><span class="number">8</span>) <span class="string">&quot;40&quot;</span> </span><br><span class="line"><span class="number">9</span>) <span class="string">&quot;vip5&quot;</span> </span><br><span class="line"><span class="number">10</span>) <span class="string">&quot;50&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zrangebyscore：模糊查询</p>
<ul>
<li>( ： 不包含 </li>
<li>limit：跳过几个截取几个</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset01 <span class="number">20</span> <span class="number">40</span> # <span class="number">20</span> &lt;= score &lt;= <span class="number">40</span> </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip2&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;vip4&quot;</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset01 <span class="number">20</span> (<span class="number">40</span> # <span class="number">20</span> &lt;= score &lt; <span class="number">40</span> </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip2&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset01 (<span class="number">20</span> (<span class="number">40</span> # <span class="number">20</span> &lt; score &lt; <span class="number">40</span> </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset01 <span class="number">10</span> <span class="number">40</span> limit <span class="number">2</span> <span class="number">2</span> # <span class="number">10</span> &lt;= score &lt;= <span class="number">40</span>，共返回四个，跳过前<span class="number">2</span>个，取<span class="number">2</span>个 </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;vip4&quot;</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset01 <span class="number">10</span> <span class="number">40</span> limit <span class="number">2</span> <span class="number">1</span> # <span class="number">20</span> &lt;= score &lt;= <span class="number">40</span>，共返回四个，跳过前<span class="number">2</span>个，取<span class="number">1</span>个 </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip3&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zrem：删除元素</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; zrem zset01 vip5 # 移除vip5</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zcard&#x2F;zcount&#x2F;zrank&#x2F;zscore：集合长度&#x2F;范围内元素个数&#x2F;得元素下标&#x2F;通过值得分数</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; zcard zset01 # 集合中元素的个数 </span><br><span class="line">(integer) <span class="number">4</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; zcount zset01 <span class="number">20</span> <span class="number">30</span> # 分数在<span class="number">20</span>~<span class="number">40</span>之间，共有几个元素 </span><br><span class="line">(integer) <span class="number">2</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; zrank zset01 vip3 # vip3在集合中的下标（从上向下） </span><br><span class="line">(integer) <span class="number">2</span> </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; zscore zset01 vip2 # 通过元素获得对应的分数 </span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zrevrank：逆序找下标（从下向上）</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; zrevrank zset01 vip3</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zrevrange：逆序查询</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrange zset01 <span class="number">0</span> -<span class="number">1</span> # 顺序查询</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip1&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;vip2&quot;</span> </span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">4</span>) <span class="string">&quot;vip4&quot;</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrevrange zset01 <span class="number">0</span> -<span class="number">1</span> # 逆序查询 </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip4&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;vip2&quot;</span> </span><br><span class="line"><span class="attribute">4</span>) <span class="string">&quot;vip1&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zrevrangebyscore：逆序范围查找</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrevrangebyscore zset01 <span class="number">30</span> <span class="number">20</span> # 逆序查询分数在<span class="number">30</span>~<span class="number">20</span>之间的 （注意，先写大值，再写小值）</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;vip3&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;vip2&quot;</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrevrangebyscore zset01 <span class="number">20</span> <span class="number">30</span> # 如果小值在前，则结果为null (empty list or set)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-3-持久化"><a href="#3-3-持久化" class="headerlink" title="3.3 持久化"></a>3.3 持久化</h3><h4 id="3-3-1-RDB"><a href="#3-3-1-RDB" class="headerlink" title="3.3.1 RDB"></a>3.3.1 RDB</h4><p><strong>R</strong>edis <strong>D</strong>ata<strong>B</strong>ase</p>
<ul>
<li>在指定的时间间隔内，将内存中的数据集的快照写入磁盘；</li>
<li>默认保存在&#x2F;usr&#x2F;local&#x2F;bin中，文件名dump.rdb;</li>
</ul>
<h5 id="3-3-1-1-自动备份"><a href="#3-3-1-1-自动备份" class="headerlink" title="3.3.1.1 自动备份"></a>3.3.1.1 自动备份</h5><ul>
<li>redis是内存数据库，当我们每次用完redis，关闭linux时，按道理来说，内存释放，redis中的数据也会随之消失</li>
<li>为什么我们再次启动redis的时候，昨天的数据还在，并没有消失呢？</li>
<li>正是因为，每次关机时，redis会自动将数据备份到一个文件中 ：&#x2F;usr&#x2F;local&#x2F;bin&#x2F;<strong>dump.rdb</strong></li>
<li>接下来我们就来全方位的认识 自动备份机制</li>
</ul>
<ol>
<li><p>默认的自动备份策略不利于我们测试，所以修改redis.conf文件中的自动备份策略</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">/SNAP <span class="meta"># 搜索</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">save</span> <span class="number">900</span> <span class="number">1</span> <span class="meta"># 900秒内，至少变更1次，才会自动备份</span></span><br><span class="line"><span class="keyword">save</span> <span class="number">120</span> <span class="number">10</span> <span class="meta"># 120秒内，至少变更10次，才会自动备份</span></span><br><span class="line"><span class="keyword">save</span> <span class="number">60</span> <span class="number">10000</span> <span class="meta"># 60秒内，至少变更10000次，才会自动备份</span></span><br></pre></td></tr></table></figure>

<p>当然如果你只是用Redis的缓存功能，不需要持久化，那么你可以注释掉所有的 save 行来停用保存功能。可以直接一个空字符串来实现停用：save “”</p>
</li>
<li><p>使用shutdown模拟关机 ，关机之前和关机之后，对比dump.rdb文件的更新时间。注意：当我们使用shutdown命令，redis会自动将数据库备份，所以，dump.rdb文件创建时间更新了</p>
</li>
<li><p>开机启动redis，我们要在120秒内保存10条数据，再查看dump.rdb文件的更新时间（开两个终端窗口，方便查看）</p>
</li>
<li><p>120秒内保存10条数据这一动作触发了备份指令，目前，dump.rdb文件中保存了10条数据，将dump.rdb拷贝一份dump10.rdb，此时两个文件中都保存10条数据</p>
</li>
<li><p>既然有数据已经备份了，那我们就肆无忌惮的将数据全部删除flushall，再次shutdown关机</p>
</li>
<li><p>再次启动redis，发现数据真的消失了，并没有按照我们所想的 将dump.rdb文件中的内容恢复到redis中。为什么？</p>
<blockquote>
<p>因为，当我们保存10条以上的数据时，数据备份起来了；</p>
<p>然后删除数据库，备份文件中的数据，也没问题；</p>
<p>但是，问题出在shutdown上，这个命令一旦执行，就会立刻备份，将删除之后的空数据库生成备份文件，将之前装10条数据的备份文件覆盖掉了。所以，就出现了上图的结果。自动恢复失败。</p>
<p>怎么解决这个问题呢？要将备份文件再备份</p>
</blockquote>
</li>
<li><p>将dump.rdb文件删除，将dump10.rdb重命名为dump.rdb</p>
</li>
<li><p>启动redis服务，登录redis，数据10条，全部恢复！</p>
</li>
</ol>
<h5 id="3-3-1-2-手动备份"><a href="#3-3-1-2-手动备份" class="headerlink" title="3.3.1.2 手动备份"></a>3.3.1.2 手动备份</h5><ul>
<li>之前自动备份，必须更改好多数据，例如上边，我们改变了十多条数据，才会自动备份；</li>
<li>现在，我只保存一条数据，就想立刻备份，应该怎么做？</li>
<li>每次操作完成，执行命令 save 就会立刻备份</li>
</ul>
<h5 id="3-3-1-3-与RDB相关的配置"><a href="#3-3-1-3-与RDB相关的配置" class="headerlink" title="3.3.1.3 与RDB相关的配置"></a>3.3.1.3 与RDB相关的配置</h5><ul>
<li>stop-writes-on-bgsave-error：进水口和出水口，出水口发生故障与否<ul>
<li>yes：当后台备份时候反生错误，前台停止写入</li>
<li>no：不管死活，就是往里怼</li>
</ul>
</li>
<li>rdbcompression：对于存储到磁盘中的快照，是否启动LZF压缩算法，一般都会启动，因为这点性能，多买一台电脑，完全搞定N个来回了。<ul>
<li>yes：启动</li>
<li>no：不启动（不想消耗CPU资源，可关闭）</li>
</ul>
</li>
<li>dbfilename：快照备份文件名字</li>
<li>dir：快照备份文件保存的目录，默认为当前目录</li>
</ul>
<p>优势and劣势</p>
<ul>
<li>优：适合大规模数据恢复，对数据完整性和一致行要求不高；</li>
<li>劣：一定间隔备份一次，意外down掉，就失去最后一次快照的所有修改</li>
</ul>
<h4 id="3-3-2-AOF"><a href="#3-3-2-AOF" class="headerlink" title="3.3.2 AOF"></a>3.3.2 AOF</h4><p><strong>A</strong>ppend <strong>O</strong>nly <strong>F</strong>ile</p>
<ul>
<li>以日志的形式记录每个写操作；</li>
<li>将redis执行过的写指令全部记录下来（读操作不记录）；</li>
<li>只许追加文件，不可以改写文件；</li>
<li>redis在启动之初会读取该文件从头到尾执行一遍，这样来重新构建数据；</li>
</ul>
<h5 id="3-3-2-1-开启AOF"><a href="#3-3-2-1-开启AOF" class="headerlink" title="3.3.2.1 开启AOF"></a>3.3.2.1 开启AOF</h5><ol>
<li><p>为了避免失误，最好将redis.conf总配置文件备份一下，然后再修改内容如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">appendonly</span> <span class="literal">yes</span></span><br><span class="line">appendfilename appendonly.aof</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动redis，以新配置文件启动</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">redis</span>-server /usr/local/redis5.<span class="number">0</span>.<span class="number">4</span>/redis.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接redis，加数据，删库，退出</p>
</li>
<li><p>查看当前文件夹多一个aof文件，看看文件中的内容,保存的都是 <strong>写</strong> 操作</p>
<ul>
<li>文件中最后一句要删除，否则数据恢复不了</li>
<li>编辑这个文件，最后要 :wq**!** 强制执行</li>
</ul>
</li>
<li><p>只需要重新连接，数据恢复成功</p>
</li>
</ol>
<h5 id="3-3-2-2-共存？谁优先？"><a href="#3-3-2-2-共存？谁优先？" class="headerlink" title="3.3.2.2 共存？谁优先？"></a>3.3.2.2 共存？谁优先？</h5><p>我们查看redis.conf文件，AOF和RDB两种备份策略可以同时开启，那系统会怎样选择？</p>
<ol>
<li><p>动手试试，编辑appendonly.aof，胡搞乱码，保存退出</p>
</li>
<li><p>启动redis 失败，所以是AOF优先载入来恢复原始数据！因为AOF比RDB数据保存的完整性更高！</p>
</li>
<li><p>修复AOF文件，杀光不符合redis语法规范的代码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reids<span class="operator">-</span><span class="keyword">check</span><span class="operator">-</span>aof <span class="comment">--fix appendonly.aof</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="3-3-2-3-与AOF相关的配置"><a href="#3-3-2-3-与AOF相关的配置" class="headerlink" title="3.3.2.3 与AOF相关的配置"></a>3.3.2.3 与AOF相关的配置</h5><ul>
<li>appendonly：开启aof模式</li>
<li>appendfilename：aof的文件名字，最好别改！</li>
<li>appendfsync：追写策略<ul>
<li>always：每次数据变更，就会<strong>立即记录</strong>到磁盘，性能较差，但数据完整性好</li>
<li>everysec：默认设置，异步操作，<strong>每秒记录</strong>，如果一秒内宕机，会有数据丢失</li>
<li>no：不追写</li>
</ul>
</li>
<li>no-appendfsync-on-rewrite：重写时是否运用Appendfsync追写策略；用默认no即可，保证数据安全性。<ul>
<li>AOF采用文件追加的方式，文件会越来越大，为了解决这个问题，增加了重写机制，redis会自动记录上一次AOF文件的大小，当AOF文件大小达到预先设定的大小时，redis就会启动AOF文件进行内容压缩，只保留可以恢复数据的最小指令集合</li>
</ul>
</li>
<li>auto-aof-rewrite-percentage：如果AOF文件大小已经超过原来的100%，也就是一倍，才重写压缩</li>
<li>auto-aof-rewrite-min-size：如果AOF文件已经超过了64mb，才重写压缩</li>
</ul>
<h4 id="3-3-3-总结（如何选择？）"><a href="#3-3-3-总结（如何选择？）" class="headerlink" title="3.3.3 总结（如何选择？）"></a>3.3.3 总结（如何选择？）</h4><ul>
<li>RDB：只用作后备用途，建议15分钟备份一次就好</li>
<li>AOF：<ul>
<li>在最恶劣的情况下，也只丢失不超过2秒的数据，数据完整性比较高，但代价太大，会带来持续的IO</li>
<li>对硬盘的大小要求也高，默认64mb太小了，企业级最少都是5G以上；</li>
<li>后面要学习的master&#x2F;slave才是新浪微博的选择！！</li>
</ul>
</li>
</ul>
<h3 id="3-4-事务"><a href="#3-4-事务" class="headerlink" title="3.4 事务"></a>3.4 事务</h3><ul>
<li>可以一次执行多个命令，是一个命令组，一个事务中，所有命令都会序列化（排队），不会被插队；</li>
<li>一个队列中，一次性，顺序性，排他性的执行一系列命令</li>
<li>三特性<ul>
<li>隔离性：所有命令都会按照顺序执行，事务在执行的过程中，不会被其他客户端送来的命令打断</li>
<li>没有隔离级别：队列中的命令没有提交之前都不会被实际的执行，不存在“事务中查询要看到事务里的更新，事务外查询不能看到”这个头疼的问题</li>
<li>不保证原子性：冤有头债有主，如果一个命令失败，但是别的命令可能会执行成功，没有回滚</li>
</ul>
</li>
<li>三步走<ul>
<li>开启multi</li>
<li>入队queued</li>
<li>执行exec</li>
</ul>
</li>
<li>与关系型数据库事务相比，<ul>
<li>multi：可以理解成关系型事务中的 begin</li>
<li>exec ：可以理解成关系型事务中的 commit</li>
<li>discard ：可以理解成关系型事务中的 rollback</li>
</ul>
</li>
</ul>
<h4 id="3-4-1-一起生"><a href="#3-4-1-一起生" class="headerlink" title="3.4.1 一起生"></a>3.4.1 一起生</h4><p>开启事务，加入队列，一起执行，并成功</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; multi # 开启事务 </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k1 v1 </span><br><span class="line">QUEUED # 加入队列 </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k2 v2</span><br><span class="line">QUEUED # 加入队列 </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k2 </span><br><span class="line">QUEUED # 加入队列 </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k3 v3 </span><br><span class="line">QUEUED # 加入队列 </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exec # 执行，一起成功！ </span><br><span class="line"><span class="number">1</span>) OK </span><br><span class="line"><span class="number">2</span>) OK </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;v2&quot;</span> </span><br><span class="line"><span class="number">4</span>) OK</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-一起死"><a href="#3-4-2-一起死" class="headerlink" title="3.4.2 一起死"></a>3.4.2 一起死</h4><p>放弃之前的操作，恢复到原来的值</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; multi # 开启事务 </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k1 v1111 </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k2 v2222 </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; discard # 放弃操作 </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get k1 <span class="string">&quot;v1&quot;</span> # 还是原来的值</span><br></pre></td></tr></table></figure>

<h4 id="3-4-3-一粒老鼠屎坏一锅汤"><a href="#3-4-3-一粒老鼠屎坏一锅汤" class="headerlink" title="3.4.3 一粒老鼠屎坏一锅汤"></a>3.4.3 一粒老鼠屎坏一锅汤</h4><p>一句报错，全部取消，恢复到原来的值</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; multi </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k4 v4 </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; setlalala # 一句报错 </span><br><span class="line">(error) ERR unknown command `setlalala`, with args beginning with: </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k5 v5 </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exec # 队列中命令全部取消 </span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors. </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; keys * # 还是原来的值 </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k2&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;k3&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;k1&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-4-4-冤有头债有主"><a href="#3-4-4-冤有头债有主" class="headerlink" title="3.4.4 冤有头债有主"></a>3.4.4 冤有头债有主</h4><p>追究责任，谁的错，找谁去</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; multi </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; incr k1 # 虽然v1不能++，但是加入队列并没有报错，类似java中的通过编 译</span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k4 v4 </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set k5 v5 </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exec </span><br><span class="line"><span class="number">1</span>) (error) ERR value is not an integer or out of range # 真正执行的时候，报错 <span class="number">2</span>) OK # 成功 </span><br><span class="line"><span class="number">3</span>) OK # 成功 </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; keys * </span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k5&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;k1&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;k3&quot;</span> </span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;k2&quot;</span> </span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;k4&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-4-5-watch监控"><a href="#3-4-5-watch监控" class="headerlink" title="3.4.5 watch监控"></a>3.4.5 watch监控</h4><p>测试：模拟收入与支出</p>
<ul>
<li><p>正常情况下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; set in <span class="number">100</span> # 收入<span class="number">100</span>元 </span><br><span class="line"><span class="attribute">OK</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; set out <span class="number">0</span> # 支出<span class="number">0</span>元 </span><br><span class="line"><span class="attribute">OK</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi </span><br><span class="line"><span class="attribute">OK</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; decrby in <span class="number">20</span> # 收入-<span class="number">20</span> </span><br><span class="line"><span class="attribute">QUEUED</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incrby out <span class="number">20</span> # 支出+<span class="number">20</span> </span><br><span class="line"><span class="attribute">QUEUED</span> </span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec </span><br><span class="line"><span class="attribute">1</span>) (integer) <span class="number">80</span> </span><br><span class="line"><span class="attribute">2</span>) (integer) <span class="number">20</span> # 结果，没问题！</span><br></pre></td></tr></table></figure>
</li>
<li><p>特殊情况下：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; watch in # 监控收入in </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; multi </span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; decrby in <span class="number">20</span> </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; incrby out <span class="number">20</span> </span><br><span class="line">QUEUED </span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; exec </span><br><span class="line">(nil) # 在exec之前，我开启了另一个窗口（线程），对监控的in做了修改，所以本次的事务将 被打断（失效），类似于“乐观锁”</span><br></pre></td></tr></table></figure>
</li>
<li><p>unwatch：取消watch命令对所有key的操作</p>
<ul>
<li>一旦执行了exec命令，那么之前加的所有监控自动失效！</li>
</ul>
</li>
</ul>
<h3 id="3-5-Redis的发布订阅"><a href="#3-5-Redis的发布订阅" class="headerlink" title="3.5 Redis的发布订阅"></a>3.5 Redis的发布订阅</h3><ul>
<li><p>进程间的一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息。例如：微信订阅号</p>
</li>
<li><p>订阅一个或多个频道</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; subscribe cctv1 cctv5 cctv6 # <span class="number">1</span>.订阅三个频道 </span><br><span class="line"><span class="attribute">Reading</span> messages... (press Ctrl-C to quit) </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;subscribe&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;cctv1&quot;</span> </span><br><span class="line"><span class="attribute">3</span>) (integer) <span class="number">1</span> </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;subscribe&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;cctv5&quot;</span></span><br><span class="line"><span class="attribute">3</span>) (integer) <span class="number">2</span> </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;subscribe&quot;</span> </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;cctv6&quot;</span> </span><br><span class="line"><span class="attribute">3</span>) (integer) <span class="number">3</span> </span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;message&quot;</span> # <span class="number">3</span>.cctv5接收到推送过来的信息 </span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;cctv5&quot;</span> </span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;NBA&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>发送消息</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; publish cctv5 NBA # <span class="number">2</span>.发送消息给cctv5 </span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-5-主从复制"><a href="#3-5-主从复制" class="headerlink" title="3.5 主从复制"></a>3.5 主从复制</h3><ul>
<li>就是 redis集群的策略</li>
<li>配从（库）不配主（库）：小弟可以选择谁是大哥，但大哥没有权利去选择小弟</li>
<li>读写分离：主机写，从机读</li>
</ul>
<h4 id="3-5-1-一主二仆"><a href="#3-5-1-一主二仆" class="headerlink" title="3.5.1 一主二仆"></a>3.5.1 一主二仆</h4><ol>
<li><p>准备三台服务器，并修改redis.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bind</span> <span class="number">0.0.0.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动三台redis，并查看每台机器的角色，都是master</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">info</span> <span class="keyword">replication</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试开始</p>
<ul>
<li><p>首先，将三个机器全都清空，第一台添加值</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">mset</span> k1 <span class="built_in">v1</span> k2 <span class="built_in">v2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>其余两台机器，复制（找大哥）</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">slaveof</span> <span class="number">192.168.204.141</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第一台再添加值</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> k3 <span class="comment">v3</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<ul>
<li>**思考1：**slave之前的k1和k2是否能拿到？</li>
<li>**思考2：**slave之后的k3是否能拿到？</li>
<li>**思考3：**同时添加k4，结果如何？</li>
<li>**思考4：**主机shutdown，从机如何？</li>
<li>**思考5：**主机重启，从机又如何？</li>
<li>**思考6：**从机死了，主机如何？从机归来身份是否变化？</li>
</ul>
<h4 id="3-5-2-血脉相传"><a href="#3-5-2-血脉相传" class="headerlink" title="3.5.2 血脉相传"></a>3.5.2 血脉相传</h4><ul>
<li><p>一个主机理论上可以多个从机，但是这样的话，这个主机会很累</p>
</li>
<li><p>我们可以使用java面向对象<strong>继承中的传递性</strong>来解决这个问题，减轻主机的负担</p>
</li>
<li><p>形成祖孙三代：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; slaveof <span class="number">192.168.204.141</span> <span class="number">6379</span> # <span class="number">142</span>跟随<span class="number">141</span></span><br><span class="line"><span class="attribute">OK</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; slaveof <span class="number">192.168.204.142</span> <span class="number">6379</span> # <span class="number">143</span>跟随<span class="number">142</span> &#x27;</span><br><span class="line"><span class="attribute">OK</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-5-3-谋权篡位"><a href="#3-5-3-谋权篡位" class="headerlink" title="3.5.3 谋权篡位"></a>3.5.3 谋权篡位</h4><ul>
<li><p>1个主机，2个从机，当1个主机挂掉了，只能从2个从机中再次选1个主机</p>
</li>
<li><p>国不可一日无君，军不可一日无帅</p>
</li>
<li><p>手动选老大</p>
</li>
<li><p>模拟测试：1为master，2和3为slave，当1挂掉后，2篡权为master，3跟2</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">slaveof</span> <span class="literal">no</span> one <span class="comment"># 2上执行，没有人能让我臣服，那我就是老大</span></span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">slaveof</span> <span class="number">192.168.204.142</span> <span class="number">6379</span> # <span class="number">3</span>跟随<span class="number">2</span>号</span><br></pre></td></tr></table></figure>
</li>
<li><p>**思考：**当1再次回归，会怎样？</p>
<ul>
<li>2和3已经形成新的集群，和1没有任何的关系了。所以1成为了光杆司令</li>
</ul>
</li>
</ul>
<h4 id="3-5-4-复制原理"><a href="#3-5-4-复制原理" class="headerlink" title="3.5.4 复制原理"></a>3.5.4 复制原理</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee-imagehost.oss-cn-beijing.aliyuncs.com/image_host/image-20210521111751345.png" alt="image-20210521111751345"></p>
<p>完成上面几个步骤后就完成了从服务器数据初始化的所有操作，从服务器此时可以接收来自用户的读请求</p>
<ul>
<li><strong>全量复制</strong>：Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份slave接收到数据文件后，存盘，并加载到内存中；（步骤1234）</li>
<li><strong>增量复制</strong>：Slave初始化后，开始正常工作时主服务器发生的写操作同步到从服务器的过程；（步骤56）但，只要是重新连接master，一次性（全量复制）同步将自动执行；</li>
<li>Redis主从同步策略：主从刚刚连接的时候，进行全量同步；全同步结束后，进行增量同步。</li>
<li>当然，如果有需要，slave 在任何时候都可以发起全量同步。</li>
<li>redis 策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。</li>
</ul>
<h4 id="3-5-5-哨兵模式"><a href="#3-5-5-哨兵模式" class="headerlink" title="3.5.5 哨兵模式"></a>3.5.5 哨兵模式</h4><ul>
<li><p>自动版的谋权篡位！</p>
</li>
<li><p>有个哨兵一直在巡逻，突然发现！！！！！老大挂了，小弟们会自动投票，从众小弟中选出新的老大</p>
</li>
<li><p>Sentinel是Redis的高可用性解决方案：</p>
<ul>
<li>由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求</li>
</ul>
</li>
<li><p>模拟测试</p>
<ul>
<li><p>1主，2和3从 </p>
</li>
<li><p>每一台服务器中创建一个配置文件sentinel.conf，名字绝不能错，并编辑sentinel.conf</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sentinel monitor 被监控主机名（自定义） ip port 票数 </span></span><br><span class="line">sentinel<span class="built_in"> monitor </span>redis141 192.168.204.141 6379 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务的顺序：主Redis –&gt; 从Redis –&gt; Sentinel1&#x2F;2&#x2F;3</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将1号老大挂掉，后台自动发起激烈的投票，选出新的老大</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; shutdown</span><br><span class="line">not connected&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看最后权利的分配</p>
<ul>
<li>3成为了新的老大，2还是小弟</li>
</ul>
</li>
<li><p>如果之前的老大再次归来呢？</p>
<ul>
<li>1号再次归来，自己成为了master，和3平起平坐</li>
<li>过了几秒之后，被哨兵检测到了1号机的归来，1号你别自己玩了，进入集体吧，但是新的老大已经产生了，你只能作为小弟再次进入集体！</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="3-5-6-缺点"><a href="#3-5-6-缺点" class="headerlink" title="3.5.6 缺点"></a>3.5.6 缺点</h4><ul>
<li>由于所有的写操作都是在master上完成的；</li>
<li>然后再同步到slave上，所以两台机器之间通信会有延迟；</li>
<li>当系统很繁忙的时候，延迟问题会加重；</li>
<li>slave机器数量增加，问题也会加重</li>
</ul>
<h3 id="3-6-总配置redis-conf-详解"><a href="#3-6-总配置redis-conf-详解" class="headerlink" title="3.6 总配置redis.conf 详解"></a>3.6 总配置redis.conf 详解</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis 配置文件示例</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意单位: 当需要配置内存大小时, 可能需要指定像1k,5GB,4M等常见格式</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1k =&gt; 1000 bytes</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1kb =&gt; 1024 bytes</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1mb =&gt; 1024*1024 bytes</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1g =&gt; 1000000000 bytes</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1gb =&gt; 1024*1024*1024 bytes</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 单位是对大小写不敏感的 1GB 1Gb 1gB 是相同的。</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# INCLUDES 包含文件相关</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##################################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以在这里包含一个或多个其他的配置文件。如果你有一个适用于所有Redis服务器的标准配置模板</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">但也需要一些每个服务器自定义的设置，这个功能将很有用。被包含的配置文件也可以包含其他配置文 件，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所以需要谨慎的使用这个功能。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 注意“inclue”选项不能被admin或Redis哨兵的&quot;CONFIG REWRITE&quot;命令重写。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为Redis总是使用最后解析的配置行最为配置指令的值, 你最好在这个文件的开头配置includes来</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">避免它在运行时重写配置。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果相反你想用includes的配置覆盖原来的配置，你最好在该文件的最后使用include</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># include /path/to/local.conf</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">include /path/to/other.conf</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################### GENERAL 综合配置 #####################################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认Rdis不会作为守护进程运行。如果需要的话配置成<span class="string">&#x27;yes&#x27;</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意配置成守护进程后Redis会将进程号写入文件/var/run/redis.pid</span> </span><br><span class="line">daemonize no </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当以守护进程方式运行时，默认Redis会把进程ID写到 /var/run/redis.pid。你可以在这里修改路 径。</span></span><br><span class="line">pidfile /var/run/redis.pid </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">接受连接的特定端口，默认是6379</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果端口设置为0，Redis就不会监听TCP套接字。</span> </span><br><span class="line">port 6379 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TCP listen() backlog.</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server在与客户端建立tcp连接的过程中，SYN队列的大小</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在高并发环境下你需要一个高backlog值来避免慢客户端连接问题。注意Linux内核默默地将这个值减小</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">到/proc/sys/net/core/somaxconn的值，所以需要确认增大somaxconn和tcp_max_syn_backlog</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">两个值来达到想要的效果。</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认Redis监听服务器上所有可用网络接口的连接。可以用<span class="string">&quot;bind&quot;</span>配置指令跟一个或多个ip地址来实现</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听一个或多个网络接口</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 示例:</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># bind 192.168.1.100 10.0.0.1</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">bind</span> 127.0.0.1</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定用来监听Unix套套接字的路径。没有默认值， 所以在没有指定的情况下Redis不会监听Unix套接 字</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># unixsocket /tmp/redis.sock</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">unixsocketperm 755</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个客户端空闲多少秒后关闭连接。(0代表禁用，永不关闭)</span> </span><br><span class="line">timeout 0 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TCP keepalive.</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果非零，则设置SO_KEEPALIVE选项来向空闲连接的客户端发送ACK，由于以下两个原因这是很有用 的：</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1）能够检测无响应的对端</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2）让该连接中间的网络设备知道这个连接还存活</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 在Linux上，这个指定的值(单位：秒)就是发送ACK的时间间隔。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：要关闭这个连接需要两倍的这个时间值。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在其他内核上这个时间间隔由内核配置决定</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个选项的一个合理值是60秒</span></span> </span><br><span class="line">tcp-keepalive 0 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定服务器调试等级</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可能值：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">debug （大量信息，对开发/测试有用）</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">verbose （很多精简的有用信息，但是不像debug等级那么多）</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">notice （适量的信息，基本上是你生产环境中需要的）</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">warning （只有很重要/严重的信息会记录下来）</span> </span><br><span class="line">loglevel notice </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指明日志文件名。也可以使用<span class="string">&quot;stdout&quot;</span>来强制让Redis把日志信息写到标准输出上。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意:如果Redis以守护进程方式运行，而设置日志显示到标准输出的话，日志会发送到/dev/null</span> </span><br><span class="line">logfile &quot;&quot; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">要使用系统日志记录器，只要设置 <span class="string">&quot;syslog-enabled&quot;</span> 为 <span class="string">&quot;yes&quot;</span> 就可以了。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">然后根据需要设置其他一些syslog参数就可以了。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">syslog-enabled no</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指明syslog身份</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">syslog-ident redis</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指明syslog的设备。必须是user或LOCAL0 ~ LOCAL7之一。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">syslog-facility local0</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置数据库个数。默认数据库是 DB 0，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以通过<span class="keyword">select</span> &lt;dbid&gt; (0 &lt;= dbid &lt;= <span class="string">&#x27;databases&#x27;</span> - 1 ）来为每个连接使用不同的数据 库。</span></span><br><span class="line">databases 16 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################### SNAPSHOTTING 快照，持久化操作配置</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 把数据库存到磁盘上:</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># save &lt;seconds&gt; &lt;changes&gt;</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 会在指定秒数和数据变化次数之后把数据库写到磁盘上。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 下面的例子将会进行把数据写入磁盘的操作:</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">900秒（15分钟）之后，且至少1次变更</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">300秒（5分钟）之后，且至少10次变更</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">60秒之后，且至少10000次变更</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 注意：你要想不写磁盘的话就把所有 &quot;save&quot; 设置注释掉就行了。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过添加一条带空字符串参数的save指令也能移除之前所有配置的save指令</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">像下面的例子：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">save <span class="string">&quot;&quot;</span></span> </span><br><span class="line">save 900 1 </span><br><span class="line">save 300 10 </span><br><span class="line">save 60 10000 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果后台保存进程能重新开始工作，Redis将自动允许写操作</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 然而如果你已经部署了适当的Redis服务器和持久化的监控，你可能想关掉这个功能以便于即使是</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">硬盘，权限等出问题了Redis也能够像平时一样正常工作，</span> </span><br><span class="line">stop-writes-on-bgsave-error yes </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当导出到 .rdb 数据库时是否用LZF压缩字符串对象？</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认设置为 <span class="string">&quot;yes&quot;</span>，因为几乎在任何情况下它都是不错的。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你想节省CPU的话你可以把这个设置为 <span class="string">&quot;no&quot;</span>，但是如果你有可压缩的key和value的话，</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">那数据文件就会更大了。</span> </span><br><span class="line">rdbcompression yes </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠但在</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生产和加载RDB文件时，这有一个性能消耗(大约10%)，所以你可以关掉它来获取最好的性能。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 生成的关闭校验的RDB文件有一个0的校验和，它将告诉加载代码跳过检查 rdbchecksum yes</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化数据库的文件名</span> </span><br><span class="line">dbfilename dump.rdb </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工作目录</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 数据库会写到这个目录下，文件名就是上面的 &quot;dbfilename&quot; 的值。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 累加文件也放这里。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 注意你这里指定的必须是目录，不是文件名。</span></span> </span><br><span class="line">dir ./ </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################ REPLICATION 主从复制的配置</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主从同步。通过 slaveof 指令来实现Redis实例的备份。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意，这里是本地从远端复制数据。也就是说，本地可以有不同的数据库文件、绑定不同的IP、监听</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不同的端口。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果master设置了密码保护（通过 <span class="string">&quot;requirepass&quot;</span> 选项来配置），那么slave在开始同步之前必须</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行身份验证，否则它的同步请求会被拒绝。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># masterauth &lt;master-password&gt;</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当一个slave失去和master的连接，或者同步正在进行中，slave的行为有两种可能：</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1) 如果 slave-serve-stale-data 设置为 &quot;yes&quot; (默认值)，slave会继续响应客户端请求，</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可能是正常数据，也可能是还没获得值的空数据。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2) 如果 slave-serve-stale-data 设置为 <span class="string">&quot;no&quot;</span>，slave会回复<span class="string">&quot;正在从master同步</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">（SYNC with master in progress）&quot;</span>来处理各种请求，除了 INFO 和 SLAVEOF 命令。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">slave-serve-stale-data <span class="built_in">yes</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">你可以配置salve实例是否接受写操作。可写的slave实例可能对存储临时数据比较有用(因为写入 salve</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">的数据在同master同步之后将很容被删除)，但是如果客户端由于配置错误在写入时也可能产生一些问 题。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 从Redis2.6默认所有的slave为只读</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 注意:只读的slave不是为了暴露给互联网上不可信的客户端而设计的。它只是一个防止实例误用的保护 层。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个只读的slave支持所有的管理命令比如config,debug等。为了限制你可以用<span class="string">&#x27;rename- command&#x27;</span>来</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">隐藏所有的管理和危险命令来增强只读slave的安全性</span> </span><br><span class="line">slave-read-only yes </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave根据指定的时间间隔向master发送ping请求。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间间隔可以通过 repl_ping_slave_period 来设置。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认10秒。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># repl-ping-slave-period 10</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下选项设置同步的超时时间</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1）slave在与master SYNC期间有大量数据传输，造成超时</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2）在slave角度，master超时，包括数据、ping等</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3）在master角度，slave超时，当master发送REPLCONF ACK pings</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 确保这个值大于指定的repl-ping-slave-period，否则在主从间流量不高时每次都会检测到超时</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># repl-timeout 60</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否在slave套接字发送SYNC之后禁用 TCP_NODELAY ？</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果你选择“yes”Redis将使用更少的TCP包和带宽来向slaves发送数据。但是这将使数据传输到 slave</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上有延迟，Linux内核的默认配置会达到40毫秒</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果你选择了 &quot;no&quot; 数据传输到salve的延迟将会减少但要使用更多的带宽</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 默认我们会为低延迟做优化，但高流量情况或主从之间的跳数过多时，把这个选项设置为“yes”</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是个不错的选择。</span> </span><br><span class="line">repl-disable-tcp-nodelay no </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置数据备份的backlog大小。backlog是一个slave在一段时间内断开连接时记录salve数据的缓 冲，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所以一个slave在重新连接时，不必要全量的同步，而是一个增量同步就足够了，将在断开连接的这段</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间内slave丢失的部分数据传送给它。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 同步的backlog越大，slave能够进行增量同步并且允许断开连接的时间就越长。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># backlog只分配一次并且至少需要一个slave连接</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># repl-backlog-size 1mb</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当master在一段时间内不再与任何slave连接，backlog将会释放。以下选项配置了从最后一个</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave断开开始计时多少秒后，backlog缓冲将会释放。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 0表示永不释放backlog</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># repl-backlog-ttl 3600</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave的优先级是一个整数展示在Redis的Info输出中。如果master不再正常工作了，哨兵将用它来</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择一个slave提升=升为master。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 优先级数字小的salve会优先考虑提升为master，所以例如有三个slave优先级分别为10，100，25，</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">哨兵将挑选优先级最小数字为10的slave。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 0作为一个特殊的优先级，标识这个slave不能作为master，所以一个优先级为0的slave永远不会被</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">哨兵挑选提升为master</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 默认优先级为100</span></span> </span><br><span class="line">slave-priority 100 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果master少于N个延时小于等于M秒的已连接slave，就可以停止接收写操作。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># N个slave需要是“oneline”状态</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 延时是以秒为单位，并且必须小于等于指定值，是从最后一个从slave接收到的ping（通常每秒发送）</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始计数。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This option does not GUARANTEES that N replicas will accept the write, but</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">will <span class="built_in">limit</span> the window of exposure <span class="keyword">for</span> lost writes <span class="keyword">in</span> <span class="keyword">case</span> not enough slaves</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">are available, to the specified number of seconds.</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 例如至少需要3个延时小于等于10秒的slave用下面的指令：</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># min-slaves-to-write 3</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">min-slaves-max-lag 10</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 两者之一设置为0将禁用这个功能。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 默认 min-slaves-to-write 值是0（该功能禁用）并且 min-slaves-max-lag 值是10。</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# SECURITY 安全相关配置</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##################################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">要求客户端在处理任何命令时都要验证身份和密码。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个功能在有你不信任的其它客户端能够访问redis服务器的环境里非常有用。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 为了向后兼容的话这段应该注释掉。而且大多数人不需要身份验证(例如:它们运行在自己的服务器上) \</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个高强度的密码，否则破解太容易了。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># requirepass foobared</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令重命名</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 在共享环境下，可以为危险命令改变名字。比如，你可以为 CONFIG 改个其他不太容易猜到的名字，</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这样内部的工具仍然可以使用，而普通的客户端将不行。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 例如：</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 也可以通过改名为空字符串来完全禁用一个命令</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># rename-command CONFIG &quot;&quot;</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 请注意：改变命令名字被记录到AOF文件或被传送到从服务器可能产生问题。</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################## LIMITS 范围配置</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###################################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置最多同时连接的客户端数量。默认这个限制是10000个客户端，然而如果Redis服务器不能配置</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">处理文件的限制数来满足指定的值，那么最大的客户端连接数就被设置成当前文件限制数减32（因</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为Redis服务器保留了一些文件描述符作为内部使用）</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 一旦达到这个限制，Redis会关闭所有新连接并发送错误&#x27;max number of clients reached&#x27;</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># maxclients 10000</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不要用比设置的上限更多的内存。一旦内存使用达到上限，Redis会根据选定的回收策略（参见：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">maxmemmory-policy）删除key</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果因为删除策略Redis无法删除key，或者策略设置为 &quot;noeviction&quot;，Redis会回复需要更</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">多内存的错误信息给命令。例如，SET,LPUSH等等，但是会继续响应像Get这样的只读命令。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 在使用Redis作为LRU缓存，或者为实例设置了硬性内存限制的时候（使用 &quot;noeviction&quot; 策略）</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">的时候，这个选项通常事很有用的。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 警告：当有多个slave连上达到内存上限的实例时，master为同步slave的输出缓冲区所需</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内存不计算在使用内存中。这样当驱逐key时，就不会因网络问题 / 重新同步事件触发驱逐key</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">的循环，反过来slaves的输出缓冲区充满了key被驱逐的DEL命令，这将触发删除更多的key，</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直到这个数据库完全被清空为止</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总之...如果你需要附加多个slave，建议你设置一个稍小maxmemory限制，这样系统就会有空闲</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">的内存作为slave的输出缓存区(但是如果最大内存策略设置为<span class="string">&quot;noeviction&quot;</span>的话就没必要了)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># maxmemory &lt;bytes&gt;</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最大内存策略：如果达到内存限制了，Redis如何选择删除key。你可以在下面五个行为里选：</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># volatile-lru -&gt; 根据LRU算法生成的过期时间来删除。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">allkeys-lru -&gt; 根据LRU算法删除任何key。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">volatile-random -&gt; 根据过期设置来随机删除key。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">allkeys-&gt;random -&gt; 无差别随机删。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">volatile-ttl -&gt; 根据最近过期时间来删除（辅以TTL）</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">noeviction -&gt; 谁也不删，直接在写操作时返回错误。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 注意：对所有策略来说，如果Redis找不到合适的可以删除的key都会在写操作时返回一个错误。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 目前为止涉及的命令：set setnx setex append</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">getset mset msetnx <span class="built_in">exec</span> <span class="built_in">sort</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 默认值如下：</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># maxmemory-policy volatile-lru # LRU和最小TTL算法的实现都不是很精确，但是很接近（为了省内存），所以你可以用样本量做检测。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">例如：默认Redis会检查3个key然后取最旧的那个，你可以通过下面的配置指令来设置样本的个数。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># maxmemory-samples 3</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################# APPEND ONLY MODE AOF模式配置</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##############################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认情况下，Redis是异步的把数据导出到磁盘上。这种模式在很多应用里已经足够好，但Redis进程</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">出问题或断电时可能造成一段时间的写操作丢失(这取决于配置的save指令)。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># AOF是一种提供了更可靠的替代持久化模式，例如使用默认的数据写入文件策略（参见后面的配置）</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在遇到像服务器断电或单写情况下Redis自身进程出问题但操作系统仍正常运行等突发事件时，Redis</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">能只丢失1秒的写操作。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># AOF和RDB持久化能同时启动并且不会有问题。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果AOF开启，那么在启动时Redis将加载AOF文件，它更能保证数据的可靠性。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 请查看 http://redis.io/topics/persistence 来获取更多信息.</span></span> </span><br><span class="line">appendonly no </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">纯累加文件名字（默认：<span class="string">&quot;appendonly.aof&quot;</span>）</span> </span><br><span class="line">appendfilename &quot;appendonly.aof&quot; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">fsync() 系统调用告诉操作系统把数据写到磁盘上，而不是等更多的数据进入输出缓冲区。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有些操作系统会真的把数据马上刷到磁盘上；有些则会尽快去尝试这么做。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Redis支持三种不同的模式：</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># no：不要立刻刷，只有在操作系统需要刷的时候再刷。比较快。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">always：每次写操作都立刻写入到aof文件。慢，但是最安全。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">everysec：每秒写一次。折中方案。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 默认的 &quot;everysec&quot; 通常来说能在速度和数据安全性之间取得比较好的平衡。根据你的理解来</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">决定，如果你能放宽该配置为<span class="string">&quot;no&quot;</span> 来获取更好的性能(但如果你能忍受一些数据丢失，可以考虑使用</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认的快照持久化模式)，或者相反，用“always”会比较慢但比everysec要更安全。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 请查看下面的文章来获取更多的细节</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://antirez.com/post/redis-persistence-demystified.html</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果不能确定，就用 &quot;everysec&quot;</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync always</span> </span><br><span class="line">appendfsync everysec </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync no</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果AOF的同步策略设置成 <span class="string">&quot;always&quot;</span> 或者 <span class="string">&quot;everysec&quot;</span>，并且后台的存储进程（后台存储或写入AOF</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志）会产生很多磁盘I/O开销。某些Linux的配置下会使Redis因为 fsync()系统调用而阻塞很久。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意，目前对这个情况还没有完美修正，甚至不同线程的 fsync() 会阻塞我们同步的write(2)调用。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 为了缓解这个问题，可以用下面这个选项。它可以在 BGSAVE 或 BGREWRITEAOF 处理时阻止 fsync()。</span></span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这就意味着如果有子进程在进行保存操作，那么Redis就处于&quot;不可同步&quot;的状态。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这实际上是说，在最差的情况下可能会丢掉30秒钟的日志数据。（默认Linux设定）</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 如果把这个设置成&quot;yes&quot;带来了延迟问题，就保持&quot;no&quot;，这是保存持久数据的最安全的方式。</span></span> </span><br><span class="line">no-appendfsync-on-rewrite no </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动重写AOF文件</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果AOF日志文件增大到指定百分比，Redis能够通过 BGREWRITEAOF 自动重写AOF日志文件。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 工作原理：Redis记住上次重写时AOF文件的大小（如果重启后还没有写操作，就直接用启动时的AOF大 小）</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个基准大小和当前大小做比较。如果当前大小超过指定比例，就会触发重写操作。你还需要指定被重写</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志的最小尺寸，这样避免了达到指定百分比但尺寸仍然很小的情况还要重写。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 指定百分比为0会禁用AOF自动重写特性。</span></span> </span><br><span class="line">auto-aof-rewrite-percentage 100 </span><br><span class="line">auto-aof-rewrite-min-size 64mb </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################### LUA SCRIPTING ###############################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置lua脚本的最大运行时间，单位为毫秒，redis会记个<span class="built_in">log</span>，然后返回error。当一个脚本超过了最 大时限。只有SCRIPT KILL和SHUTDOWN NOSAVE可以用。第一个可以杀没有调write命令的东西。要是已 经调用了write，只能用第二个命令杀。</span> </span><br><span class="line">lua-time-limit 5000 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# SLOW LOG ###################################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是redis用于记录慢查询执行时间的日志系统。由于slowlog只保存在内存中，因此slowlog的效率很 高，完全不用担心会影响到redis的性能。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">只有query执行时间大于slowlog-log-slower-than的才会定义成慢查询，才会被slowlog进行记 录。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位是微妙</span> </span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slowlog-max-len表示慢查询最大的条数</span> </span><br><span class="line">slowlog-max-len 128 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">########################### EVENT NOTIFICATION ##############################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个功能可以让客户端通过订阅给定的频道或者模式，来获知数据库中键的变化，以及数据库中命令的执 行情况，所以在默认配置下，该功能处于关闭状态。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">notify-keyspace-events 的参数可以是以下字符的任意组合，它指定了服务器该发送哪些类型的通 知：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">K 键空间通知，所有通知以 __keyspace@__ 为前缀</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">E 键事件通知，所有通知以 __keyevent@__ 为前缀</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">g DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">$ 字符串命令的通知</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">l 列表命令的通知</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">s 集合命令的通知</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">h 哈希命令的通知</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">z 有序集合命令的通知</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">x 过期事件：每当有过期键被删除时发送</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">e 驱逐(evict)事件：每当有键因为 maxmemory 政策而被删除时发送</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A 参数 g<span class="variable">$lshzxe</span> 的别名</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入的参数中至少要有一个 K 或者 E，否则的话，不管其余的参数是什么，都不会有任何 通知被分 发。详细使用可以参考http://redis.io/topics/notifications</span> </span><br><span class="line">notify-keyspace-events &quot;&quot; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################## ADVANCED CONFIG ###############################</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单位字节:数据量小于等于hash-max-ziplist-entries的用ziplist，大于hash-max-ziplist- entries用<span class="built_in">hash</span></span> </span><br><span class="line">hash-max-ziplist-entries 512 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value大小小于等于hash-max-ziplist-value的用ziplist，大于hash-max-ziplist-value用 <span class="built_in">hash</span>。</span> </span><br><span class="line">hash-max-ziplist-value 64 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据量小于等于list-max-ziplist-entries用ziplist(压缩列表)，大于list-max-ziplist- entries用list。</span> </span><br><span class="line">list-max-ziplist-entries 512 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value大小小于等于list-max-ziplist-value的用ziplist，大于list-max-ziplist-value用 list。</span> </span><br><span class="line">list-max-ziplist-value 64 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据量小于等于set-max-intset-entries用iniset，大于set-max-intset-entries用<span class="built_in">set</span>。</span> </span><br><span class="line">set-max-intset-entries 512 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据量小于等于zset-max-ziplist-entries用ziplist，大于zset-max-ziplist-entries用 zset。</span> </span><br><span class="line">zset-max-ziplist-entries 128 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">value大小小于等于zset-max-ziplist-value用ziplist，大于zset-max-ziplist-value用 zset。</span> </span><br><span class="line">zset-max-ziplist-value 64 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基数统计的算法 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基 数</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置HyeperLogLog的字节数限制，这个值通常在0~15000之间，默认为3000，基本不超过16000。 value大小小于等于hll-sparse-max-bytes使用稀疏数据结构（sparse），大于hll-sparse-max- bytes使用稠密的数据结构（dense）。一个比16000大的value是几乎没用的，建议的value大概为 3000。如果对CPU要求不高，对空间要求较高的，建议设置到10000左右。</span> </span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重置<span class="built_in">hash</span>。 Redis将在每100毫秒时使用1毫秒的CPU时间来对redis的<span class="built_in">hash</span>表进行重新<span class="built_in">hash</span>，可以降 低内存的使用。当你的使用场景中，有非常严格的实时性需要，不能够接受Redis时不时的对请求有2毫秒 的延迟的话，把这项配置为no。如果没有这么严格的实时性要求，可以设置为<span class="built_in">yes</span>，以便能够尽可能快的释 放内存。</span> </span><br><span class="line">activerehashing yes </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于Redis服务器的输出（也就是命令的返回值）来说，其大小通常是不可控制的。有可能一个简单的命 令，能够产生体积庞大的返回数据。另外也有可能因为执行了太多命令，导致产生返回数据的速率超过了往 客户端发送的速率，这是也会导致服务器堆积大量消息，从而导致输出缓冲区越来越大，占用过多内存，甚 至导致系统崩溃。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于强制断开出于某些原因而无法以足够快的速度从服务器读取数据的客户端的连接。</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于normal client，包括monitor。第一个0表示取消hard <span class="built_in">limit</span>，第二个0和第三个0表示取消 soft <span class="built_in">limit</span>，normal client默认取消限制，因为如果没有寻问，他们是不会接收数据的。</span> </span><br><span class="line">client-output-buffer-limit normal 0 0 0 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于slave client和MONITER client，如果client-output-buffer一旦超过256mb，又或者超过 64mb持续60秒，那么服务器就会立即断开客户端连接。</span> </span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于pubsub client，如果client-output-buffer一旦超过32mb，又或者超过8mb持续60秒，那么 服务器就会立即断开客户端连接。</span> </span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis执行任务的频率</span> </span><br><span class="line">hz 10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aof rewrite过程中,是否采取增量<span class="string">&quot;文件同步&quot;</span>策略,默认为<span class="string">&quot;yes&quot;</span>,而且必须为<span class="built_in">yes</span>.</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rewrite过程中,每32M数据进行一次文件同步,这样可以减少<span class="string">&quot;aof大文件&quot;</span>写入对磁盘的操作次数.</span> </span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>

<ul>
<li>通常情况下，默认的配置足够你解决问题！</li>
<li>没有极特殊的要求，不要乱改配置！</li>
</ul>
<h3 id="3-7-Jedis"><a href="#3-7-Jedis" class="headerlink" title="3.7 Jedis"></a>3.7 Jedis</h3><p>java和redis打交道的API客户端</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-7-1-连接redis"><a href="#3-7-1-连接redis" class="headerlink" title="3.7.1 连接redis"></a>3.7.1 连接redis</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123; </span><br><span class="line">    <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>); </span><br><span class="line">    <span class="type">String</span> <span class="variable">pong</span> <span class="operator">=</span> jedis.ping(); System.out.println(<span class="string">&quot;pong = &quot;</span> + pong); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行前：</span></span><br><span class="line"><span class="comment">// 1.关闭防火墙 systemctl stop firewalld.service</span></span><br><span class="line"><span class="comment">// 2.修改redis.conf [ bind 0.0.0.0 ] 允许任何ip访问，以这个redis.conf启动redis服务 （重启redis）</span></span><br><span class="line"><span class="comment">// redis-server /opt/redis5.0.4/redis.conf</span></span><br></pre></td></tr></table></figure>

<h4 id="3-7-2-常用API"><a href="#3-7-2-常用API" class="headerlink" title="3.7.2 常用API"></a>3.7.2 常用API</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">	<span class="comment">// string </span></span><br><span class="line">	jedis.set(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;v1&quot;</span>);</span><br><span class="line">	jedis.set(<span class="string">&quot;k2&quot;</span>,<span class="string">&quot;v2&quot;</span>);</span><br><span class="line">	jedis.set(<span class="string">&quot;k3&quot;</span>,<span class="string">&quot;v3&quot;</span>);</span><br><span class="line">	Set&lt;String&gt; set = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">	Iterator&lt;String&gt; iterator = set.iterator();</span><br><span class="line">	<span class="keyword">for</span> (set.iterator();iterator.hasNext();)&#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">		System.out.println(k+<span class="string">&quot;-&gt;&quot;</span>+jedis.get(k));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">Boolean</span> <span class="variable">k2Exists</span> <span class="operator">=</span> jedis.exists(<span class="string">&quot;k2&quot;</span>);</span><br><span class="line">	<span class="comment">// 查看k2是否存在 </span></span><br><span class="line">	System.out.println(<span class="string">&quot;k2Exists = &quot;</span> + k2Exists);</span><br><span class="line">	System.out.println( jedis.ttl(<span class="string">&quot;k1&quot;</span>) );</span><br><span class="line">	<span class="comment">// 查看k1的过期时间 </span></span><br><span class="line">	jedis.mset(<span class="string">&quot;k4&quot;</span>,<span class="string">&quot;v4&quot;</span>,<span class="string">&quot;k5&quot;</span>,<span class="string">&quot;v5&quot;</span>);</span><br><span class="line">	System.out.println( jedis.mget(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;k2&quot;</span>,<span class="string">&quot;k3&quot;</span>,<span class="string">&quot;k4&quot;</span>,<span class="string">&quot;k5&quot;</span>) );</span><br><span class="line">	System.out.println(<span class="string">&quot;-------------------------------------------------------- &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">	<span class="comment">// list </span></span><br><span class="line">	jedis.lpush(<span class="string">&quot;list01&quot;</span>, <span class="string">&quot;l1&quot;</span>,<span class="string">&quot;l2&quot;</span>,<span class="string">&quot;l3&quot;</span>,<span class="string">&quot;l4&quot;</span>,<span class="string">&quot;l5&quot;</span>);</span><br><span class="line">	List&lt;String&gt; list01 = jedis.lrange(<span class="string">&quot;list01&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (String s : list01)&#123;</span><br><span class="line">		System.out.println(s);</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(<span class="string">&quot;-------------------------------------------------------- &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testSet</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">	<span class="comment">// set </span></span><br><span class="line">	jedis.sadd(<span class="string">&quot;order&quot;</span>,<span class="string">&quot;jd001&quot;</span>);</span><br><span class="line">	jedis.sadd(<span class="string">&quot;order&quot;</span>,<span class="string">&quot;jd002&quot;</span>);</span><br><span class="line">	jedis.sadd(<span class="string">&quot;order&quot;</span>,<span class="string">&quot;jd003&quot;</span>);</span><br><span class="line">	Set&lt;String&gt; order = jedis.smembers(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">	Iterator&lt;String&gt; order_iterator = order.iterator();</span><br><span class="line">	<span class="keyword">while</span>(order_iterator.hasNext())&#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> order_iterator.next();</span><br><span class="line">		System.out.println(s);</span><br><span class="line">	&#125;</span><br><span class="line">	jedis.srem(<span class="string">&quot;order&quot;</span>, <span class="string">&quot;jd002&quot;</span>);</span><br><span class="line">	System.out.println( jedis.smembers(<span class="string">&quot;order&quot;</span>).size() );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">	jedis.hset(<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;username&quot;</span>,<span class="string">&quot;james&quot;</span>);</span><br><span class="line">	System.out.println( jedis.hget(<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;username&quot;</span>) );</span><br><span class="line">	HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">	map.put(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;tom&quot;</span>);</span><br><span class="line">	map.put(<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;boy&quot;</span>);</span><br><span class="line">	map.put(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;beijing&quot;</span>);</span><br><span class="line">	map.put(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;13590875543&quot;</span>);</span><br><span class="line">	jedis.hmset(<span class="string">&quot;user2&quot;</span>, map);</span><br><span class="line">	List&lt;String&gt; list = jedis.hmget(<span class="string">&quot;user2&quot;</span>, <span class="string">&quot;username&quot;</span>, <span class="string">&quot;phone&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (String s: list)&#123;</span><br><span class="line">		System.out.println(s);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testZset</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">	jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">60d</span>, <span class="string">&quot;zs1&quot;</span>);</span><br><span class="line">	jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">70d</span>, <span class="string">&quot;zs2&quot;</span>);</span><br><span class="line">	jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">80d</span>, <span class="string">&quot;zs3&quot;</span>);</span><br><span class="line">	jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">90d</span>, <span class="string">&quot;zs4&quot;</span>);</span><br><span class="line">	Set&lt;String&gt; zset01 = jedis.zrange(<span class="string">&quot;zset01&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">	Iterator&lt;String&gt; iterator = zset01.iterator();</span><br><span class="line">	<span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">		System.out.println(s);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">Test2_API</span>().testZset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-7-3-事务"><a href="#3-7-3-事务" class="headerlink" title="3.7.3 事务"></a>3.7.3 事务</h4><ul>
<li>初始化余额和支出</li>
</ul>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> yue <span class="comment">100</span> </span><br><span class="line"><span class="keyword">set</span> <span class="comment">zhichu 0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">	<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">	<span class="type">int</span> <span class="variable">yue</span> <span class="operator">=</span> Integer.parseint( jedis.get(<span class="string">&quot;yue&quot;</span>) );</span><br><span class="line">	<span class="type">int</span> <span class="variable">zhichu</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">	jedis.watch(<span class="string">&quot;yue&quot;</span>);</span><br><span class="line">	<span class="comment">// 监控余额 </span></span><br><span class="line">	Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">	<span class="comment">// 模拟网络延迟 </span></span><br><span class="line">	<span class="keyword">if</span>(yue &lt; zhichu)&#123;</span><br><span class="line">		jedis.unwatch();</span><br><span class="line">		<span class="comment">//解除监控 </span></span><br><span class="line">		System.out.println(<span class="string">&quot;余额不足！&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="type">Transaction</span> <span class="variable">transaction</span> <span class="operator">=</span> jedis.multi();</span><br><span class="line">		<span class="comment">// 开启事务 </span></span><br><span class="line">		transaction.decrBy(<span class="string">&quot;yue&quot;</span>, zhichu);</span><br><span class="line">		<span class="comment">// 余额减少 </span></span><br><span class="line">		transaction.incrBy(<span class="string">&quot;zhichu&quot;</span>, zhichu);</span><br><span class="line">		<span class="comment">// 累计消费增加 </span></span><br><span class="line">		transaction.exec();</span><br><span class="line">		System.out.println(<span class="string">&quot;余额：&quot;</span> + jedis.get(<span class="string">&quot;yue&quot;</span>));</span><br><span class="line">		System.out.println(<span class="string">&quot;累计支出：&quot;</span> + jedis.get(<span class="string">&quot;zhichu&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>模拟网络延迟：，10秒内，进入linux修改余额为5，这样，余额&lt;支出，就会进入if</li>
</ul>
<h4 id="3-7-4-JedisPool"><a href="#3-7-4-JedisPool" class="headerlink" title="3.7.4 JedisPool"></a>3.7.4 JedisPool</h4><ul>
<li>redis的连接池技术</li>
<li>详情：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/98726.html">https://help.aliyun.com/document_detail/98726.html</a></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-pool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用单例模式进行优化</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.scripts.JD;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@BelongsProject</span>: lagou-jedis </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: GuoAn.Sun </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2020-08-05 17:46 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 单例模式优化jedis连接池 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisPoolUtil</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="title function_">JedisPoolUtil</span><span class="params">()</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">JedisPool</span> <span class="variable">jedisPool</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="comment">// 返回一个连接池 </span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> JedisPool <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="comment">// 双层检测锁（企业中用的非常频繁） </span></span><br><span class="line">		<span class="keyword">if</span>(jedisPool == <span class="literal">null</span>)&#123;</span><br><span class="line">			<span class="comment">// 第一层：检测体温 </span></span><br><span class="line">			<span class="keyword">synchronized</span> (JedisPoolUtil.class)&#123;</span><br><span class="line">				<span class="comment">// 排队进站 </span></span><br><span class="line">				<span class="keyword">if</span>(jedisPool == <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="comment">//第二层：查看健康码 </span></span><br><span class="line">					<span class="type">JedisPoolConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">					config.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">					<span class="comment">// 资源池中的最大连接数 </span></span><br><span class="line">					config.setMaxIdle(<span class="number">30</span>);</span><br><span class="line">					<span class="comment">// 资源池允许的最大空闲连接数 </span></span><br><span class="line">					config.setMaxWaitMillis(<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">					<span class="comment">// 当资源池连接用尽后，调用者 的最大等待时间（单位为毫秒）</span></span><br><span class="line">					config.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">					<span class="comment">//向资源池借用连接时是否做连接有效 性检测(业务量很大时候建议设置为false，减少一次ping的开销)</span></span><br><span class="line">					jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>( config, <span class="string">&quot;192.168.204.141&quot;</span>,<span class="number">6379</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> jedisPool;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 返回jedis对象 </span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title function_">getJedis</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(jedis == <span class="literal">null</span>)&#123;</span><br><span class="line">			jedis = getInstance().getResource();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> jedis;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@BelongsProject</span>: lagou-jedis </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: GuoAn.Sun </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2020-08-05 17:54 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 测试jedis连接池 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_JedisPool</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">Jedis</span> <span class="variable">jedis1</span> <span class="operator">=</span> JedisPoolUtil.getJedis();</span><br><span class="line">		<span class="type">Jedis</span> <span class="variable">jedis2</span> <span class="operator">=</span> JedisPoolUtil.getJedis();</span><br><span class="line">		System.out.println(jedis1==jedis2);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-8-高并发下的分布式锁"><a href="#3-8-高并发下的分布式锁" class="headerlink" title="3.8 高并发下的分布式锁"></a>3.8 高并发下的分布式锁</h3><ul>
<li>经典案例：秒杀，抢购优惠券等</li>
</ul>
<h4 id="3-8-1-搭建工程并测试单线程"><a href="#3-8-1-搭建工程并测试单线程" class="headerlink" title="3.8.1 搭建工程并测试单线程"></a>3.8.1 搭建工程并测试单线程</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">port</span>&gt;</span>8001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>run<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee </span></span></span><br><span class="line"><span class="string"><span class="tag">    http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span> <span class="attr">id</span>=<span class="string">&quot;WebApp_ID&quot;</span> <span class="attr">version</span>=<span class="string">&quot;3.1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-</span> <span class="attr">class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet</span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/spring.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot; http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans/spring-beans.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;stringRedisTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.data.redis.core.StringRedisTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hostName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;192.168.204.141&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;6379&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="meta">@Controller</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestKill</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">	<span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;kill&quot;)</span> <span class="comment">// 只能解决一个tomcat的并发问题：synchronized锁的一个进程下的线程并发，如果分布式环 境，多个进程并发，这种方案就失效了！ </span></span><br><span class="line">	<span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="keyword">synchronized</span> String <span class="title function_">kill</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 1.从redis中获取 手机的库存数量 </span></span><br><span class="line">		<span class="type">int</span> <span class="variable">phoneCount</span> <span class="operator">=</span> Integer.parseint(stringRedisTemplate.opsForValue().get(<span class="string">&quot;phone&quot;</span>));</span><br><span class="line">		<span class="comment">// 2.判断手机的数量是否够秒杀的 </span></span><br><span class="line">		<span class="keyword">if</span>(phoneCount &gt; <span class="number">0</span>)&#123;</span><br><span class="line">			phoneCount--;</span><br><span class="line">			<span class="comment">// 库存减少后，再将库存的值保存回redis </span></span><br><span class="line">			stringRedisTemplate.opsForValue().set(<span class="string">&quot;phone&quot;</span>, phoneCount+<span class="string">&quot;&quot;</span>);</span><br><span class="line">			System.out.println(<span class="string">&quot;库存-1，剩余：&quot;</span>+ phoneCount);</span><br><span class="line">		&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;库存不足！&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;over!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-8-2-高并发测试"><a href="#3-8-2-高并发测试" class="headerlink" title="3.8.2 高并发测试"></a>3.8.2 高并发测试</h4><ol>
<li>启动两次工程，端口号分别8001和8002</li>
<li>使用nginx做负载均衡</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream sga<span class="punctuation">&#123;</span> </span><br><span class="line">    server <span class="number">192.168</span><span class="number">.204</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">8001</span>; </span><br><span class="line">    server <span class="number">192.168</span><span class="number">.204</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">8002</span>; </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">server <span class="punctuation">&#123;</span> </span><br><span class="line">    listen <span class="number">80</span>; </span><br><span class="line">    server_name localhost; </span><br><span class="line">    location / <span class="punctuation">&#123;</span></span><br><span class="line"> 		proxy_pass http<span class="punctuation">:</span><span class="comment">//sga;</span></span><br><span class="line">    	root html;</span><br><span class="line">    	index index.html index.htm;</span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin<span class="regexp">/nginx -c /u</span>sr<span class="regexp">/local/</span>nginx<span class="regexp">/conf/</span>nginx.conf</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用 JMeter 模拟1秒内发出100个http请求，会发现同一个商品会被两台服务器同时抢购！</li>
</ol>
<h4 id="3-8-3-实现分布式锁的思路"><a href="#3-8-3-实现分布式锁的思路" class="headerlink" title="3.8.3 实现分布式锁的思路"></a>3.8.3 实现分布式锁的思路</h4><ol>
<li><p>因为<strong>redis****是单线程</strong>的，所以命令也就具备原子性，使用setnx命令实现锁，保存k-v</p>
<ul>
<li>如果k不存在，保存（当前线程加锁），执行完成后，删除k表示释放锁</li>
<li>如果k已存在，阻塞线程执行，表示有锁</li>
</ul>
</li>
<li><p>如果加锁成功，在执行业务代码的过程中出现异常，导致没有删除k（释放锁失败），那么就会造成死锁（后面的所有线程都无法执行）</p>
<ul>
<li>设置过期时间，例如10秒后，redis自动删除</li>
</ul>
</li>
<li><p>高并发下，由于时间段等因素导致服务器压力过大或过小，每个线程执行的时间不同</p>
<ul>
<li>第一个线程，执行需要13秒，执行到第10秒时，redis自动过期了k（释放锁）</li>
<li>第二个线程，执行需要7秒，加锁，执行第3秒（锁 被释放了，为什么，是被第一个线程的finally主动deleteKey释放掉了）</li>
<li>。。。连锁反应，当前线程刚加的锁，就被其他线程释放掉了，周而复始，导致锁会永久失效</li>
</ul>
</li>
<li><p>给每个线程加上唯一的标识UUID随机生成，释放的时候判断是否是当前的标识即可</p>
</li>
<li><p>问题又来了，过期时间如果设定？</p>
<ul>
<li>如果10秒太短不够用怎么办？</li>
<li>设置60秒，太长又浪费时间</li>
<li>可以开启一个定时器线程，当过期时间小于总过期时间的1&#x2F;3时，增长总过期时间（吃仙丹续命！）</li>
</ul>
</li>
</ol>
<p>自己实现分布式锁，太难了！</p>
<h4 id="3-8-4-Redisson"><a href="#3-8-4-Redisson" class="headerlink" title="3.8.4 Redisson"></a>3.8.4 Redisson</h4><ul>
<li>Redis 是最流行的 NoSQL 数据库解决方案之一，而 Java 是世界上最流行（注意，我没有说“最 好”）的编程语言之一。</li>
<li>虽然两者看起来很自然地在一起“工作”，但是要知道，Redis 其实并没有对 Java 提供原生支持</li>
<li>相反，作为 Java 开发人员，我们若想在程序中集成 Redis，必须使用 Redis 的第三方库。</li>
<li>而 Redisson 就是用于在 Java 程序中操作 Redis 的库，它使得我们可以在程序中轻松地使用Redis。</li>
<li>Redisson 在 java.util 中常用接口的基础上，为我们提供了一系列具有<strong>分布式特性</strong>的工具类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="meta">@Controller</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestKill</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">	<span class="keyword">private</span> Redisson redisson;</span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">	<span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;kill&quot;)</span> <span class="comment">// 只能解决一个tomcat的并发问题：synchronized锁的一个进程下的线程并发，如果分布式环 境，多个进程并发，这种方案就失效了！ </span></span><br><span class="line">	<span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="keyword">synchronized</span> String <span class="title function_">kill</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 定义商品id String productKey = &quot;HUAWEI-P40&quot;; // 通过redisson获取锁 </span></span><br><span class="line">		<span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> redisson.getLock(productKey);</span><br><span class="line">		<span class="comment">// 底层源码就是集成了setnx，过 期时间等操作// 上锁（过期时间为30秒） </span></span><br><span class="line">		rLock.lock(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">// 1.从redis中获取 手机的库存数量 </span></span><br><span class="line">			<span class="type">int</span> <span class="variable">phoneCount</span> <span class="operator">=</span> Integer.parseint(stringRedisTemplate.opsForValue().get(<span class="string">&quot;phone&quot;</span>));</span><br><span class="line">			<span class="comment">// 2.判断手机的数量是否够秒杀的 </span></span><br><span class="line">			<span class="keyword">if</span> (phoneCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				phoneCount--;</span><br><span class="line">				<span class="comment">// 库存减少后，再将库存的值保存回redis </span></span><br><span class="line">				stringRedisTemplate.opsForValue().set(<span class="string">&quot;phone&quot;</span>, phoneCount + <span class="string">&quot;&quot;</span>);</span><br><span class="line">				System.out.println(<span class="string">&quot;库存-1，剩余：&quot;</span> + phoneCount);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;库存不足！&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 释放锁 </span></span><br><span class="line">			rLock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;over!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Bean</span> </span><br><span class="line">	<span class="keyword">public</span> Redisson <span class="title function_">redisson</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">		<span class="comment">// 使用单个redis服务器 </span></span><br><span class="line">		config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.204.141:6379&quot;</span>).setDatabase (<span class="number">0</span>);</span><br><span class="line">		<span class="comment">// 使用集群redis // config.useClusterServers().setScanInterval(2000).addNodeAddress(&quot;redis://192.168 .204.141:6379&quot;,&quot;redis://192.168.204.142:6379&quot;,&quot;redis://192.168.204.143:6379&quot;); </span></span><br><span class="line">		<span class="keyword">return</span> (Redisson)Redisson.create(config);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现分布式锁的方案其实有很多，我们之前用过的zookeeper的特点就是<strong>高可靠性</strong>，现在我们用的redis特点就是<strong>高性能</strong>。</li>
<li>目前分布式锁，应用最多的仍然是“<strong>Redis</strong>”</li>
</ul>
</article><div class="tag_share"><div class="post_share"><div class="social-share" data-image="/assets/img/article/article.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/15/FastDFS%E8%AF%A6%E8%A7%A3/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/img/article/article.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">FastDFS详解</div></div></a></div><div class="next-post pull-right"><a href="/2021/06/01/zookeeper%E8%AF%A6%E8%A7%A3/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/img/article/article.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">zookeeper详解</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-text">一、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BA%92%E8%81%94%E7%BD%91%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98%E5%8E%86%E7%A8%8B"><span class="toc-text">1.1 互联网架构的演变历程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Redis%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.2 Redis入门介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Redis-Memcache-MongoDB%E5%AF%B9%E6%AF%94"><span class="toc-text">1.3 Redis&#x2F;Memcache&#x2F;MongoDB对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-Redis%E5%92%8CMemcache"><span class="toc-text">1.3.1 Redis和Memcache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-Redis%E5%92%8CMongoDB"><span class="toc-text">1.3.2 Redis和MongoDB</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93CAP%E5%8E%9F%E7%90%86"><span class="toc-text">1.4 分布式数据库CAP原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-CAP%E7%AE%80%E4%BB%8B"><span class="toc-text">1.4.1 CAP简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-CAP%E7%90%86%E8%AE%BA"><span class="toc-text">1.4.2 CAP理论</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-CAP%E6%80%BB%E7%BB%93"><span class="toc-text">1.4.3 CAP总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%8B%E8%BD%BD%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-text">二、下载与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%B8%8B%E8%BD%BD"><span class="toc-text">2.1 下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AE%89%E8%A3%85"><span class="toc-text">2.2 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%AE%89%E8%A3%85%E5%90%8E%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-text">2.3 安装后的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="toc-text">2.3.1 后台运行方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E5%85%B3%E9%97%AD%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">2.3.2 关闭数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-text">2.3.3 常用操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4-%E8%BF%9E%E6%8E%A5redis%E5%B9%B6%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3.4 连接redis并测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-5-HelloWorld"><span class="toc-text">2.3.5 HelloWorld</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-6-%E6%B5%8B%E8%AF%95%E6%80%A7%E8%83%BD"><span class="toc-text">2.3.6 测试性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-7-%E9%BB%98%E8%AE%A416%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">2.3.7 默认16个数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-8-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%AE%E7%9A%84%E6%95%B0%E9%87%8F"><span class="toc-text">2.3.8 数据库键的数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-9-%E6%B8%85%E7%A9%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">2.3.9 清空数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-10-%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%EF%BC%88key%EF%BC%89"><span class="toc-text">2.3.10 模糊查询（key）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-11-%E9%94%AE%EF%BC%88key%EF%BC%89"><span class="toc-text">2.3.11 键（key）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8Redis"><span class="toc-text">三、使用Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.1 五大数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%AD%97%E7%AC%A6%E4%B8%B2String"><span class="toc-text">3.1.1 字符串String</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E5%88%97%E8%A1%A8List"><span class="toc-text">3.1.2 列表List</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E9%9B%86%E5%90%88Set"><span class="toc-text">3.1.3 集合Set</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-%E5%93%88%E5%B8%8CHash"><span class="toc-text">3.1.4 哈希Hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-5-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88Zset"><span class="toc-text">3.1.5 有序集合Zset</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">3.3 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-RDB"><span class="toc-text">3.3.1 RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-1-%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD"><span class="toc-text">3.3.1.1 自动备份</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-2-%E6%89%8B%E5%8A%A8%E5%A4%87%E4%BB%BD"><span class="toc-text">3.3.1.2 手动备份</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-3-%E4%B8%8ERDB%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-text">3.3.1.3 与RDB相关的配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-AOF"><span class="toc-text">3.3.2 AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-1-%E5%BC%80%E5%90%AFAOF"><span class="toc-text">3.3.2.1 开启AOF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-2-%E5%85%B1%E5%AD%98%EF%BC%9F%E8%B0%81%E4%BC%98%E5%85%88%EF%BC%9F"><span class="toc-text">3.3.2.2 共存？谁优先？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-3-%E4%B8%8EAOF%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-text">3.3.2.3 与AOF相关的配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E6%80%BB%E7%BB%93%EF%BC%88%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%EF%BC%9F%EF%BC%89"><span class="toc-text">3.3.3 总结（如何选择？）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E4%BA%8B%E5%8A%A1"><span class="toc-text">3.4 事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E4%B8%80%E8%B5%B7%E7%94%9F"><span class="toc-text">3.4.1 一起生</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-%E4%B8%80%E8%B5%B7%E6%AD%BB"><span class="toc-text">3.4.2 一起死</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-%E4%B8%80%E7%B2%92%E8%80%81%E9%BC%A0%E5%B1%8E%E5%9D%8F%E4%B8%80%E9%94%85%E6%B1%A4"><span class="toc-text">3.4.3 一粒老鼠屎坏一锅汤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-4-%E5%86%A4%E6%9C%89%E5%A4%B4%E5%80%BA%E6%9C%89%E4%B8%BB"><span class="toc-text">3.4.4 冤有头债有主</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-5-watch%E7%9B%91%E6%8E%A7"><span class="toc-text">3.4.5 watch监控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Redis%E7%9A%84%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-text">3.5 Redis的发布订阅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">3.5 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-1-%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%86"><span class="toc-text">3.5.1 一主二仆</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-2-%E8%A1%80%E8%84%89%E7%9B%B8%E4%BC%A0"><span class="toc-text">3.5.2 血脉相传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-3-%E8%B0%8B%E6%9D%83%E7%AF%A1%E4%BD%8D"><span class="toc-text">3.5.3 谋权篡位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-4-%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-text">3.5.4 复制原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-5-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-text">3.5.5 哨兵模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-6-%E7%BC%BA%E7%82%B9"><span class="toc-text">3.5.6 缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E6%80%BB%E9%85%8D%E7%BD%AEredis-conf-%E8%AF%A6%E8%A7%A3"><span class="toc-text">3.6 总配置redis.conf 详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-Jedis"><span class="toc-text">3.7 Jedis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-1-%E8%BF%9E%E6%8E%A5redis"><span class="toc-text">3.7.1 连接redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-2-%E5%B8%B8%E7%94%A8API"><span class="toc-text">3.7.2 常用API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-3-%E4%BA%8B%E5%8A%A1"><span class="toc-text">3.7.3 事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-4-JedisPool"><span class="toc-text">3.7.4 JedisPool</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">3.8 高并发下的分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-1-%E6%90%AD%E5%BB%BA%E5%B7%A5%E7%A8%8B%E5%B9%B6%E6%B5%8B%E8%AF%95%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-text">3.8.1 搭建工程并测试单线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-2-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B5%8B%E8%AF%95"><span class="toc-text">3.8.2 高并发测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-3-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%80%9D%E8%B7%AF"><span class="toc-text">3.8.3 实现分布式锁的思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-4-Redisson"><span class="toc-text">3.8.4 Redisson</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2026 By 木瓜煲鸡脚</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn"><span>鄂ICP备19025079号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-min.vercel.app',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, {"avatarCDN":""}))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-min.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SpringSecurity详解 | 木瓜煲鸡脚's blog</title><meta name="author" content="木瓜煲鸡脚,1839646816@qq.com"><meta name="copyright" content="木瓜煲鸡脚"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、SpringSecurity入门1.1 Spring Security简介​	Spring Security是一个功能强大且高度可定制的身份验证和访问控制框架。它是用于保护基于 Spring的应用程序的实际标准。Spring Security是一个框架，致力于为Java应用程序提供身份验证和授权"><link rel="shortcut icon" href="/assets/img/favicon64.ico"><link rel="canonical" href="http://yournotes.cn/2022/08/25/SpringSecurity%E8%AF%A6%E8%A7%A3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?43ef74dd386a5adcc7d5e42daaa55700";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 木瓜煲鸡脚","link":"链接: ","source":"来源: 木瓜煲鸡脚's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringSecurity详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-17 16:34:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/img/hao.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">164</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-folder-open"></i><span> 说说</span></a></li><li><a class="site-page child" href="/tools/"><i class="fa-fw fa fa-wrench"></i><span> 工具</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/assets/img/article/article.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">木瓜煲鸡脚's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-folder-open"></i><span> 说说</span></a></li><li><a class="site-page child" href="/tools/"><i class="fa-fw fa fa-wrench"></i><span> 工具</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringSecurity详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2022-08-25T06:11:53.000Z" title="发表于 2022-08-25 14:11:53">2022-08-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%B0%E5%BD%95%E6%96%87%E6%A1%A3/">记录文档</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringSecurity详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/08/25/SpringSecurity%E8%AF%A6%E8%A7%A3/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、SpringSecurity入门"><a href="#一、SpringSecurity入门" class="headerlink" title="一、SpringSecurity入门"></a>一、SpringSecurity入门</h1><h2 id="1-1-Spring-Security简介"><a href="#1-1-Spring-Security简介" class="headerlink" title="1.1 Spring Security简介"></a>1.1 Spring Security简介</h2><p>​	Spring Security是一个功能强大且高度可定制的身份验证和访问控制框架。它是用于保护基于 Spring的应用程序的实际标准。Spring Security是一个框架，致力于为Java应用程序提供身份验证和授权。与所有Spring项目一样，Spring Security的真正强大之处在于可以轻松扩展以满足自定义要求.</p>
<blockquote>
<p>官网地址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>
</blockquote>
<h2 id="1-2-安全技术方案对比"><a href="#1-2-安全技术方案对比" class="headerlink" title="1.2 安全技术方案对比"></a>1.2 安全技术方案对比</h2><p>目前在整个Java开发的系统中,需要用于身份验证和访问控制框架的框架除了Spring Security, 还有一个就是Apache shiro框架.</p>
<p><strong>Shiro</strong></p>
<p>Shiro是一个强大而灵活的开源安全框架，能够非常清晰的处理认证、授权、管理会话以及密码加密。如下是它所具有的特点：</p>
<ul>
<li>易于理解的 Java Security API；</li>
<li>简单的身份认证（登录），支持多种数据源（LDAP，JDBC，Kerberos，ActiveDirectory等）</li>
<li>对角色的简单的鉴权（访问控制），支持细粒度的鉴权；</li>
<li>支持一级缓存，以提升应用程序的性能；</li>
<li>内置的基于 POJO 企业会话管理，适用于 Web 以及非 Web 的环境；</li>
<li>异构客户端会话访问；</li>
<li>非常简单的加密 API；</li>
<li>不跟任何的框架或者容器捆绑，可以独立运行。</li>
</ul>
<p><strong>Spring Security</strong></p>
<p>除了不能脱离Spring，shiro的功能它都有。而且Spring Security对Oauth、OpenID也有支持,Shiro则需要自己手动实现。Spring Security的权限细粒度更高。</p>
<blockquote>
<p>OAuth在”客户端”与”服务提供商”之间，设置了一个授权层（authorization layer）。”客户端”不能直接登录”服务提供商”，只能登录授权层，以此将用户与客户端区分开来。”客户端”登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。<br>“客户端”登录授权层以后，”服务提供商”根据令牌的权限范围和有效期，向”客户端”开放用户储存的资料。</p>
<p>OpenID 系统的第一部分是身份验证，即如何通过 URI 来认证用户身份。目前的网站都是依靠用户名和密码来登录认证，这就意味着大家在每个网站都需要注册用户名和密码，即便你使用的是同样的密码。如果使用 OpenID ，你的网站地址（URI）就是你的用户名，而你的密码安全的存储在一个 OpenID 服务网站上（你可以自己建立一个 OpenID 服务网站，也可以选择一个可信任的 OpenID 服务网站来完成注册）。<br>与OpenID同属性的身份识别服务商还有ⅥeID,ClaimID,CardSpace,Rapleaf,Trufina ID Card<br>等，其中ⅥeID通用账户的应用最为广泛</p>
</blockquote>
<h2 id="1-3-Spring-Security功能简介"><a href="#1-3-Spring-Security功能简介" class="headerlink" title="1.3 Spring Security功能简介"></a>1.3 Spring Security功能简介</h2><ol>
<li>认证: 用户登录, 解决的是”你是谁?”</li>
<li>授权: 判断用户拥有什么权限，可以访问什么资源. 解决的是”你能干什么?”</li>
<li>安全防护，防止跨站请求，session 攻击等</li>
</ol>
<h2 id="1-4-Spring-Security应用场景"><a href="#1-4-Spring-Security应用场景" class="headerlink" title="1.4 Spring Security应用场景"></a>1.4 Spring Security应用场景</h2><ol>
<li><p>用户登录, 传统基于web开发的项目的登录功能.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615110728666.png"></p>
</li>
<li><p>用户授权, 在系统中用户拥有哪些操作权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gw.alipayobjects.com/mdn/rms_08e378/afts/img/A*j5LCQabCiz8AAAAAAAAAAABkARQnAQ" alt="异常页- Ant Design"></p>
</li>
<li><p>单一登录, 一个账号只能在同一时间只能在一个地方进行登录, 如果在其他地方进行第二次登录,则剔除之前登录操作</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615130617884.png"></p>
</li>
<li><p>集成cas,做单点登录,即多个系统只需登录一次，无需重复登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615135636770.png" alt="image-20220615135636770"></p>
</li>
<li><p>集成oauth2 ,做登录授权, 可以用于app登录和第三方登录(QQ,微信等), 也可以实现cas的功能.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615135719376.png" alt="image-20220615135719376"></p>
</li>
</ol>
<h2 id="1-5-Spring-Security入门案例"><a href="#1-5-Spring-Security入门案例" class="headerlink" title="1.5 Spring Security入门案例"></a>1.5 Spring Security入门案例</h2><p><strong>快速开始</strong></p>
<h3 id="1-5-1-IDEA创建工程"><a href="#1-5-1-IDEA创建工程" class="headerlink" title="1.5.1 IDEA创建工程"></a>1.5.1 IDEA创建工程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615140801008.png" alt="image-20220615140801008"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615140909106.png" alt="image-20220615140909106"></p>
<h3 id="1-5-2-编写Controller"><a href="#1-5-2-编写Controller" class="headerlink" title="1.5.2 编写Controller"></a>1.5.2 编写Controller</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615142001064.png" alt="image-20220615142001064"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.yournotes.security_demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615141855306.png" alt="image-20220615141855306"></p>
<h3 id="1-5-3-加入Security依赖"><a href="#1-5-3-加入Security依赖" class="headerlink" title="1.5.3 加入Security依赖"></a>1.5.3 加入Security依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再次启动测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/20220615_142908.gif" alt="20220615_142908"></p>
<p>我们可以先观察下表单页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615143401026.png" alt="image-20220615143401026"></p>
<p>我们可以看到这个结构主要有三点：</p>
<ul>
<li>表单的提交方式是<code>post</code>，接口地址是<code>/login</code></li>
<li>有两个正常的<code>input</code>，且input参数名称分别是<code>username</code>和<code>password</code></li>
<li>还有一个隐藏域的<code>input</code>，参数名是<code>_csrf</code></li>
</ul>
<p>SpringBoot已经为SpringSecurity提供了默认配置，默认工程中所有资源都必须通过Security认证后才能访问。那么问题来了！此刻并没有连接数据库，也并未在内存中指定认证用户，如何认证呢？</p>
<p>其实SpringBoot已经提供了默认用户名user，密码在项目启动时随机生成，如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615144004741.png" alt="image-20220615144004741"></p>
<p>认证通过继续访问处理器资源</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/20220615_144221.gif" alt="20220615_144221"></p>
<h1 id="二、SpringSecurity认证"><a href="#二、SpringSecurity认证" class="headerlink" title="二、SpringSecurity认证"></a>二、SpringSecurity认证</h1><blockquote>
<p>说明：为方便学习，这里已经事先为准备好一个半成品的后台管理系统，而想要完善另一部分，就需要用到今天学习的内容SpringSecurity了！</p>
</blockquote>
<h2 id="2-1-下载案例"><a href="#2-1-下载案例" class="headerlink" title="2.1 下载案例"></a>2.1 下载案例</h2><p>先下载相关资源代码以及SQL：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615161612015.png" alt="image-20220615161612015"></p>
<p><strong>导入数据</strong></p>
<p>创建个数据库security_management然后导入素材当中的sql文件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615161922548.png" alt="image-20220615161922548"></p>
<p><strong>导入工程</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615165005166.png" alt="image-20220615165005166"></p>
<p><strong>启动</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615165644551.png" alt="image-20220615165644551"></p>
<h2 id="2-2-SpringSecurity认证基本原理与两种方式"><a href="#2-2-SpringSecurity认证基本原理与两种方式" class="headerlink" title="2.2 SpringSecurity认证基本原理与两种方式"></a>2.2 SpringSecurity认证基本原理与两种方式</h2><p>现在在初始项目中是没有认证的，直接进入首页。那么现在我们给它加上Security依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-过滤链介绍"><a href="#2-2-1-过滤链介绍" class="headerlink" title="2.2.1 过滤链介绍"></a>2.2.1 过滤链介绍</h3><p>在使用<code>SpringSecurity</code>框架，该框架会默认自动地替我们将系统中的资源进行保护，每次访问资源的时候都必须经过一层身份的校验，如果通过了则重定向到我们输入的url中，否则访问是要被拒绝的。那么<code>SpringSecurity</code>框架是如何实现的呢? <code>Spring Security</code>功能的实现主要是由一系列过滤器相互配合完成。也称之为过滤器链.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615170240484.png" alt="image-20220615170240484"></p>
<p>过滤器是一种典型的AOP思想，下面简单了解下这些过滤器链,后续再源码剖析中在涉及到过滤器链之后再仔细讲解.</p>
<ol>
<li><p>org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter</p>
<blockquote>
<p>根据请求封装获取WebAsyncManager，从WebAsyncManager获取&#x2F;注册的安全上下文可调用处理拦截器</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.context.SecurityContextPersistenceFilter</p>
<blockquote>
<p>SecurityContextPersistenceFilter主要是使用SecurityContextRepository在session中保存或更新一个SecurityContext，并将SecurityContext给以后的过滤器使用，来为后续fifilter建立所需的上下文。SecurityContext中存储了当前用户的认证以及权限信息。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.header.HeaderWriterFilter</p>
<blockquote>
<p>向请求的Header中添加相应的信息,可在http标签内部使用security:headers来控制</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.csrf.CsrfFilter</p>
<blockquote>
<p>csrf又称跨域请求伪造，SpringSecurity会对所有post请求验证是否包含系统生成的csrf的token信息，如果不包含，则报错。起到防止csrf攻击的效果。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.authentication.logout.LogoutFilter</p>
<blockquote>
<p>匹配URL为&#x2F;logout的请求，实现用户退出,清除认证信息。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</p>
<blockquote>
<p>表单认证操作全靠这个过滤器，默认匹配URL为&#x2F;login且必须为POST请求。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.authentication.ui.DefaultLoginPageGeneratingFilter</p>
<blockquote>
<p>如果没有在配置文件中指定认证页面，则由该过滤器生成一个默认认证页面。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.authentication.ui.DefaultLogoutPageGeneratingFilter</p>
<blockquote>
<p>由此过滤器可以生产一个默认的退出登录页面</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.authentication.<a target="_blank" rel="noopener" href="http://www.basicauthenticationfilter/">www.BasicAuthenticationFilter</a></p>
<blockquote>
<p>此过滤器会自动解析HTTP请求中头部名字为Authentication，且以Basic开头的头信息。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.savedrequest.RequestCacheAwareFilter</p>
<blockquote>
<p>通过HttpSessionRequestCache内部维护了一个RequestCache，用于缓存HttpServletRequest</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter</p>
<blockquote>
<p>针对ServletRequest进行了一次包装，使得request具有更加丰富的API</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.authentication.AnonymousAuthenticationFilter</p>
<blockquote>
<p>当SecurityContextHolder中认证信息为空,则会创建一个匿名用户存入到SecurityContextHolder中。spring security为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份。</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.session.SessionManagementFilter</p>
<blockquote>
<p>securityContextRepository限制同一用户开启多个会话的数量</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.access.ExceptionTranslationFilter</p>
<blockquote>
<p>异常转换过滤器位于整个springSecurityFilterChain的后方，用来转换整个链路中出现的异常</p>
</blockquote>
</li>
<li><p>org.springframework.security.web.access.intercept.FilterSecurityInterceptor</p>
<blockquote>
<p>获取所配置资源访问的授权信息，根据SecurityContextHolder中存储的用户信息来决定其是否有权限。</p>
</blockquote>
</li>
</ol>
<p>Spring Security默认会加载15个过滤器, 但是随着配置可以增加或者删除一些过滤器.</p>
<h2 id="2-2-2-认证方式"><a href="#2-2-2-认证方式" class="headerlink" title="2.2.2 认证方式"></a>2.2.2 认证方式</h2><p><strong>HttpBasic认证</strong></p>
<p>HttpBasic登录验证模式是Spring Security实现登录验证最简单的一种方式，也可以说是最简陋的一种方式。它的目的并不是保障登录验证的绝对安全，而是提供一种“防君子不防小人”的登录验证。</p>
<p>在使用的Spring Boot早期版本为1.X版本,依赖的Security 4.X版本，那么就无需任何配置，启动项目访问则会弹出默认的httpbasic认证。现在使用的是spring boot2.0以上版本（依赖Security5.X版本），HttpBasic不再是默认的验证模式，在spring security 5.x默认的验证模式已经是表单模式。</p>
<p>HttpBasic模式要求传输的用户名密码使用Base64模式进行加密。如果用户名是 “admin” ，密码是“ admin”,则将字符串”admin:admin” 使用Base64编码算法加密。加密结果可能是：YWtaW46YWRtaW4&#x3D;。HttpBasic模式真的是非常简单又简陋的验证模式，Base64的加密算法是可逆的,想要破解并不难.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615172055505.png" alt="image-20220615172055505"></p>
<p><strong>FormLogin认证</strong></p>
<p>Spring Security的HttpBasic模式，该模式比较简单，只是进行了通过携带Http的Header进行简单的登录验证，而且没有定制的登录页面，所以使用场景比较窄。对于一个完整的应用系统，与登录验证相关的页面都是高度定制化的，非常美观而且提供多种登录方式。这就需要Spring Security支持我们自己定制登录页面, spring boot2.0以上版本（依赖Security 5.X版本）默认会生成一个登录页面.</p>
<h2 id="2-3-表单认证"><a href="#2-3-表单认证" class="headerlink" title="2.3 表单认证"></a>2.3 表单认证</h2><h3 id="2-3-1-自定义表单登录页面"><a href="#2-3-1-自定义表单登录页面" class="headerlink" title="2.3.1 自定义表单登录页面"></a>2.3.1 自定义表单登录页面</h3><p>编写SecurityConfiguration配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">                .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">                .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动后访问会发现有问题：</p>
<p><strong>重定向次数过多</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615183617420.png" alt="image-20220615183617420"></p>
<p>原因在于我们设置了对所有请求进行认证，因此访问login.html资源时也需要进行认证而认证页 又是访问login.html因此陷入死循环。它本身的登录不需要额外配就会过滤，但我们自己指定的登录页它不会帮我们去过滤掉，我们需要手动放行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll() <span class="comment">//这个请求开允许</span></span><br><span class="line">                .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">                .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次启动</p>
<p><strong>404</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615184410172.png" alt="image-20220615184410172"></p>
<p>因为在Springboot都是请求的方式path都是找controller，它不会去资源文件去加载，我们需要配置成接口路径在接口里面返回页面。</p>
<p>在项目里面已经有了这个接口，配置文件配置了前缀templats以及后缀.html 因此返回login就可在资源文件找到页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615184643697.png" alt="image-20220615184643697"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/toLoginPage&quot;</span>).permitAll() <span class="comment">//这个请求开允许</span></span><br><span class="line">                .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">                .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改后再次启动，这次会出现样式丢失的问题</p>
<p><strong>样式丢失</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220615185118914.png" alt="image-20220615185118914"></p>
<p>这个很显然就是这些资源请求被拦截的问题，我们需要在Security配置当中通过WebSecurity去忽略指定的内容不参与安全控制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/toLoginPage&quot;</span>).permitAll() <span class="comment">//这个请求开允许</span></span><br><span class="line">                .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">                .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/favicon.ico&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring Security中，安全构建器HttpSecurity和WebSecurity的区别是 :</p>
<ul>
<li>WebSecurity不仅通过HttpSecurity定义某些请求的安全控制，也通过其他方式定义其他某些请求可以忽略安全控制;</li>
<li>HttpSecurity仅用于定义需要安全控制的请求(当然HttpSecurity也可以指定某些请求不需要安全控制);</li>
<li>可以认为HttpSecurity是WebSecurity的一部分，WebSecurity是包含HttpSecurity的更大的一个概念;</li>
<li>构建目标不同<ul>
<li>WebSecurity构建目标是整个Spring Security安全过滤器FilterChainProxy,</li>
<li>HttpSecurity的构建目标仅仅是FilterChainProxy中的一个SecurityFilterChain。</li>
</ul>
</li>
</ul>
<h3 id="2-3-2-表单登录"><a href="#2-3-2-表单登录" class="headerlink" title="2.3.2 表单登录"></a>2.3.2 表单登录</h3><p>在上面过滤器链中我们知道有一个过滤器叫做UsernamePasswordAuthenticationFilter是处理表单登录的，那么现在来观察一下这个过滤器。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220621141816713.png" alt="image-20220621141816713"></p>
<p>在源码当中可以看到，表单中两个input的name分别是username和password参数，路径为&#x2F;login，方式是POST。这些都可以修改为自定义的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 登录接口url</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;username&quot;</span>).passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义表单name</span></span><br><span class="line">                .successForwardUrl(<span class="string">&quot;/&quot;</span>)    <span class="comment">//登录成功跳转</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/toLoginPage&quot;</span>).permitAll() <span class="comment">//这个请求开允许</span></span><br><span class="line">                .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">                .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">        <span class="comment">// 关闭scrf防护</span></span><br><span class="line">        http.csrf().disable();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>后端关于login接口的参数、路径、类型定义好后，那么自定义页面进行对应的请求即可。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220621144637763.png" alt="image-20220621144637763"></p>
<p>配置完成重启进行登录用户名user、密码在后端控制台生成</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220621145850528.png" alt="image-20220621145850528"></p>
<p>登录完成发现还是有新问题，里面的内容是拒绝请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220621145757379.png" alt="image-20220621145757379"></p>
<p>问题在于，在首页最下面使用了iframe</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220621150150568.png" alt="image-20220621150150568"></p>
<p>发现行内框架iframe这里出现问题了. Spring Security下，X-Frame-Options默认为DENY，其实非Spring<br>Security环境下，X-Frame-Options的默认大多也是DENY，这种情况下，浏览器拒绝当前页面加载任何<br>Frame页面，设置含义如下：</p>
<ul>
<li>DENY：浏览器拒绝当前页面加载任何Frame页面 此选择是默认的.</li>
<li>SAMEORIGIN：frame页面的地址只能为同源域名下的页面</li>
</ul>
<p>那么需要响应时需要允许iframe的加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">        .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 登录接口url</span></span><br><span class="line">        .usernameParameter(<span class="string">&quot;username&quot;</span>).passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义表单name</span></span><br><span class="line">        .successForwardUrl(<span class="string">&quot;/&quot;</span>)    <span class="comment">//登录成功跳转</span></span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">        .antMatchers(<span class="string">&quot;/toLoginPage&quot;</span>).permitAll() <span class="comment">//这个请求开允许</span></span><br><span class="line">        .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">        .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">    <span class="comment">// 关闭scrf防护</span></span><br><span class="line">    http.csrf().disable();</span><br><span class="line">    <span class="comment">// 允许iframe加载页面</span></span><br><span class="line">    http.headers().frameOptions().sameOrigin();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-3-基于数据库实现认证功能"><a href="#2-3-3-基于数据库实现认证功能" class="headerlink" title="2.3.3 基于数据库实现认证功能"></a>2.3.3 基于数据库实现认证功能</h3><p>目前认证使用的是默认的用户名user以及自动生成打印在控制台的秘密，那么现在要将用户凭证配置在数据库。</p>
<p>实现这样的功能就需要实现security当中的UserDetailsService接口，重写里面的loadUserByUsername进行自定义校验即可。</p>
<p>方法传进来的参数是用户名，拿去用自己的service去数据库查处用户实体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">user</span> <span class="operator">=</span> userService.findByUsername(s);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;没有找到这个用户名:&quot;</span>+s);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 先声明一个权限集合,构造函数必须传值且不能为null,传个空集合即可</span></span><br><span class="line">        Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 需要返回一个SpringSecurity的UserDetails对象</span></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">                user.getUsername(),      <span class="comment">// 用户名</span></span><br><span class="line">                <span class="string">&quot;&#123;noop&#125;&quot;</span>+user.getPassword(), <span class="comment">//密码&#123;noop&#125;表示不加密</span></span><br><span class="line">                <span class="literal">true</span>,            <span class="comment">// 用户是否启用 true启用</span></span><br><span class="line">                <span class="literal">true</span>,    <span class="comment">// 用户是否过期 true没过期</span></span><br><span class="line">                <span class="literal">true</span>,  <span class="comment">// 用户凭证是否过期 true没过期</span></span><br><span class="line">                <span class="literal">true</span>,    <span class="comment">// 是否锁定 true未锁定</span></span><br><span class="line">                authorities</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> userDetails;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义好我们的认证逻辑后，将这个逻辑配置到Security当中，一样还是<code>在SecurityConfiguration</code>的configure重载方法进行配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.userDetailsService(myUserDetailsService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-4-密码加密认证"><a href="#2-3-4-密码加密认证" class="headerlink" title="2.3.4 密码加密认证"></a>2.3.4 密码加密认证</h3><p>在基于数据库完成用户登录过程中，我们使用的密码是明文，给出UserDetails时密码使用了<code>&#123;noop&#125;</code>进行标记。那么下面对SpringSecurity中密码编码进行一些探讨。</p>
<p>SpringSecurity当中PasswordEncoder就是对我们密码进行编码的工具接口。该接口有两个功能：一个是<strong>匹配验证</strong>。另一个是<strong>密码编码</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624121053806.png" alt="image-20220624121053806"></p>
<p><strong>BCrypt算法介绍</strong></p>
<p>任何应用考虑到安全，绝不能明文的方式保存密码。密码应该通过哈希算法进行加密。 有很多标准的算法比如SHA或者MD5，结合salt(盐)是一个不错的选择。 Spring Security 提供了BCryptPasswordEncoder类,实现Spring的PasswordEncoder接口使用BCrypt强哈希方法来加密密码。BCrypt强哈希方法 每次加密的结果都不一样,所以更加的安全。</p>
<p>bcrypt算法相对来说是运算比较慢的算法，在密码学界有句常话：越慢的算法越安全。黑客破解成本越高.通过salt和const这两个值来减缓加密过程，它的加密时间（百ms级）远远超过md5（大概1ms左右）。对于计算机来说，Bcrypt 的计算速度很慢，但是对于用户来说，这个过程不算慢。bcrypt是单向的，而且经过salt和cost的处理，使其受攻击破解的概率大大降低，同时破解的难度也提升不少，相对于MD5等加密方式更加安全，而且使用也比较简单</p>
<p>bcrypt加密后的字符串形如：<code>$2a$10$wouq9P/HNgvYj2jKtUN8rOJJNRVCWvn1XoWy55N3sCkEHZPo3lyWq</code></p>
<blockquote>
<p>其中$是分割符，无意义；2a是bcrypt加密版本号；10是const的值；而后的前22位是salt值；再然后的字符串就是密码的密文了；这里的const值即生成salt的迭代次数，默认值是10，推荐值12。</p>
</blockquote>
<p><strong>在项目中使用BCrypt</strong></p>
<p>PasswordEncoder有很多实现类因此是提供了工厂方法模式去创建，通过指定不同的参数得到不同的<code>具体编码器</code></p>
<p>此工厂类是PasswordEncoderFactories</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624125222715.png" alt="image-20220624125222715"></p>
<p>之前我们在项目中密码使用的是明文的是<code>noop</code> , 代表不加密使用明文密码, 现在用<code>BCrypt</code>只需要将<code>noop</code> 换成<code>bcrypt</code> 即可</p>
<p><code>&#123;noop&#125;</code> 改成 <code>&#123;bcrypt&#125;</code> 后也记得要将数据库的密码改为加密后的密码，否则在认证时对数据库密码进行解密就对不上了。</p>
<p>既然我们指定了<code>&#123;bcrypt&#125;</code> ，那就看看bcrypt编码器对指定的密码进行加密的结果，复制到数据库即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624130752568.png" alt="image-20220624130752568"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624133303944.png" alt="image-20220624133303944"></p>
<p><strong>登录成功</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/20220624_133148.gif" alt="20220624_133148"></p>
<h3 id="2-3-5-获取当前登录用户"><a href="#2-3-5-获取当前登录用户" class="headerlink" title="2.3.5 获取当前登录用户"></a>2.3.5 获取当前登录用户</h3><p>在传统web系统中, 我们将登录成功的用户放入session中, 在需要的时候可以从session中获取用户,那么Spring Security中我们如何获取当前已经登录的用户呢?</p>
<ul>
<li><p>SecurityContextHolder</p>
<p>保留系统当前的安全上下文SecurityContext，其中就包括当前使用系统的用户信息。</p>
</li>
<li><p>SecurityContext</p>
<p>安全上下文，获取当前经过身份验证的主体或者身份验证请求令牌</p>
</li>
</ul>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/loginUser&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">getCurrentUser</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> (UserDetails)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了上述方法, Spring Security 还提供了2种方式可以获取.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/loginUser01&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">getCurrentUser</span><span class="params">(Authentication auth)</span>&#123;</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> (UserDetails)auth.getContext().getAuthentication().getPrincipal();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/loginUser02&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">getCurrentUser</span><span class="params">(getCurrentUser(<span class="meta">@AuthenticationPrincipal</span> UserDetails userDetails)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-6-remember-me-记住我"><a href="#2-3-6-remember-me-记住我" class="headerlink" title="2.3.6 remember me 记住我"></a>2.3.6 remember me 记住我</h3><p>在大多数网站中，都会实现RememberMe这个功能，方便用户在下一次登录时直接登录，避免再次输入用户名以及密码去登录,Spring Security针对这个功能已经帮助我们实现。</p>
<p>下面我们来看下他的原理图：</p>
<h4 id="2-3-6-1-简单生成Token方法"><a href="#2-3-6-1-简单生成Token方法" class="headerlink" title="2.3.6.1 简单生成Token方法"></a>2.3.6.1 简单生成Token方法</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624134742201.png" alt="image-20220624134742201"></p>
<p>Token&#x3D;MD5(username+分隔符+expiryTime+分隔符+password)</p>
<p><strong>注意: 这种方式不推荐使用, 有严重的安全问题. 就是密码信息在前端浏览器cookie中存放. 如果cookie</strong><br><strong>被盗取很容易破解.</strong></p>
<p><strong>代码实现：</strong></p>
<ol>
<li><p>前端的选框按钮</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--记住我 name为remember-me value值可选true yes 1 on 都行--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span>记住我</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>后端开启remember-me功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.and().rememberMe()<span class="comment">//开启记住我功能</span></span><br><span class="line">.tokenValiditySeconds(<span class="number">1209600</span>)<span class="comment">// token失效时间默认2周</span></span><br><span class="line">.rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)<span class="comment">// 自定义表单name值</span></span><br></pre></td></tr></table></figure>

<p>登录接口配置上面一段即可开启</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">        .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 登录接口url</span></span><br><span class="line">        .usernameParameter(<span class="string">&quot;username&quot;</span>).passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义表单name</span></span><br><span class="line">        .successForwardUrl(<span class="string">&quot;/&quot;</span>)    <span class="comment">//登录成功跳转</span></span><br><span class="line">        .and().rememberMe()<span class="comment">//开启记住我功能</span></span><br><span class="line">        .tokenValiditySeconds(<span class="number">1209600</span>)<span class="comment">// token失效时间默认2周</span></span><br><span class="line">        .rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)<span class="comment">// 自定义表单name值</span></span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()       <span class="comment">// 选择哪些请求</span></span><br><span class="line">        .antMatchers(<span class="string">&quot;/toLoginPage&quot;</span>).permitAll() <span class="comment">//这个请求开允许</span></span><br><span class="line">        .anyRequest()              <span class="comment">// 任意请求</span></span><br><span class="line">        .authenticated();          <span class="comment">// 选择的请求请求需要认证</span></span><br><span class="line">    <span class="comment">// 关闭scrf防护</span></span><br><span class="line">    http.csrf().disable();</span><br><span class="line">    <span class="comment">// 允许iframe加载页面</span></span><br><span class="line">    http.headers().frameOptions().sameOrigin();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录成功产生一条cookie<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624144507496.png" alt="image-20220624144507496"></p>
</li>
</ol>
<h4 id="2-3-6-2-持久化的Token生成方法"><a href="#2-3-6-2-持久化的Token生成方法" class="headerlink" title="2.3.6.2 持久化的Token生成方法"></a>2.3.6.2 持久化的Token生成方法</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624144745432.png" alt="image-20220624144745432"></p>
<p>存入数据库的Token包含：</p>
<p>token: 随机生成策略,每次访问都会重新生成</p>
<p>series: 登录序列号，随机生成策略。用户输入用户名和密码登录时，该值重新生成。使用remember-me功能，该值保持不变</p>
<p>expiryTime: token过期时间。</p>
<p>Token &#x3D; encode(series+token)</p>
<p><strong>代码实现</strong></p>
<ol>
<li><p>后端配置</p>
<p>同样也是在SecurityConfiguration进行配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.and().rememberMe()<span class="comment">//开启记住我功能</span></span><br><span class="line">.tokenValiditySeconds(<span class="number">1209600</span>)<span class="comment">// token失效时间默认2周</span></span><br><span class="line">.rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)<span class="comment">// 自定义表单name值</span></span><br><span class="line">.tokenRepository(getPersistentTokenRepository()) <span class="comment">//设置token的存储库</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DataSource dataSource;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 持久化token,负责token与数据库之间的相关操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> PersistentTokenRepository <span class="title function_">getPersistentTokenRepository</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">tokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">    tokenRepository.setDataSource(dataSource); <span class="comment">//设置数据源</span></span><br><span class="line">    <span class="comment">// 启动时创建一张表, 第一次启动的时候创建, 第二次启动的时候需要注释掉, 否会保存</span></span><br><span class="line">    tokenRepository.setCreateTableOnStartup(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> tokenRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624150903356-16560556187322.png" alt="image-20220624150903356"></p>
<p>表已创建就可以把 <code>tokenRepository.setCreateTableOnStartup(true)</code>去掉了</p>
<p>启动项目重新登录，数据库会插入记录。说明持久化token方式已经生效。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624151059011.png" alt="image-20220624151059011"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624151438664.png" alt="image-20220624151438664"></p>
</li>
<li><p>Cookie窃取伪造访问</p>
<p>使用网页登录系统，记录remember-me的值</p>
<p>在postman伪造cookie，进行请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624161437398.png" alt="image-20220624161437398"></p>
<p>可以正常访问，而不是拦截到登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624162530909.png" alt="image-20220624162530909"></p>
</li>
<li><p>安全验证</p>
<p>如果要禁止是<code>记住我</code>的token进行访问，可以进行控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UserVo <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="comment">//获取认证信息</span></span><br><span class="line">    <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="comment">// 判断认证信息是否来源于RememberMe</span></span><br><span class="line">    <span class="keyword">if</span> (RememberMeAuthenticationToken.class.isAssignableFrom(authentication.getClass())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RememberMeAuthenticationException</span>(<span class="string">&quot;认证信息来源于 RememberMe,请重新登录&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">UserVo</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(id);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624162807782.png" alt="image-20220624162807782"></p>
<p>所以在重要的步骤我们可以加以控制<code>记住我</code>的访问</p>
</li>
</ol>
<h3 id="2-3-7-自定义登录状态处理"><a href="#2-3-7-自定义登录状态处理" class="headerlink" title="2.3.7 自定义登录状态处理"></a>2.3.7 自定义登录状态处理</h3><p>在某些场景下,用户登录成功或失败的情况下用户需要执行一些后续操作,比如登录日志的搜集,或者在现在目前前后端分离的情况下用户登录成功和失败后需要给前台页面返回对应的错误信息, 有前台主导登录成功或者失败的页面跳转.这个时候需要要到用到AuthenticationSuccessHandler与AnthenticationFailureHandler.</p>
<ul>
<li>实现AuthenticationSuccessHandler接口，并重写onAnthenticationSuccesss()方法.</li>
<li>实现AuthenticationFailureHandler接口，并重写onAuthenticationFailure()方法；</li>
</ul>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthHandle</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span>, AuthenticationFailureHandler &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">RedirectStrategy</span> <span class="variable">redirectStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultRedirectStrategy</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;登录成功后续处理....&quot;</span>);</span><br><span class="line">        <span class="comment">//重定向到index页</span></span><br><span class="line">        redirectStrategy.sendRedirect(request, response, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;登录失败后续处理....&quot;</span>);</span><br><span class="line">        <span class="comment">//重定向到login页</span></span><br><span class="line">        redirectStrategy.sendRedirect(request, response, <span class="string">&quot;/toLoginPage&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在SecurityConfiguration配置上这些自定义处理</p>
<p>配置在登录表单后即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">    .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)     <span class="comment">// 自定义登录页</span></span><br><span class="line">    .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)  <span class="comment">// 登录接口url</span></span><br><span class="line">    .usernameParameter(<span class="string">&quot;username&quot;</span>).passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义表单name</span></span><br><span class="line">    .successForwardUrl(<span class="string">&quot;/&quot;</span>)        <span class="comment">//登录成功跳转</span></span><br><span class="line">    .successHandler(myAuthHandle)</span><br><span class="line">    .failureHandler(myAuthHandle)</span><br><span class="line">    <span class="comment">// 略...</span></span><br></pre></td></tr></table></figure>



<p>除了登录成功登陆失败这些节点还有其他的很多节点都可以进行自定义处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">.formLogin()  <span class="comment">//开启登录</span></span><br><span class="line">.permitAll()  <span class="comment">//允许所有人访问</span></span><br><span class="line">.successHandler(myAuthHandle) <span class="comment">// 登录成功逻辑处理</span></span><br><span class="line">.failureHandler(myAuthHandle) <span class="comment">// 登录失败逻辑处理</span></span><br><span class="line"></span><br><span class="line">.and()</span><br><span class="line">.logout()   <span class="comment">//开启注销</span></span><br><span class="line">.permitAll()    <span class="comment">//允许所有人访问</span></span><br><span class="line">.logoutSuccessHandler(myAuthHandle) <span class="comment">//注销逻辑处理</span></span><br><span class="line">.deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>)    <span class="comment">//删除cookie</span></span><br><span class="line"></span><br><span class="line">.and().exceptionHandling()</span><br><span class="line">.accessDeniedHandler(myAuthHandle)    <span class="comment">//权限不足的时候的逻辑处理</span></span><br><span class="line">.authenticationEntryPoint(myAuthHandle)  <span class="comment">//未登录是的逻辑处理</span></span><br></pre></td></tr></table></figure>

<p>各阶段处理器列举几个</p>
<table>
<thead>
<tr>
<th>阶段</th>
<th>实现接口</th>
<th>重写方法</th>
</tr>
</thead>
<tbody><tr>
<td>登录成功时</td>
<td>AuthenticationSuccessHandler</td>
<td>onAnthenticationSuccesss()</td>
</tr>
<tr>
<td>登录失败时</td>
<td>AuthenticationFailureHandler</td>
<td>onAuthenticationFailure()</td>
</tr>
<tr>
<td>注销成功时</td>
<td>LogoutSuccessHandler</td>
<td>onLogoutSuccess()</td>
</tr>
<tr>
<td>没有权限时</td>
<td>AccessDeniedHandler</td>
<td>handle()</td>
</tr>
<tr>
<td>没有登录时</td>
<td>AuthenticationEntryPoint</td>
<td>commence()</td>
</tr>
</tbody></table>
<p>向上面不是一个前后端分离的例子，如果前后的分离结合这些自定义处理器就可以实现，比如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//登录成功时返回给前端的数据</span></span><br><span class="line">    <span class="type">ApiResult</span> <span class="variable">result</span> <span class="operator">=</span> ApiResult.result(ApiCode.SUCCESS, <span class="string">&quot;登录成功&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">    response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ApiResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(e <span class="keyword">instanceof</span> UsernameNotFoundException)&#123;</span><br><span class="line">        result = ApiResult.result(ApiCode.FAIL_AUTH,<span class="string">&quot;用户名找不到&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> BadCredentialsException)&#123;</span><br><span class="line">        result = ApiResult.result(ApiCode.FAIL_AUTH,<span class="string">&quot;密码错误&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        result = ApiResult.fail(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理编码方式，防止中文乱码的情况</span></span><br><span class="line">    response.setContentType(<span class="string">&quot;text/json;charset=utf-8&quot;</span>);</span><br><span class="line">    <span class="comment">//返回给前台</span></span><br><span class="line">    response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>就不一一举例了，实现接口重写好方法，在SecurityConfiguration进行配置即可</p>
<h2 id="2-4-图形验证码"><a href="#2-4-图形验证码" class="headerlink" title="2.4 图形验证码"></a>2.4 图形验证码</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">图形验证码一般是防止恶意，人眼看起来都费劲，何况是机器。不少网站为了防止用户利用机器人自动注册、登录、灌水，都采用了验证码技术。所谓验证码，就是将一串随机产生的数字或符号，生成一幅图片， 图片里加上一些干扰,。也有目前需要手动滑动的图形验证码，这种可以有专门去做的第三方平台.：比如极验(https://www.geetest.com/), 这里介绍的主要针对图形验证码。</span><br></pre></td></tr></table></figure>

<p>Spring Security添加验证码大致可以分为三个步骤：</p>
<ol>
<li>根据随机数生成验证码图片</li>
<li>将验证码图片显示到登录页面</li>
<li>认证流中加入验证码校验</li>
</ol>
<p>Spring Security的认证校验是由UsernamePasswordAuthenticationFilter过滤器完成的，所以我们的验证码校验逻辑应该在这个过滤器之前。验证码通过后才能到后续的操作. 流程如下:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220624173343774.png" alt="image-20220624173343774"></p>
<p>代码实现：</p>
<ul>
<li><p>自定义验证码过滤器ValidateCodeFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.yournotes.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.yournotes.controller.ValidateCodeController;</span><br><span class="line"><span class="keyword">import</span> cn.yournotes.exception.ValidateCodeException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.ServletRequestBindingException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码验证filter 需要继承OncePerRequestFilter确保在一次请求只通过一次filter，而不</span></span><br><span class="line"><span class="comment"> * 需要重复执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidateCodeFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyAuthHandle myAuthHandle;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 判断是否是登录请求,只有登录请求才去校验验证码</span></span><br><span class="line">        <span class="keyword">if</span> (httpServletRequest.getRequestURI().equals(<span class="string">&quot;/login&quot;</span>) &amp;&amp; httpServletRequest.getMethod().equalsIgnoreCase(<span class="string">&quot;post&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                validate(httpServletRequest);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ValidateCodeException e) &#123;</span><br><span class="line">                myAuthHandle.onAuthenticationFailure(httpServletRequest, httpServletResponse, e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果不是登录请求，直接调用后面的过滤器链</span></span><br><span class="line">        filterChain.doFilter(httpServletRequest, httpServletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> ValidateCodeException &#123;</span><br><span class="line">        <span class="comment">//获取ip</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteAddr</span> <span class="operator">=</span> request.getRemoteAddr();</span><br><span class="line">        <span class="comment">//拼接redis的key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> ValidateCodeController.REDIS_KEY_IMAGE_CODE + <span class="string">&quot;-&quot;</span> + remoteAddr;</span><br><span class="line">        <span class="comment">//从redis中获取imageCode</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisImageCode</span> <span class="operator">=</span> stringRedisTemplate.boundValueOps(redisKey).get();</span><br><span class="line">        <span class="type">String</span> <span class="variable">imageCode</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;imageCode&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(imageCode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidateCodeException</span>(<span class="string">&quot;验证码的值不能为空！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisImageCode == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidateCodeException</span>(<span class="string">&quot;验证码已过期！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisImageCode.equals(imageCode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidateCodeException</span>(<span class="string">&quot;验证码不正确！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从redis中删除imageCode</span></span><br><span class="line">        stringRedisTemplate.delete(redisKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidateCodeException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ValidateCodeException</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证码生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.yournotes.domain.ImageCode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理生成验证码的请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidateCodeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">REDIS_KEY_IMAGE_CODE</span> <span class="operator">=</span> <span class="string">&quot;REDIS_KEY_IMAGE_CODE&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">expireIn</span> <span class="operator">=</span> <span class="number">60</span>;  <span class="comment">// 验证码有效时间 60s</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用sessionStrategy将生成的验证码对象存储到Session中，并通过IO流将生成的图片输出到登录页面上。</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/image&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//获取访问IP</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteAddr</span> <span class="operator">=</span> request.getRemoteAddr();</span><br><span class="line">        <span class="comment">//生成验证码对象</span></span><br><span class="line">        <span class="type">ImageCode</span> <span class="variable">imageCode</span> <span class="operator">=</span> createImageCode();</span><br><span class="line">        <span class="comment">//生成的验证码对象存储到redis中 KEY为REDIS_KEY_IMAGE_CODE+IP地址</span></span><br><span class="line">        stringRedisTemplate.boundValueOps(REDIS_KEY_IMAGE_CODE + <span class="string">&quot;-&quot;</span> + remoteAddr)</span><br><span class="line">                .set(imageCode.getCode(), expireIn, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//通过IO流将生成的图片输出到登录页面上</span></span><br><span class="line">        ImageIO.write(imageCode.getImage(), <span class="string">&quot;jpeg&quot;</span>, response.getOutputStream());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于生成验证码对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ImageCode <span class="title function_">createImageCode</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> <span class="number">100</span>;    <span class="comment">// 验证码图片宽度</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> <span class="number">36</span>;    <span class="comment">// 验证码图片长度</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> <span class="number">4</span>;     <span class="comment">// 验证码位数</span></span><br><span class="line">        <span class="comment">//创建一个带缓冲区图像对象</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        <span class="comment">//获得在图像上绘图的Graphics对象</span></span><br><span class="line">        <span class="type">Graphics</span> <span class="variable">g</span> <span class="operator">=</span> image.getGraphics();</span><br><span class="line"></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置颜色、并随机绘制直线</span></span><br><span class="line">        g.setColor(getRandColor(<span class="number">200</span>, <span class="number">250</span>));</span><br><span class="line">        g.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        g.setFont(<span class="keyword">new</span> <span class="title class_">Font</span>(<span class="string">&quot;Times New Roman&quot;</span>, Font.ITALIC, <span class="number">20</span>));</span><br><span class="line">        g.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">155</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(width);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(height);</span><br><span class="line">            <span class="type">int</span> <span class="variable">xl</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">yl</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>);</span><br><span class="line">            g.drawLine(x, y, x + xl, y + yl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成随机数 并绘制</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sRand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">rand</span> <span class="operator">=</span> String.valueOf(random.nextInt(<span class="number">10</span>));</span><br><span class="line">            sRand.append(rand);</span><br><span class="line">            g.setColor(<span class="keyword">new</span> <span class="title class_">Color</span>(<span class="number">20</span> + random.nextInt(<span class="number">110</span>), <span class="number">20</span> + random.nextInt(<span class="number">110</span>), <span class="number">20</span> + random.nextInt(<span class="number">110</span>)));</span><br><span class="line">            g.drawString(rand, <span class="number">13</span> * i + <span class="number">6</span>, <span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        g.dispose();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImageCode</span>(image, sRand.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取随机演示</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Color <span class="title function_">getRandColor</span><span class="params">(<span class="type">int</span> fc, <span class="type">int</span> bc)</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">if</span> (fc &gt; <span class="number">255</span>) &#123;</span><br><span class="line">            fc = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bc &gt; <span class="number">255</span>) &#123;</span><br><span class="line">            bc = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">g</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>(r, g, b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>security配置</p>
<p>需要配置两个东西，一个是在UsernamePasswordAuthenticationFilter之前需要加一个过滤器进行验证码处理，第二是放行验证码接口让前端请求显示。<code>记得把验证码接口地址放到html图片验证码处、redis也配置好</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(validateCodeFilter,UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">http.formLogin()                   <span class="comment">// 开启formLogin认证</span></span><br><span class="line">    .loginPage(<span class="string">&quot;/toLoginPage&quot;</span>)  <span class="comment">// 自定义登录页</span></span><br><span class="line">    .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 登录接口url</span></span><br><span class="line">    .usernameParameter(<span class="string">&quot;username&quot;</span>).passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">//自定义表单name</span></span><br><span class="line">    .successForwardUrl(<span class="string">&quot;/&quot;</span>)    <span class="comment">//登录成功跳转</span></span><br><span class="line">    .successHandler(myAuthHandle)</span><br><span class="line">    .failureHandler(myAuthHandle)</span><br><span class="line">    .and().logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>)<span class="comment">//设置退出url</span></span><br><span class="line">    .logoutSuccessHandler(myAuthHandle)<span class="comment">//自定义退出处理</span></span><br><span class="line">    .and().authorizeRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/toLoginPage&quot;</span>,<span class="string">&quot;/code/**&quot;</span>).permitAll()</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-5-session管理"><a href="#2-5-session管理" class="headerlink" title="2.5 session管理"></a>2.5 session管理</h2><p>Spring Security可以与Spring Session库配合使用，只需要做一些简单的配置就可以实现一些功能，如(会话过期、一个账号只能同时在线一个、集群session等)</p>
<h3 id="2-5-1-会话超时"><a href="#2-5-1-会话超时" class="headerlink" title="2.5.1 会话超时"></a>2.5.1 会话超时</h3><ol>
<li><p>配置session会话超时时间，默认为30分钟，我们设置短些进行测试，但最小只能设置60s</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session设置</span></span><br><span class="line"><span class="comment"># 当session超时后, 默认跳转到登录页面.</span></span><br><span class="line"><span class="comment"># 配置session超时时间</span></span><br><span class="line"><span class="attr">server.servlet.session.timeout</span>=<span class="string">60</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义设置session超时后地址</p>
<p>设置session管理和失效后跳转地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置session管理</span></span><br><span class="line"><span class="comment">// session无效后跳转的路径,默认是登录页面。</span></span><br><span class="line"><span class="comment">// 前后的分离的话就不需要配置这些跳转的相关配置了</span></span><br><span class="line">http.sessionManagement().invalidSessionUrl(<span class="string">&quot;/toLoginPage&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-5-2-并发控制"><a href="#2-5-2-并发控制" class="headerlink" title="2.5.2 并发控制"></a>2.5.2 并发控制</h3><p>​	并发控制即同一个账号同时在线个数,同一个账号同时在线个数如果设置为1表示，该账号在同一时间内只能有一个有效的登录，如果同一个账号又在其它地方登录，那么就将上次登录的会话过期，即后面的登录会踢掉前面的登录</p>
<ol>
<li><p>修改超时时间</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#session设置</span></span><br><span class="line"><span class="comment">#配置session超时时间</span></span><br><span class="line"><span class="attr">server.servlet.session.timeout</span>=<span class="string">600</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置最大会话数量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement()<span class="comment">//设置session管理</span></span><br><span class="line">    .invalidSessionUrl(<span class="string">&quot;/toLoginPage&quot;</span>)<span class="comment">// session无效后跳转的路径, 默认是登录页面</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)<span class="comment">//设置session最大会话数量 ,1同一时间只能有一个用户登录</span></span><br><span class="line">    .expiredUrl(<span class="string">&quot;/toLoginPage&quot;</span>);<span class="comment">//设置session过期后跳转路径</span></span><br></pre></td></tr></table></figure>

<p>使用第二个浏览器再进行登录时 ，第一个浏览器会失去登录信息访问会进入登录页</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220626091030598.png" alt="image-20220626091030598"></p>
</li>
<li><p>阻止用户第二次登录</p>
<p>sessionManagement也可以配置 maxSessionsPreventsLogin：boolean值，当达到maximumSessions设置的最大会话个数时阻止登录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement()<span class="comment">//设置session管理</span></span><br><span class="line">    .invalidSessionUrl(<span class="string">&quot;/toLoginPage&quot;</span>)<span class="comment">// session无效后跳转的路径, 默认是登录页面</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)<span class="comment">//设置session最大会话数量 ,1同一时间只能有一个用户登录</span></span><br><span class="line">    .expiredUrl(<span class="string">&quot;/toLoginPage&quot;</span>);<span class="comment">//设置session过期后跳转路径</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-5-3-集群session"><a href="#2-5-3-集群session" class="headerlink" title="2.5.3 集群session"></a>2.5.3 集群session</h3><pre><code>实际场景中一个服务会至少有两台服务器在提供服务，在服务器前面会有一个nginx做负载均衡，用户访问nginx，nginx再决定去访问哪一台服务器。当一台服务宕机了之后，另一台服务器也可以继续提供服务，保证服务不中断。如果我们将session保存在Web容器(比如tomcat)中，如果一个用户第一次访问被分配到服务器1上面需要登录，当某些访问突然被分配到服务器二上，因为服务器二上没有用户在服务器一上登录的会话session信息，服务器二还会再次让用户登录，用户已经登录了还让登录就感觉不正常了。
</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220626091915015.png" alt="image-20220626091915015"></p>
<pre><code>解决这个问题的思路是用户登录的会话信息不能再保存到Web服务器中，而是保存到一个单独的库
</code></pre>
<p>(redis、mongodb、jdbc等)中，所有服务器都访问同一个库，都从同一个库来获取用户的session信<br>息，如用户在服务器一上登录，将会话信息保存到库中，用户的下次请求被分配到服务器二，服务器二<br>从库中检查session是否已经存在，如果存在就不用再登录了，可以直接访问服务了。</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 基于redis实现session共享 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置session存储类型</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用redis共享session</span></span><br><span class="line"><span class="attr">spring.session.store-type</span>=<span class="string">redis</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 设置不同端口启动两个服务</span><br><span class="line"><span class="bullet">2.</span> 访问第一个服务进行登录，第二服务就可以直接访问</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-6-csrf防护机制"><a href="#2-6-csrf防护机制" class="headerlink" title="2.6 csrf防护机制"></a>2.6 csrf防护机制</h2><h3 id="2-6-1-什么是csrf"><a href="#2-6-1-什么是csrf" class="headerlink" title="2.6.1 什么是csrf?"></a>2.6.1 什么是csrf?</h3><p>​	CSRF（Cross-site request forgery），中文名称：跨站请求伪造</p>
<p>​	你这可以这么理解CSRF攻击：攻击者盗用了你的身份，以你的名义发送恶意请求。CSRF能够做的事情包括：以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账……造成的问题包括：个人隐私泄露以及财产安全。</p>
<p>​	CSRF这种攻击方式在2000年已经被国外的安全人员提出，但在国内，直到06年才开始被关注，08年，国内外的多个大型社区和交互网站分别爆出CSRF漏洞，如：NYTimes.com（纽约时报）、Metafilter（一个大型的BLOG网站），YouTube和百度HI……而现在，互联网上的许多站点仍对此毫无防备，以至于安全业界称CSRF为“沉睡的巨人”。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220626093311778.png" alt="image-20220626093311778"></p>
<p>从上图可以看出，要完成一次CSRF攻击，受害者必须依次完成三个步骤：</p>
<ol>
<li>登录受信任网站A，并在本地生成Cookie。</li>
<li>在不登出A的情况下，访问危险网站B。</li>
<li>触发网站B中的一些元素</li>
</ol>
<h3 id="2-6-3-CSRF的防御策略"><a href="#2-6-3-CSRF的防御策略" class="headerlink" title="2.6.3 CSRF的防御策略"></a>2.6.3 CSRF的防御策略</h3><p>在业界目前防御 CSRF 攻击主要有三种策略：验证 HTTP Referer 字段；在请求地址中添加 token  并验证；在 HTTP 头中自定义属性并验证。</p>
<ol>
<li><p>验证 HTTP Referer 字段</p>
<p>根据 HTTP 协议，在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。在通常情况下，访问一个安全受限页面的请求来自于同一个网站，在后台请求验证其 Referer 值，如果是以自身安全网站开头的域名，则说明该请求是是合法的。如果 Referer 是其他网站的话，则有可能是黑客的 CSRF 攻击，拒绝该请求。</p>
</li>
<li><p>在请求地址中添加 token 并验证</p>
<p>CSRF 攻击之所以能够成功，是因为黑客可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于 cookie 中，因此黑客可以在不知道这些验证信息的情况下直接利用用户自己的cookie 来通过安全验证。要抵御 CSRF，关键在于在请求中放入黑客所不能伪造的信息，并且该信息不存在于 cookie 之中。可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。</p>
</li>
<li><p>在 HTTP 头中自定义属性并验证</p>
<p>这种方法也是使用 token 并进行验证，和上一种方法不同的是，这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。</p>
</li>
</ol>
<h3 id="2-6-4-Security中的csrf防御机制"><a href="#2-6-4-Security中的csrf防御机制" class="headerlink" title="2.6.4 Security中的csrf防御机制"></a>2.6.4 Security中的csrf防御机制</h3><p><code>org.springframework.security.web.csrf.CsrfFilter</code></p>
<blockquote>
<p>csrf又称跨站请求伪造，SpringSecurity会对所有post请求验证是否包含系统生成的csrf的token信息，如果不包含，则报错。起到防止csrf攻击的效果。(1. 生成token 2.验证token)</p>
</blockquote>
<ol>
<li><p>开启csrf防护</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启csrf防护, 可以设置哪些不需要防护</span></span><br><span class="line">http.csrf().ignoringAntMatchers(<span class="string">&quot;/user/xxx&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>页面需要添加token值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span> th:name=<span class="string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span> th:value=<span class="string">&quot;$&#123;_csrf.token&#125;&quot;</span>/&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>这样使用的前提是前后端不分离的项目，在同一个session里面取toke，每次都是随机生成的因此无法伪造。如果前后端分离token就又需要远程请求获取而不是直接在session里面取这又会不安全，如果是前后端分离该怎么设计这个暂时不探讨。</p>
<h2 id="2-7-跨域与CORS"><a href="#2-7-跨域与CORS" class="headerlink" title="2.7 跨域与CORS"></a>2.7 跨域与CORS</h2><h3 id="2-7-1-跨域"><a href="#2-7-1-跨域" class="headerlink" title="2.7.1 跨域"></a>2.7.1 跨域</h3><p>​	跨域，实质上是浏览器的一种保护处理。如果产生了跨域，服务器在返回结果时就会被浏览器拦截(注意：此时请求是可以正常发起的，只是浏览器对其进行了拦截)，导致响应的内容不可用. 产生跨域的几种情况有一下:</p>
<ul>
<li>协议不同（http&#x2F;https）</li>
<li>域名不同 </li>
<li>端口号不同</li>
</ul>
<h3 id="2-7-2-解决跨域"><a href="#2-7-2-解决跨域" class="headerlink" title="2.7.2 解决跨域"></a>2.7.2 解决跨域</h3><ol>
<li><p>JSONP</p>
<p>浏览器允许一些带src属性的标签跨域，也就是某些标签属性上写url地址是不会跨域产生跨域问题的</p>
</li>
<li><p>CORS解决跨域</p>
<p>CORS是一个W3C标准，全程是“跨域资源共享”（Cross-origin resource sharing）. CORS需要浏览器和服务器同时支持。目前所有浏览器都支持该功能，IE浏览器不能低于IE10 浏览器在发起真正的请求之前，会发起一个OPTIONS类型的预检请求，用于请求服务器是否允许跨域，在得到许可的情况下才会发起请求。</p>
</li>
</ol>
<h3 id="2-7-3-基于SpringSecurity的CORS支持"><a href="#2-7-3-基于SpringSecurity的CORS支持" class="headerlink" title="2.7.3 基于SpringSecurity的CORS支持"></a>2.7.3 基于SpringSecurity的CORS支持</h3><ol>
<li><p>声明跨域配置源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跨域配置信息源</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> CorsConfigurationSource <span class="title function_">corsConfigurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">    <span class="comment">// 设置允许跨域的站点</span></span><br><span class="line">    corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置允许跨域的http方法</span></span><br><span class="line">    corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置允许跨域的请求头</span></span><br><span class="line">    corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 允许带凭证</span></span><br><span class="line">    corsConfiguration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 对所有的url生效</span></span><br><span class="line">    <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">    source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启跨域支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//允许跨域</span></span><br><span class="line">http.cors().configurationSource(corsConfigurationSource());</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="三、SpringSecurity授权"><a href="#三、SpringSecurity授权" class="headerlink" title="三、SpringSecurity授权"></a>三、SpringSecurity授权</h1><h2 id="3-1-授权简介"><a href="#3-1-授权简介" class="headerlink" title="3.1 授权简介"></a>3.1 授权简介</h2><p>​	在第二部分中说明的都是用户认证, 不管是用户名密码,还是图形验证码等,最终的目的都是一个:让系统知道你到底是谁在访问你的系统, 解决的问题是, 你是谁? 这部分主要讲解你能在系统中做什么事情, 针对这个有的叫做: 授权, 有的叫做:鉴权, 还有叫权限控制. 最终的目的就是你能在系统中能过做什么?</p>
<h3 id="3-1-1-SpringSecurity对授权的定义"><a href="#3-1-1-SpringSecurity对授权的定义" class="headerlink" title="3.1.1 SpringSecurity对授权的定义"></a>3.1.1 SpringSecurity对授权的定义</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220627101902078.png" alt="image-20220627101902078"></p>
<p>安全控制问题其实就是控制是否能访问url</p>
<h3 id="3-1-2-Spring-Security授权原理"><a href="#3-1-2-Spring-Security授权原理" class="headerlink" title="3.1.2 Spring Security授权原理"></a>3.1.2 Spring Security授权原理</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220627102053058.png" alt="image-20220627102053058"></p>
<p>在我们应用系统里面，如果想要控制用户权限，需要有两部分数据</p>
<ol>
<li>系统配置信息数据：记录系统里面有哪些URL，每个URL需要怎样的权限</li>
<li>用户权限信息：请求用户拥有的权限。</li>
</ol>
<p>系统用户发送一个请求：系统配置信息和用户权限信息作对比，如果对比成功则允许访问。</p>
<p>当一个系统授权规则比较简单基本不变的时候，系统的权限配置可以写到我们的代码当中去。比如前台门户网站等权限比较单一，可以使用简单的授权配置即可完成，如果权限复杂比如办公OA，电商后台管理系统等就不能写在代码里面了。需要设计RBAC权限模型设计。</p>
<h2 id="3-2-SpringSecurity授权"><a href="#3-2-SpringSecurity授权" class="headerlink" title="3.2 SpringSecurity授权"></a>3.2 SpringSecurity授权</h2><h3 id="3-2-1-内置权限表达式"><a href="#3-2-1-内置权限表达式" class="headerlink" title="3.2.1 内置权限表达式"></a>3.2.1 内置权限表达式</h3><p>Spring Security 使用Spring EL来支持，主要用于Web访问和方法安全上, 可以通过表达式来判断是否具有访问权限. 下面是Spring Security常用的内置表达式. ExpressionUrlAuthorizationConfigurer定义了所有的表达式</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>permitAll</td>
<td>任何人都允许访问</td>
</tr>
<tr>
<td>denyAll</td>
<td>任何人都不允许访问</td>
</tr>
<tr>
<td>anonymous</td>
<td>匿名用户允许访问</td>
</tr>
<tr>
<td>rememberMe</td>
<td>记住我的用户可以访问</td>
</tr>
<tr>
<td>authenticated</td>
<td>指定任何经过身份验证的用户都允许访问，不包括anonymous</td>
</tr>
<tr>
<td>fullyAuthenticated</td>
<td>指定由经过身份验证的用户允许访问,不包含anonymous和rememberMe</td>
</tr>
<tr>
<td>hasRole(role)</td>
<td>指定需要特定的角色的用户允许访问, 会自动在角色前面插入’ROLE_’</td>
</tr>
<tr>
<td>hasAnyRole([role1,role2])</td>
<td>指定需要任意一个的角色的用户允许访问, 会自动在角色前面插入’ROLE_’</td>
</tr>
<tr>
<td>hasAuthority(authority)</td>
<td>需要有特定的权限允许访问</td>
</tr>
<tr>
<td>hasAnyAuthority([authority,authority])</td>
<td>需要有其中任意一个的权限允许访问</td>
</tr>
<tr>
<td>hasIpAddress(ip)</td>
<td>需要特定的IP地址可以访问</td>
</tr>
</tbody></table>
<h3 id="3-2-2-URL安全表达式"><a href="#3-2-2-URL安全表达式" class="headerlink" title="3.2.2 URL安全表达式"></a>3.2.2 URL安全表达式</h3><p>基于web访问使用表达式保护url请求路径.</p>
<ol>
<li><p>设置url访问权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置/user/** 访问需要ADMIN角色</span></span><br><span class="line">http.authorizeRequests().antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>);</span><br><span class="line"><span class="comment">// 设置/product/** 访问需要PRODUCT角色和IP地址为127.0.0.1. hasAnyRole(&quot;PRODUCT,ADMIN&quot;)</span></span><br><span class="line">http.authorizeRequests().antMatchers(<span class="string">&quot;/product/**&quot;</span>).access(<span class="string">&quot;hasAnyRole(&#x27;ADMIN,PRODUCT&#x27;) and hasIpAddress(&#x27;127.0.0.1&#x27;)&quot;</span>);</span><br><span class="line"><span class="comment">// 设置自定义权限不足信息.</span></span><br><span class="line">http.exceptionHandling().accessDeniedHandler(myAuthHandle);</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义权限不足处理<code>(在之前上面的表格列举过了，实现AccessDeniedHandler重写handle方法即可,在上一步配上自己的实现类即可）</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    httpServletResponse.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">    httpServletResponse.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">    httpServletResponse.getWriter().write(<span class="string">&quot;权限不足，请联系管理员!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置用户对应的角色权限<code>在自定义的UserDetailService当中获取Security用户实体的过程里面给用户去加权限</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先声明一个权限集合,构造函数必须传值且不能为null,传个空集合即可</span></span><br><span class="line">Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equalsIgnoreCase(user.getUsername())) &#123;</span><br><span class="line">    authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_ADMIN&quot;</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_PRODUCT&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-2-3-在web安全表达式中引用自定义Bean授权"><a href="#3-2-3-在web安全表达式中引用自定义Bean授权" class="headerlink" title="3.2.3 在web安全表达式中引用自定义Bean授权"></a>3.2.3 在web安全表达式中引用自定义Bean授权</h3><ol>
<li><p>自定义授权类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查用户是否有对应的访问权限</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication 登录用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(Authentication authentication, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">        <span class="comment">// 获取用户所有权限</span></span><br><span class="line">        Collection&lt;GrantedAuthority&gt; authorities = user.getAuthorities();</span><br><span class="line">        <span class="comment">// 获取用户名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> user.getUsername();</span><br><span class="line">        <span class="comment">// 如果用户名为admin,则不需要认证</span></span><br><span class="line">        <span class="keyword">if</span> (username.equalsIgnoreCase(<span class="string">&quot;admin&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 循环用户的权限, 判断是否有ROLE_ADMIN权限, 有返回true</span></span><br><span class="line">            <span class="keyword">for</span> (GrantedAuthority authority : authorities) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> authority.getAuthority();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;ROLE_ADMIN&quot;</span>.equals(role)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用自定义Bean授权</span></span><br><span class="line">http.authorizeRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/user/**&quot;</span>)</span><br><span class="line">    .access(<span class="string">&quot;@myAuthService.check(authentication,request)&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>若授权时还需要对路径变量需判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查用户是否有对应的访问权限</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> authentication 登录用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request 请求对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 参数ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(Authentication authentication, HttpServletRequest request, Integer id)</span> &#123;</span><br><span class="line">    <span class="comment">// 举个例子</span></span><br><span class="line">    <span class="keyword">if</span> (id &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用自定义Bean授权,并携带路径参数</span></span><br><span class="line">http.authorizeRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/user/delete/&#123;id&#125;&quot;</span>)</span><br><span class="line">    .access(<span class="string">&quot;@myAuthorizationService.check(authentication,request,#id)&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-2-4-Method安全表达式"><a href="#3-2-4-Method安全表达式" class="headerlink" title="3.2.4 Method安全表达式"></a>3.2.4 Method安全表达式</h3><p>向上面那样配的话，不同的接口不同的权限那么就要在http.authorizeRequests配置很多比较复杂，spring security提供了4种注解分别是<code>@PreAuthorize</code> <code>@PostAuthorize</code> <code>@PreFilter</code> <code>@PostFilter</code></p>
<ol>
<li><p>开启方法级别的注解配置</p>
<p>在security配置类中添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><span class="comment">//开启注解支持</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在方法上使用注解<code>使用这样的方式就比上面少了secuirty配置类当中的配置和自定义的授权类</code></p>
<p><code>ProAuthorize</code> 注解适合进入方法前进行权限验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/findAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">findAll</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    List&lt;UserVo&gt; userList = userService.list();</span><br><span class="line">    model.addAttribute(<span class="string">&quot;userList&quot;</span>, userList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user_list&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;#id &lt; 10&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">update</span><span class="params">(<span class="meta">@PathVariable</span> Integer id, Model model)</span> &#123;</span><br><span class="line">    <span class="type">UserVo</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(id);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user_update&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@PostAuthorize:</code> 在方法执行后在进行权限验证，适合验证带有返回值的权限，Spring EL提供返回对象能够在表达式语言中获取到返回对象<code>returnObject</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostAuthorize(&quot;returnObject.username==authentication.principal.username&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UserVo <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="comment">//获取认证信息</span></span><br><span class="line">    <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="comment">// 判断认证信息是否来源于RememberMe</span></span><br><span class="line">    <span class="keyword">if</span> (RememberMeAuthenticationToken.class.isAssignableFrom(authentication.getClass())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RememberMeAuthenticationException</span>(<span class="string">&quot;认证信息来源于 RememberMe,请重新登录&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">UserVo</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(id);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@PreFilter</code>: 可以用来对集合类型的参数进行过滤，将不符合条件的元素剔除集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 过滤出偶数的，也就是剔除奇数的</span></span><br><span class="line"><span class="meta">@PreFilter(filterTarget = &quot;ids&quot;,value = &quot;filterObject%2==0&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/delByIds&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">delByIds</span><span class="params">(<span class="meta">@RequestParam(value = &quot;id&quot;)</span> List&lt;Integer&gt; ids)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Integer id : ids) &#123;</span><br><span class="line">        System.out.println(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/user/findAll&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@PostFilter</code>: 可以用来对集合类型的返回值进行过滤，将不符合的元素剔除集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回列表元素ID为偶数的保留</span></span><br><span class="line"><span class="meta">@PostFilter(&quot;filterObject.id%2 == 0&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/findAllTOJson&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserVo&gt; <span class="title function_">findAllTOJson</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;UserVo&gt; userList = userService.list();</span><br><span class="line">    <span class="keyword">return</span> userList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220630131654436.png" alt="image-20220630131654436"></p>
</li>
</ol>
<h2 id="3-3-基于数据库的RBAC数据模型"><a href="#3-3-基于数据库的RBAC数据模型" class="headerlink" title="3.3 基于数据库的RBAC数据模型"></a>3.3 基于数据库的RBAC数据模型</h2><p>​	回顾上面内容，第一在自定义产生secuirty用户的地方，我们去给用户添加权限写死或者在数据库查出来放进去。第二在用户访问资源时权限的校验通过配置资源URL加自定义授权器进行判断或者直接在资源上使用注解让security去判断用户和资源。这样的方式仅仅适合权限少的情况，如果系统权限不是只有一个两个权限就需要设计权限模型了。</p>
<p>​	我们开发一个系统，必然面临权限控制的问题，不同的用户具有不同的访问、操作、数据权限。形成理论的权限控制模型有：自主访问控制（DAC: Discretionary Access Control）、强制访问控制（MAC: Mandatory Access Control）、基于属性的权限验证（ABAC:Attribute-Based Access Control）等。最常被开发者使用也是相对易用、通用的就是RBAC权限模型（Role-Based Access Control）</p>
<h3 id="3-3-1-RBAC权限模型简介"><a href="#3-3-1-RBAC权限模型简介" class="headerlink" title="3.3.1 RBAC权限模型简介"></a>3.3.1 RBAC权限模型简介</h3><p>RBAC权限模型（Role-Based Access Control）即：基于角色的权限控制。模型中有几个关键的术语：</p>
<ul>
<li>用户：系统接口及访问的操作者</li>
<li>权限：能够访问某接口或者做某操作的授权资格</li>
<li>角色：具有一类一批权限的总称</li>
</ul>
<p>RBAC权限模型核心授权逻辑如下：</p>
<ul>
<li>某用户是什么角色？</li>
<li>某用户具有什么权限？</li>
<li>通过角色对应的权限推导出用户权限</li>
</ul>
<h3 id="3-3-2-RBAC的演化进程"><a href="#3-3-2-RBAC的演化进程" class="headerlink" title="3.3.2 RBAC的演化进程"></a>3.3.2 RBAC的演化进程</h3><ol>
<li><p>用户与权限直接关联</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220630133551238.png" alt="image-20220630133551238"></p>
<p>想到权限控制，人们最先想到的一定是用户与权限直接关联的模式，简单地说就是：某个用户具有某些权限。如图：</p>
<ul>
<li>张三具有所有权限它可能是一个超级管理员</li>
<li>李四,王五 具有添加商品和审核商品的权限有可能是一个普通业务员</li>
</ul>
<p>这种模型能够清晰的表达用户与权限之间的关系，足够简单。但同时也存在问题：</p>
<ul>
<li>现在用户是张三、李四，王五以后随着人员增加，每一个用户都需要重新授权</li>
<li>操作人员的他的权限发生变更后,需要对每个一个用户重新授予新的权限</li>
</ul>
</li>
<li><p>用户角色关联</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220630133937458.png" alt="image-20220630133937458"></p>
<p>这样只需要维护角色和权限之间的关系就可以了. 如果业务员的权限发生变更, 只需要变动业务员角色和权限之前的关系进行维护就可以了. 用户和权限就分离开来了. 如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220630134028657.png" alt="image-20220630134028657"></p>
</li>
</ol>
<h3 id="3-3-3-基于RBAC设计权限表结构"><a href="#3-3-3-基于RBAC设计权限表结构" class="headerlink" title="3.3.3 基于RBAC设计权限表结构"></a>3.3.3 基于RBAC设计权限表结构</h3><ul>
<li>一个用户有一个或多个角色</li>
<li>一个角色可以被多个用户拥有</li>
<li>一个角色有多种权限</li>
<li>一个权限属于多个角色</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220630134241850.png" alt="image-20220630134241850"></p>
<h3 id="3-3-4-基于Spring-Security实现RBAC权限管理"><a href="#3-3-4-基于Spring-Security实现RBAC权限管理" class="headerlink" title="3.3.4 基于Spring Security实现RBAC权限管理"></a>3.3.4 基于Spring Security实现RBAC权限管理</h3><ol>
<li><p>动态查询数据库中用户应用的权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID查询权限</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select(&quot;SELECT p.*  FROM t_permission p,t_role_permission rp,t_role r,t_user_role ur,t_user u &quot; +</span></span><br><span class="line"><span class="meta">        &quot;WHERE p.id = rp.PID AND rp.RID = r.id AND r.id = ur.RID AND ur.UID = u.id AND u.id =#&#123;id&#125;&quot;)</span></span><br><span class="line">List&lt;Permission&gt; <span class="title function_">findByUserId</span><span class="params">(Integer id)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给登录用户授权</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先声明一个权限集合, 因为构造方法里面不能传入null</span></span><br><span class="line">Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// 查询用户对应所有权限</span></span><br><span class="line">List&lt;Permission&gt; permissions = permissionService.findByUserId(user.getId());</span><br><span class="line"><span class="keyword">for</span> (Permission permission : permissions) &#123;</span><br><span class="line">    <span class="comment">// 授权</span></span><br><span class="line">    authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(permission.getPermissionTag()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置访问权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询数据库所有权限列表</span></span><br><span class="line">List&lt;Permission&gt; permissions = permissionService.list();</span><br><span class="line"><span class="keyword">for</span> (Permission permission : permissions) &#123;</span><br><span class="line">    <span class="comment">//添加请求权限</span></span><br><span class="line">    http.authorizeRequests().antMatchers(permission.getPermissionUrl()).hasAuthority(permission.getPermissionTag());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 设置自定义权限不足信息.</span></span><br><span class="line">http.exceptionHandling().accessDeniedHandler(myAuthHandle);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>这样就完成了动态的权限管理，第一部分在产生Security用户实体的service当中进行关联查询给当前用户填入权限。第二部分配置各资源权限：从数据库获取权限信息并配置资源path与对应权限。</p>
<p>总而言之如果是简单的认证限制就可以之前想之前一样简单写死配置在SecurityConfiguration或者配置在各个方法。否则就可以使用当前的设计进行权限管理。</p>
<h2 id="3-4-基于页面标签的权限控制"><a href="#3-4-基于页面标签的权限控制" class="headerlink" title="3.4 基于页面标签的权限控制"></a>3.4 基于页面标签的权限控制</h2><p>​	<code>简单记下吧，也不常用了</code></p>
<p>​	在jsp页面或者thymeleaf模板页面中我们可以使用spring security提供的权限标签来进行权限控制.要想使用thymeleaf为SpringSecurity提供的标签属性，首先需要引入thymeleaf-extras-springsecurity依赖支持。</p>
<ol>
<li><p>在pom 文件中的引入springsecurity的标签依赖thymeleaf-extras-springsecurity5</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加thymeleaf为SpringSecurity提供的标签 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在html文件里面声明使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span> <span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-4-1-常用SpringSecurity的标签属性介绍"><a href="#3-4-1-常用SpringSecurity的标签属性介绍" class="headerlink" title="3.4.1 常用SpringSecurity的标签属性介绍"></a>3.4.1 常用SpringSecurity的标签属性介绍</h3><blockquote>
<p>判断用户是否已经登陆认证，引号内的参数必须是isAuthenticated()，sec:authorize&#x3D;”isAuthenticated()”</p>
<p>获得当前用户的用户名，引号内的参数必须是name，sec:authentication&#x3D;“name”</p>
<p>判断当前用户是否拥有指定的权限。引号内的参数为权限的名称，sec:authorize&#x3D;“hasRole(‘role’)”</p>
</blockquote>
<h3 id="3-4-2-SpringSecurity标签的使用"><a href="#3-4-2-SpringSecurity标签的使用" class="headerlink" title="3.4.2 SpringSecurity标签的使用"></a>3.4.2 SpringSecurity标签的使用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;leftnav&quot;</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;leftnav-title&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;isAuthenticated()&quot;</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/y.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;radius-circle rotate-hover&quot;</span> <span class="attr">height</span>=<span class="string">&quot;50&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasAuthority(&#x27;user:findAll&#x27;)&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-user&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>系统管理<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">style</span>=<span class="string">&quot;display:block&quot;</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/user/findAll&quot;</span> <span class="attr">target</span>=<span class="string">&quot;right&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-caretright&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">span--&gt;</span>用户管理<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;toCors()&quot;</span> <span class="attr">target</span>=<span class="string">&quot;right&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-caret-right&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>跨域测试<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasAuthority(&#x27;product:findAll&#x27;)&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-pencil-square-o&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>数据管理<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/product/findAll&quot;</span> <span class="attr">target</span>=<span class="string">&quot;right&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;iconcaret-</span></span></span><br><span class="line"><span class="string"><span class="tag">right&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>商品管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="四、源码分析"><a href="#四、源码分析" class="headerlink" title="四、源码分析"></a>四、源码分析</h1><h2 id="4-1-过滤器链加载源码"><a href="#4-1-过滤器链加载源码" class="headerlink" title="4.1 过滤器链加载源码"></a>4.1 过滤器链加载源码</h2><h3 id="4-1-1-过滤器加载流程分析"><a href="#4-1-1-过滤器加载流程分析" class="headerlink" title="4.1.1 过滤器加载流程分析"></a>4.1.1 过滤器加载流程分析</h3><p>在上面第二部分的时候说springSecurity中主要功能是由过滤器链来完成的, 那么spring boot 是如何加载这个流程的呢?</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220701113050215.png" alt="image-20220701113050215"></p>
<h3 id="4-1-2-过滤器链加载流程源码分析"><a href="#4-1-2-过滤器链加载流程源码分析" class="headerlink" title="4.1.2 过滤器链加载流程源码分析"></a>4.1.2 过滤器链加载流程源码分析</h3><ol>
<li><p>spring boot启动自动配置中会加载spring.factories文件, 在文件中有对应针对Spring Security的过滤器链的配置信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220705151908666.png" alt="image-20220705151908666"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安全过滤器自动配置</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>SecurityFilterAutoConfiguration类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;SecurityProperties.class&#125;)</span> <span class="comment">//Security配置类</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;AbstractSecurityWebApplicationInitializer.class, SessionCreationPolicy.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;SecurityAutoConfiguration.class&#125;)</span> <span class="comment">//当前类加载完成后 加载SecurityAutofiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityFilterAutoConfiguration</span> &#123;</span><br><span class="line">	...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要两个部分第一加载security配置，当中会有两个东西一个一个是默认用户信息、一个是过滤器链的组建</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220705153332732.png" alt="image-20220705153332732"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220705154304776.png" alt="image-20220705154304776"></p>
<p>第二就是随后去加载的<code>SecurityAutoConfiguration</code>，其中导入了web的安全配置<code>WebSecurityEnablerConfiguration.class</code>，如下</p>
</li>
<li><p>SecurityAutoConfiguration类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;DefaultAuthenticationEventPublisher.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;SecurityProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123;SpringBootWebSecurityConfiguration.class, WebSecurityEnablerConfiguration.class, SecurityDataConfiguration.class&#125;)</span><span class="comment">//web安全启用配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityAutoConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(&#123;AuthenticationEventPublisher.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAuthenticationEventPublisher <span class="title function_">authenticationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultAuthenticationEventPublisher</span>(publisher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>WebSecurityEnablerConfiguration类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(&#123;WebSecurityConfigurerAdapter.class&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = &#123;&quot;springSecurityFilterChain&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityEnablerConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSecurityEnablerConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220705154834123.png" alt="image-20220705154834123"></p>
<p>@EnableWebSecurity注解有两个作用：1: 加载了WebSecurityConfiguration配置类, 配置安全认证策略。2: 加载了AuthenticationConfiguration 配置的认证信息。</p>
</li>
<li><p>WebSecurityConfiguration类</p>
<p>在webSecurityConfiguration当中生成了过滤器链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span>, BeanClassLoaderAware &#123;     ...       </span><br><span class="line">    <span class="comment">// springSecurity过滤器声明</span></span><br><span class="line">    <span class="meta">@Bean(name = &#123;&quot;springSecurityFilterChain&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Filter <span class="title function_">springSecurityFilterChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasConfigurers</span> <span class="operator">=</span> <span class="built_in">this</span>.webSecurityConfigurers != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.webSecurityConfigurers.isEmpty();</span><br><span class="line">        <span class="keyword">if</span> (!hasConfigurers) &#123;</span><br><span class="line">            <span class="type">WebSecurityConfigurerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> (WebSecurityConfigurerAdapter)<span class="built_in">this</span>.objectObjectPostProcessor.postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurityConfigurerAdapter</span>() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="built_in">this</span>.webSecurity.apply(adapter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Filter)<span class="built_in">this</span>.webSecurity.build();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-2-认证流程源码"><a href="#4-2-认证流程源码" class="headerlink" title="4.2 认证流程源码"></a>4.2 认证流程源码</h2><h3 id="4-2-1-认证流程分析"><a href="#4-2-1-认证流程分析" class="headerlink" title="4.2.1 认证流程分析"></a>4.2.1 认证流程分析</h3><p>​	在整个过滤器链中, UsernamePasswordAuthenticationFilter是来处理整个用户认证的流程的, 所以下面我们主要针对用户认证来看下源码是如何实现的?</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220701115926889.png" alt="image-20220701115926889"></p>
<h3 id="4-2-2-认证流程源码跟踪"><a href="#4-2-2-认证流程源码跟踪" class="headerlink" title="4.2.2 认证流程源码跟踪"></a>4.2.2 认证流程源码跟踪</h3><ul>
<li><p>UsernamePasswordAuthenticationFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="comment">// 1.检查是否是Post请求</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.postOnly &amp;&amp; !request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2.获取用户名密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainUsername(request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainPassword(request);</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">            username = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (password == <span class="literal">null</span>) &#123;</span><br><span class="line">            password = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        username = username.trim();</span><br><span class="line">        <span class="comment">// 3.创建AuthenticationToken，此时是未认证状态</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">        <span class="built_in">this</span>.setDetails(request, authRequest);</span><br><span class="line">        <span class="comment">// 4.调用AuthenticationManager进行认证</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UsernamePasswordAuthenticationToken</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">UsernamePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>((Collection)<span class="literal">null</span>);</span><br><span class="line">    <span class="built_in">this</span>.principal = principal;</span><br><span class="line">    <span class="built_in">this</span>.credentials = credentials;</span><br><span class="line">    <span class="built_in">this</span>.setAuthenticated(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>AuthenticationManager–&gt;ProviderManager–&gt;AbstractUserDetailsAuthenticationProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span>, <span class="string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 1.获取用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="built_in">this</span>.determineUsername(authentication);</span><br><span class="line">    <span class="comment">// 2.尝试从缓存中提取</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cacheWasUsed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.userCache.getUserFromCache(username);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        cacheWasUsed = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 检索User</span></span><br><span class="line">            user = <span class="built_in">this</span>.retrieveUser(username, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 4.认证前检查user状态</span></span><br><span class="line">        <span class="built_in">this</span>.preAuthenticationChecks.check(user);</span><br><span class="line">        <span class="comment">// 5.附加认证检查状态</span></span><br><span class="line">        <span class="built_in">this</span>.additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException var7) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var7;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cacheWasUsed = <span class="literal">false</span>;</span><br><span class="line">        user = <span class="built_in">this</span>.retrieveUser(username, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">        <span class="built_in">this</span>.preAuthenticationChecks.check(user);</span><br><span class="line">        <span class="built_in">this</span>.additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken)authentication);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 6.认证后检查user状态</span></span><br><span class="line">    <span class="built_in">this</span>.postAuthenticationChecks.check(user);</span><br><span class="line">    <span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userCache.putUserInCache(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">principalToReturn</span> <span class="operator">=</span> user;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.forcePrincipalAsString) &#123;</span><br><span class="line">        principalToReturn = user.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 7.创建认证成功的UsernamePasswordAuthenticationToken并将认证状态设置未true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中retrieveUser方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> UserDetails <span class="title function_">retrieveUser</span><span class="params">(String username, UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="built_in">this</span>.prepareTimingAttackProtection();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用自定义UserDetailsService的loadUserByUsername方法</span></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">loadedUser</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (loadedUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalAuthenticationServiceException</span>(<span class="string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> loadedUser;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中additionalAuthenticationChecks方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="keyword">if</span> (authentication.getCredentials() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Failed to authenticate since no credentials provided&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="string">&quot;Bad credentials&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取前端密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">        <span class="comment">// 2.与数据库密码进行对比</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.passwordEncoder.matches(presentedPassword, userDetails.getPassword())) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Failed to authenticate since password does not match stored value&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="string">&quot;Bad credentials&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>AbstractAuthenticationProcessingFilter–doFilter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.requiresAuthentication(request, response)) &#123;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.调用子类方法</span></span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authenticationResult</span> <span class="operator">=</span> <span class="built_in">this</span>.attemptAuthentication(request, response);</span><br><span class="line">            <span class="keyword">if</span> (authenticationResult == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 2.session策略验证</span></span><br><span class="line">            <span class="built_in">this</span>.sessionStrategy.onAuthentication(authenticationResult, request, response);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.continueChainBeforeSuccessfulAuthentication) &#123;</span><br><span class="line">                chain.doFilter(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 3.成功身份验证</span></span><br><span class="line">            <span class="built_in">this</span>.successfulAuthentication(request, response, chain, authenticationResult);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InternalAuthenticationServiceException var5) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.error(<span class="string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span>, var5);</span><br><span class="line">            <span class="built_in">this</span>.unsuccessfulAuthentication(request, response, var5);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException var6) &#123;</span><br><span class="line">            <span class="built_in">this</span>.unsuccessfulAuthentication(request, response, var6);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>successfulAuthentication方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">    <span class="comment">// 1.将认证的用户放入SecurityContext中</span></span><br><span class="line">    context.setAuthentication(authResult);</span><br><span class="line">    SecurityContextHolder.setContext(context);</span><br><span class="line">    <span class="built_in">this</span>.securityContextRepository.saveContext(context, request, response);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Set SecurityContextHolder to %s&quot;</span>, authResult));</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 检查是不是记住我</span></span><br><span class="line">    <span class="built_in">this</span>.rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.eventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.eventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">InteractiveAuthenticationSuccessEvent</span>(authResult, <span class="built_in">this</span>.getClass()));</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 3.调用自定义的MyAuthHandle的onAuthenticationSuccess方法</span></span><br><span class="line">    <span class="built_in">this</span>.successHandler.onAuthenticationSuccess(request, response, authResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="4-3-记住我流程源码"><a href="#4-3-记住我流程源码" class="headerlink" title="4.3 记住我流程源码"></a>4.3 记住我流程源码</h2><p>整个过滤器链中，RememberMeAuthenticationFilter是来处理记住我用户认证的流程的, 所以下面我们主要针对记住我看下源码是如何实现的?</p>
<h3 id="4-3-1-记住我流程分析"><a href="#4-3-1-记住我流程分析" class="headerlink" title="4.3.1 记住我流程分析"></a>4.3.1 记住我流程分析</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220825115847345.png" alt="image-20220825115847345"></p>
<h3 id="4-3-2-记住我流程源码跟踪"><a href="#4-3-2-记住我流程源码跟踪" class="headerlink" title="4.3.2 记住我流程源码跟踪"></a>4.3.2 记住我流程源码跟踪</h3><ul>
<li><p>AbstractAuthenticationProcessingFilter –》 successfulAuthentication方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">    <span class="comment">// 1.将认证的用户放入SecurityContext中</span></span><br><span class="line">    context.setAuthentication(authResult);</span><br><span class="line">    SecurityContextHolder.setContext(context);</span><br><span class="line">    <span class="built_in">this</span>.securityContextRepository.saveContext(context, request, response);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Set SecurityContextHolder to %s&quot;</span>, authResult));</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 检查是不是记住我</span></span><br><span class="line">    <span class="built_in">this</span>.rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.eventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.eventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">InteractiveAuthenticationSuccessEvent</span>(authResult, <span class="built_in">this</span>.getClass()));</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 3.调用自定义的MyAuthHandle的onAuthenticationSuccess方法</span></span><br><span class="line">    <span class="built_in">this</span>.successHandler.onAuthenticationSuccess(request, response, authResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loginSuccess方法 —》onLoginSuccess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onLoginSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.获取用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> successfulAuthentication.getName();</span><br><span class="line">    <span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Creating new persistent login for user %s&quot;</span>, username));</span><br><span class="line">    <span class="comment">// 2.创建persistenToken</span></span><br><span class="line">    <span class="type">PersistentRememberMeToken</span> <span class="variable">persistentToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PersistentRememberMeToken</span>(username, <span class="built_in">this</span>.generateSeriesData(), <span class="built_in">this</span>.generateTokenData(), <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 3.插入数据库</span></span><br><span class="line">        <span class="built_in">this</span>.tokenRepository.createNewToken(persistentToken);</span><br><span class="line">        <span class="comment">// 4.写入浏览器cookie</span></span><br><span class="line">        <span class="built_in">this</span>.addCookie(persistentToken, request, response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logger.error(<span class="string">&quot;Failed to save persistent token &quot;</span>, var7);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RememberMeAuthenticationFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.logger.debug(LogMessage.of(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;SecurityContextHolder not populated with remember-me token, as it already contained: &#x27;&quot;</span> + SecurityContextHolder.getContext().getAuthentication() + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        &#125;));</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1.检查是是否记住我，如果是完成自动登录</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">rememberMeAuth</span> <span class="operator">=</span> <span class="built_in">this</span>.rememberMeServices.autoLogin(request, response);</span><br><span class="line">        <span class="keyword">if</span> (rememberMeAuth != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 2.调用authenticationManager再次认证</span></span><br><span class="line">                rememberMeAuth = <span class="built_in">this</span>.authenticationManager.authenticate(rememberMeAuth);</span><br><span class="line">                <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">                <span class="comment">// 3.将认证的用户在重新放入SecurityContext中</span></span><br><span class="line">                context.setAuthentication(rememberMeAuth);</span><br><span class="line">                SecurityContextHolder.setContext(context);</span><br><span class="line">                <span class="built_in">this</span>.onSuccessfulAuthentication(request, response, rememberMeAuth);</span><br><span class="line">				...</span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 调用下一个过滤器</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中autoLogin方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Authentication <span class="title function_">autoLogin</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.获取rememberMeCookie</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">rememberMeCookie</span> <span class="operator">=</span> <span class="built_in">this</span>.extractRememberMeCookie(request);</span><br><span class="line">    <span class="comment">// 2.检查是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (rememberMeCookie == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Remember-me cookie detected&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (rememberMeCookie.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Cookie was empty&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.cancelCookie(request, response);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3.解码Cookie</span></span><br><span class="line">                String[] cookieTokens = <span class="built_in">this</span>.decodeCookie(rememberMeCookie);</span><br><span class="line">                <span class="comment">// 4.根据cookie完成自动登录</span></span><br><span class="line">                <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.processAutoLoginCookie(cookieTokens, request, response);</span><br><span class="line">                <span class="comment">// 5.检查user状态</span></span><br><span class="line">                <span class="built_in">this</span>.userDetailsChecker.check(user);</span><br><span class="line">                <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Remember-me cookie accepted&quot;</span>);</span><br><span class="line">                <span class="comment">// 6. 创建认证成功的RememberMeAuthenticationToken并将认证状态设置为true</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.createSuccessfulAuthentication(request, user);</span><br><span class="line">            &#125; </span><br><span class="line">			...</span><br><span class="line">            <span class="built_in">this</span>.cancelCookie(request, response);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>proccessAutoLoginCookie方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> UserDetails <span class="title function_">processAutoLoginCookie</span><span class="params">(String[] cookieTokens, HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cookieTokens.length != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidCookieException</span>...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取系列码和token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">presentedSeries</span> <span class="operator">=</span> cookieTokens[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">presentedToken</span> <span class="operator">=</span> cookieTokens[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 2.根据token去数据库中查询</span></span><br><span class="line">        <span class="type">PersistentRememberMeToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="built_in">this</span>.tokenRepository.getTokenForSeries(presentedSeries);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 3.在创建一个新的token</span></span><br><span class="line">            <span class="type">PersistentRememberMeToken</span> <span class="variable">newToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PersistentRememberMeToken</span>(token.getUsername(), token.getSeries(), <span class="built_in">this</span>.generateTokenData(), <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 4.修改数据库token信息</span></span><br><span class="line">                <span class="built_in">this</span>.tokenRepository.updateToken(newToken.getSeries(), newToken.getTokenValue(), newToken.getDate());</span><br><span class="line">                <span class="comment">// 5. 写入浏览器</span></span><br><span class="line">                <span class="built_in">this</span>.addCookie(newToken, request, response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 6.根据用户名调用UserDetailsService查询UserDetail</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(token.getUsername());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="4-4-CSRF流程源码"><a href="#4-4-CSRF流程源码" class="headerlink" title="4.4 CSRF流程源码"></a>4.4 CSRF流程源码</h2><p>在整个过滤器链中, CsrfFilter是起到csrf防护的, 所以下面我们主要针对记住我看下源码是如何实现的?</p>
<h3 id="CSRF流程分析"><a href="#CSRF流程分析" class="headerlink" title="CSRF流程分析"></a>CSRF流程分析</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220825125005446.png" alt="image-20220825125005446"></p>
<h3 id="3-4-2-CSRF源码流程跟踪"><a href="#3-4-2-CSRF源码流程跟踪" class="headerlink" title="3.4.2 CSRF源码流程跟踪"></a>3.4.2 CSRF源码流程跟踪</h3><ul>
<li><p>Csrfilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    request.setAttribute(HttpServletResponse.class.getName(), response);</span><br><span class="line">    <span class="comment">// 1.取出token</span></span><br><span class="line">    <span class="type">CsrfToken</span> <span class="variable">csrfToken</span> <span class="operator">=</span> <span class="built_in">this</span>.tokenRepository.loadToken(request);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">missingToken</span> <span class="operator">=</span> csrfToken == <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (missingToken) &#123;</span><br><span class="line">      	<span class="comment">// 2.如果没有token就重新生成token</span></span><br><span class="line">        csrfToken = <span class="built_in">this</span>.tokenRepository.generateToken(request);</span><br><span class="line">        <span class="built_in">this</span>.tokenRepository.saveToken(csrfToken, request, response);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 3.将csrfToken值放入request域中</span></span><br><span class="line">    request.setAttribute(CsrfToken.class.getName(), csrfToken);</span><br><span class="line">    request.setAttribute(csrfToken.getParameterName(), csrfToken);</span><br><span class="line">    <span class="comment">// 4.匹配请求是否为post请求，否则放行</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.requireCsrfProtectionMatcher.matches(request)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Did not protect against CSRF since request did not match &quot;</span> + <span class="built_in">this</span>.requireCsrfProtectionMatcher);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualToken</span> <span class="operator">=</span> request.getHeader(csrfToken.getHeaderName());</span><br><span class="line">        <span class="keyword">if</span> (actualToken == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 5.从request请求参数中取出csrfToken</span></span><br><span class="line">            actualToken = request.getParameter(csrfToken.getParameterName());</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 6.匹配两个token是否相等</span></span><br><span class="line">        <span class="keyword">if</span> (!equalsConstantTime(csrfToken.getToken(), actualToken)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.debug(LogMessage.of(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Invalid CSRF token found for &quot;</span> + UrlUtils.buildFullRequestUrl(request);</span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="type">AccessDeniedException</span> <span class="variable">exception</span> <span class="operator">=</span> !missingToken ? <span class="keyword">new</span> <span class="title class_">InvalidCsrfTokenException</span>(csrfToken, actualToken) : <span class="keyword">new</span> <span class="title class_">MissingCsrfTokenException</span>(actualToken);</span><br><span class="line">            <span class="built_in">this</span>.accessDeniedHandler.handle(request, response, (AccessDeniedException)exception);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 7.如果相等则放行</span></span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>​		</p>
<h2 id="4-5-授权流程源码"><a href="#4-5-授权流程源码" class="headerlink" title="4.5 授权流程源码"></a>4.5 授权流程源码</h2><p>在整个过滤器链中，FilterSecurityInterceptor是来处理整个用户授权流程的，也是距离用户API最后一个非常重要的过滤器链，因此下面针对用户授权看下源码是如何实现的？</p>
<h3 id="4-5-1-授权流程分析"><a href="#4-5-1-授权流程分析" class="headerlink" title="4.5.1 授权流程分析"></a>4.5.1 授权流程分析</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://yournotes.oss-cn-beijing.aliyuncs.com/post/document/springsecurity/image-20220825131729597.png" alt="image-20220825131729597"></p>
<p><strong>AffirmativeBased (基于肯定)</strong> ： 一票通过权</p>
<p><strong>ConsensusBased（基于共识）</strong>：赞成票多于反对票则通过，反对多余赞成抛出AccessDeniedException</p>
<p><strong>UnanimousBased（基于一致）</strong>：一票否决权</p>
<h3 id="4-5-2-授权流程源码跟踪"><a href="#4-5-2-授权流程源码跟踪" class="headerlink" title="4.5.2 授权流程源码跟踪"></a>4.5.2 授权流程源码跟踪</h3><ul>
<li><p>FilterSecurityInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="built_in">this</span>.invoke(<span class="keyword">new</span> <span class="title class_">FilterInvocation</span>(request, response, chain));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*------------*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(FilterInvocation filterInvocation)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isApplied(filterInvocation) &amp;&amp; <span class="built_in">this</span>.observeOncePerRequest) &#123;</span><br><span class="line">        filterInvocation.getChain().doFilter(filterInvocation.getRequest(), filterInvocation.getResponse());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (filterInvocation.getRequest() != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.observeOncePerRequest) &#123;</span><br><span class="line">            filterInvocation.getRequest().setAttribute(<span class="string">&quot;__spring_security_filterSecurityInterceptor_filterApplied&quot;</span>, Boolean.TRUE);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 前置调用</span></span><br><span class="line">        <span class="type">InterceptorStatusToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="built_in">super</span>.beforeInvocation(filterInvocation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterInvocation.getChain().doFilter(filterInvocation.getRequest(), filterInvocation.getResponse());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.finallyInvocation(token);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 后置调用</span></span><br><span class="line">        <span class="built_in">super</span>.afterInvocation(token, (Object)<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractSecurityInterceptor的beforeInvocation方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> InterceptorStatusToken <span class="title function_">beforeInvocation</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    Assert.notNull(object, <span class="string">&quot;Object was null&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.getSecureObjectClass().isAssignableFrom(object.getClass())) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取security的系统配置权限</span></span><br><span class="line">        Collection&lt;ConfigAttribute&gt; attributes = <span class="built_in">this</span>.obtainSecurityMetadataSource().getAttributes(object);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(attributes)) &#123;</span><br><span class="line">			...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">			<span class="comment">// 2.获取用户认证信息</span></span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authenticated</span> <span class="operator">=</span> <span class="built_in">this</span>.authenticateIfRequired();</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.logger.trace(LogMessage.format(<span class="string">&quot;Authorizing %s with attributes %s&quot;</span>, object, attributes));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.调用决策管理器，无权限则抛出accessDeniedException让ExceptionTranslationFilter捕获</span></span><br><span class="line">            <span class="built_in">this</span>.attemptAuthorization(object, attributes, authenticated);</span><br><span class="line">			...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>attemptAuthoriztion–&gt;AffirmativeBase的decide方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decide</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">deny</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="built_in">this</span>.getDecisionVoters().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">        <span class="type">AccessDecisionVoter</span> <span class="variable">voter</span> <span class="operator">=</span> (AccessDecisionVoter)var5.next();</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> voter.vote(authentication, object, configAttributes);</span><br><span class="line">        <span class="comment">// 一票否决</span></span><br><span class="line">        <span class="keyword">switch</span>(result) &#123;</span><br><span class="line">            <span class="keyword">case</span> -<span class="number">1</span>:</span><br><span class="line">                ++deny;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deny &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;AbstractAccessDecisionManager.accessDenied&quot;</span>, <span class="string">&quot;Access is denied&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.checkAllowIfAllAbstainDecisions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ExceptionTranslationFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.调用下一个过滤器即FilterSecurityInterceptor</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var7;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">        Throwable[] causeChain = <span class="built_in">this</span>.throwableAnalyzer.determineCauseChain(var8);</span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">securityException</span> <span class="operator">=</span> (AuthenticationException)<span class="built_in">this</span>.throwableAnalyzer.getFirstThrowableOfType(AuthenticationException.class, causeChain);</span><br><span class="line">        <span class="comment">// 2.捕获FilterSecurityInterceptor并判断异常类型</span></span><br><span class="line">        <span class="keyword">if</span> (securityException == <span class="literal">null</span>) &#123;</span><br><span class="line">            securityException = (AccessDeniedException)<span class="built_in">this</span>.throwableAnalyzer.getFirstThrowableOfType(AccessDeniedException.class, causeChain);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (securityException == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.rethrow(var8);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Unable to handle the Spring Security Exception because the response is already committed.&quot;</span>, var8);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 3.如果是AccessDeniedException异常则处理Spring Security异常</span></span><br><span class="line">        <span class="built_in">this</span>.handleSpringSecurityException(request, response, chain, (RuntimeException)securityException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handleSpringSecuirtyException方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleSpringSecurityException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, RuntimeException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AuthenticationException) &#123;</span><br><span class="line">        <span class="built_in">this</span>.handleAuthenticationException(request, response, chain, (AuthenticationException)exception);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AccessDeniedException) &#123;</span><br><span class="line">        <span class="built_in">this</span>.handleAccessDeniedException(request, response, chain, (AccessDeniedException)exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAuthenticationException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, AuthenticationException exception)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Sending to authentication entry point since authentication failed&quot;</span>, exception);</span><br><span class="line">    <span class="built_in">this</span>.sendStartAuthentication(request, response, chain, exception);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAccessDeniedException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, AccessDeniedException exception)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isAnonymous</span> <span class="operator">=</span> <span class="built_in">this</span>.authenticationTrustResolver.isAnonymous(authentication);</span><br><span class="line">    <span class="keyword">if</span> (!isAnonymous &amp;&amp; !<span class="built_in">this</span>.authenticationTrustResolver.isRememberMe(authentication)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.trace(LogMessage.format(<span class="string">&quot;Sending %s to access denied handler since access is denied&quot;</span>, authentication), exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.accessDeniedHandler.handle(request, response, exception);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.trace(LogMessage.format(<span class="string">&quot;Sending %s to authentication entry point since access is denied&quot;</span>, authentication), exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.sendStartAuthentication(request, response, chain, <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(<span class="built_in">this</span>.messages.getMessage(<span class="string">&quot;ExceptionTranslationFilter.insufficientAuthentication&quot;</span>, <span class="string">&quot;Full authentication is required to access this resource&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://yournotes.cn">木瓜煲鸡脚</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yournotes.cn/2022/08/25/SpringSecurity%E8%AF%A6%E8%A7%A3/">http://yournotes.cn/2022/08/25/SpringSecurity详解/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yournotes.cn" target="_blank">木瓜煲鸡脚's blog</a>！</span></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="/assets/img/article/article.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/28/%E6%8A%80%E6%9C%AF%E6%A0%88%E5%AF%BC%E8%87%B4%E5%90%8E%E7%BB%AD%E6%B5%81%E5%BC%8F%E5%93%8D%E5%BA%94%E7%9A%84%E5%9D%91/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/img/article/article.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">技术栈导致后续流式响应的坑</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/20/268.%E7%BC%BA%E5%A4%B1%E7%9A%84%E6%95%B0%E5%AD%97/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/img/article/article.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LeetCode初级算法之其他：268.缺失的数字</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81SpringSecurity%E5%85%A5%E9%97%A8"><span class="toc-text">一、SpringSecurity入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Spring-Security%E7%AE%80%E4%BB%8B"><span class="toc-text">1.1 Spring Security简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-text">1.2 安全技术方案对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Spring-Security%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B"><span class="toc-text">1.3 Spring Security功能简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Spring-Security%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">1.4 Spring Security应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-Spring-Security%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">1.5 Spring Security入门案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-1-IDEA%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-text">1.5.1 IDEA创建工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-2-%E7%BC%96%E5%86%99Controller"><span class="toc-text">1.5.2 编写Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-3-%E5%8A%A0%E5%85%A5Security%E4%BE%9D%E8%B5%96"><span class="toc-text">1.5.3 加入Security依赖</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81SpringSecurity%E8%AE%A4%E8%AF%81"><span class="toc-text">二、SpringSecurity认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E4%B8%8B%E8%BD%BD%E6%A1%88%E4%BE%8B"><span class="toc-text">2.1 下载案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-SpringSecurity%E8%AE%A4%E8%AF%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%B8%8E%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-text">2.2 SpringSecurity认证基本原理与两种方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E8%BF%87%E6%BB%A4%E9%93%BE%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.2.1 过滤链介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-2-%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-text">2.2.2 认证方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%A1%A8%E5%8D%95%E8%AE%A4%E8%AF%81"><span class="toc-text">2.3 表单认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E5%8D%95%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-text">2.3.1 自定义表单登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E8%A1%A8%E5%8D%95%E7%99%BB%E5%BD%95"><span class="toc-text">2.3.2 表单登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD"><span class="toc-text">2.3.3 基于数据库实现认证功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E8%AE%A4%E8%AF%81"><span class="toc-text">2.3.4 密码加密认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-5-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7"><span class="toc-text">2.3.5 获取当前登录用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-6-remember-me-%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-text">2.3.6 remember me 记住我</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-6-1-%E7%AE%80%E5%8D%95%E7%94%9F%E6%88%90Token%E6%96%B9%E6%B3%95"><span class="toc-text">2.3.6.1 简单生成Token方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-6-2-%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84Token%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95"><span class="toc-text">2.3.6.2 持久化的Token生成方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-7-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81%E5%A4%84%E7%90%86"><span class="toc-text">2.3.7 自定义登录状态处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">2.4 图形验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-session%E7%AE%A1%E7%90%86"><span class="toc-text">2.5 session管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-%E4%BC%9A%E8%AF%9D%E8%B6%85%E6%97%B6"><span class="toc-text">2.5.1 会话超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-text">2.5.2 并发控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-3-%E9%9B%86%E7%BE%A4session"><span class="toc-text">2.5.3 集群session</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-csrf%E9%98%B2%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="toc-text">2.6 csrf防护机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-%E4%BB%80%E4%B9%88%E6%98%AFcsrf"><span class="toc-text">2.6.1 什么是csrf?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3-CSRF%E7%9A%84%E9%98%B2%E5%BE%A1%E7%AD%96%E7%95%A5"><span class="toc-text">2.6.3 CSRF的防御策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-4-Security%E4%B8%AD%E7%9A%84csrf%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6"><span class="toc-text">2.6.4 Security中的csrf防御机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E8%B7%A8%E5%9F%9F%E4%B8%8ECORS"><span class="toc-text">2.7 跨域与CORS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-1-%E8%B7%A8%E5%9F%9F"><span class="toc-text">2.7.1 跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-2-%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F"><span class="toc-text">2.7.2 解决跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-3-%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84CORS%E6%94%AF%E6%8C%81"><span class="toc-text">2.7.3 基于SpringSecurity的CORS支持</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81SpringSecurity%E6%8E%88%E6%9D%83"><span class="toc-text">三、SpringSecurity授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%8E%88%E6%9D%83%E7%AE%80%E4%BB%8B"><span class="toc-text">3.1 授权简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-SpringSecurity%E5%AF%B9%E6%8E%88%E6%9D%83%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-text">3.1.1 SpringSecurity对授权的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-Spring-Security%E6%8E%88%E6%9D%83%E5%8E%9F%E7%90%86"><span class="toc-text">3.1.2 Spring Security授权原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-SpringSecurity%E6%8E%88%E6%9D%83"><span class="toc-text">3.2 SpringSecurity授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E5%86%85%E7%BD%AE%E6%9D%83%E9%99%90%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">3.2.1 内置权限表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-URL%E5%AE%89%E5%85%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">3.2.2 URL安全表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E5%9C%A8web%E5%AE%89%E5%85%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%AD%E5%BC%95%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89Bean%E6%8E%88%E6%9D%83"><span class="toc-text">3.2.3 在web安全表达式中引用自定义Bean授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-Method%E5%AE%89%E5%85%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">3.2.4 Method安全表达式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84RBAC%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.3 基于数据库的RBAC数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-RBAC%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B"><span class="toc-text">3.3.1 RBAC权限模型简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-RBAC%E7%9A%84%E6%BC%94%E5%8C%96%E8%BF%9B%E7%A8%8B"><span class="toc-text">3.3.2 RBAC的演化进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E5%9F%BA%E4%BA%8ERBAC%E8%AE%BE%E8%AE%A1%E6%9D%83%E9%99%90%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-text">3.3.3 基于RBAC设计权限表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-%E5%9F%BA%E4%BA%8ESpring-Security%E5%AE%9E%E7%8E%B0RBAC%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-text">3.3.4 基于Spring Security实现RBAC权限管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%9F%BA%E4%BA%8E%E9%A1%B5%E9%9D%A2%E6%A0%87%E7%AD%BE%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-text">3.4 基于页面标签的权限控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E5%B8%B8%E7%94%A8SpringSecurity%E7%9A%84%E6%A0%87%E7%AD%BE%E5%B1%9E%E6%80%A7%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.4.1 常用SpringSecurity的标签属性介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-SpringSecurity%E6%A0%87%E7%AD%BE%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">3.4.2 SpringSecurity标签的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">四、源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%8A%A0%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="toc-text">4.1 过滤器链加载源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">4.1.1 过滤器加载流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">4.1.2 过滤器链加载流程源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81"><span class="toc-text">4.2 认证流程源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">4.2.1 认证流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA"><span class="toc-text">4.2.2 认证流程源码跟踪</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E8%AE%B0%E4%BD%8F%E6%88%91%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81"><span class="toc-text">4.3 记住我流程源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E8%AE%B0%E4%BD%8F%E6%88%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">4.3.1 记住我流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E8%AE%B0%E4%BD%8F%E6%88%91%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA"><span class="toc-text">4.3.2 记住我流程源码跟踪</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-CSRF%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81"><span class="toc-text">4.4 CSRF流程源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">CSRF流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-CSRF%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B%E8%B7%9F%E8%B8%AA"><span class="toc-text">3.4.2 CSRF源码流程跟踪</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81"><span class="toc-text">4.5 授权流程源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-1-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">4.5.1 授权流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-2-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA"><span class="toc-text">4.5.2 授权流程源码跟踪</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 木瓜煲鸡脚</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn"><span>鄂ICP备19025079号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-min.vercel.app',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-min.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>